<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ·±æ¸Šå¡ç‰Œ - è‚‰é¸½å¡ç‰Œæ¸¸æˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- é…ç½®Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6D28D9', // ä¸»è‰²è°ƒï¼šæ·±ç´«è‰²
            secondary: '#EC4899', // è¾…åŠ©è‰²ï¼šç²‰è‰²
            accent: '#F59E0B', // å¼ºè°ƒè‰²ï¼šé‡‘è‰²
            dark: '#1E1B4B', // æ·±è‰²èƒŒæ™¯
            light: '#E0E7FF', // æµ…è‰²æ–‡æœ¬
          },
          fontFamily: {
            game: ['Segoe UI', 'Roboto', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:scale-105 hover:shadow-lg;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .bg-game {
        background-image: radial-gradient(circle at center, #2D1B69 0%, #111827 100%);
      }
      .glow {
        box-shadow: 0 0 15px rgba(110, 40, 217, 0.6);
      }
      .card-upgraded {
        border: 2px solid #F59E0B !important;
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      }
      /* å¥—è£…æ•ˆæœæ ·å¼ */
      .set-bonus-active {
        background-color: rgba(250, 204, 21, 0.2);
        border-color: rgb(250, 204, 21);
        box-shadow: 0 0 10px rgba(250, 204, 21, 0.3);
      }
      .set-bonus-inactive {
        opacity: 0.5;
      }
      .set-bonus-item {
        margin-bottom: 5px;
        padding: 5px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(250, 204, 21, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(250, 204, 21, 0);
      }
    }
  </style>
</head>
<body class="bg-game font-game text-light min-h-screen flex flex-col overflow-x-hidden">
  <!-- å›ºå®šé¡¶éƒ¨çš„çŠ¶æ€é¢æ¿ - åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå§‹ç»ˆå¯è§ -->
  <div class="fixed top-0 left-0 right-0 z-40 bg-dark/80 backdrop-blur-md border-b border-primary/30 md:hidden">
    <div class="container mx-auto px-3 py-2">
      <!-- ç©å®¶çŠ¶æ€ - ç²¾ç®€ç‰ˆ -->
      <div class="flex justify-between items-center mb-1">
        <div class="flex items-center">
          <i class="fa fa-user-circle mr-1 text-secondary text-sm"></i>
          <span class="text-xs bg-primary/20 px-1.5 py-0.5 rounded-full">Lv <span id="player-level-mobile">1</span></span>
        </div>
        <div class="text-xs">
          <span id="player-hp-mobile">100</span>/<span id="player-max-hp-mobile">100</span>
        </div>
      </div>
      <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden mb-2">
        <div id="player-hp-bar-mobile" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 100%"></div>
      </div>
      
      <!-- æ•ŒäººçŠ¶æ€ - ç²¾ç®€ç‰ˆ -->
      <div class="flex justify-between items-center mb-1">
        <div class="flex items-center">
          <i class="fa fa-skull mr-1 text-red-500 text-sm"></i>
          <span id="enemy-name-mobile" class="text-sm truncate max-w-[120px]">åˆçº§é­”ç‰©</span>
        </div>
        <div class="text-xs">
          <span id="enemy-hp-mobile">50</span>/<span id="enemy-max-hp-mobile">50</span>
        </div>
      </div>
      <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
        <div id="enemy-hp-bar-mobile" class="h-full bg-red-500 rounded-full transition-all duration-500" style="width: 100%"></div>
      </div>
    </div>
  </div>
  
  <!-- æ¸¸æˆå®¹å™¨ - ç§»åŠ¨ç«¯æ·»åŠ é¡¶éƒ¨ padding é¿å…è¢«å›ºå®šé¢æ¿é®æŒ¡ -->
  <div id="game-container" class="container mx-auto px-4 pt-24 pb-6 md:pt-6 flex-grow flex flex-col">
    
    <!-- æ¸¸æˆæ ‡é¢˜ - ç§»åŠ¨ç«¯ç¼©å° -->
    <header class="text-center mb-4 md:mb-6">
      <div class="flex justify-center gap-2 mb-4">
        <button onclick="saveGame()" class="bg-primary/30 hover:bg-primary/50 px-3 py-1 rounded text-sm">
          <i class="fa fa-save mr-1"></i>ä¿å­˜
        </button>
        <button onclick="loadGame()" class="bg-secondary/30 hover:bg-secondary/50 px-3 py-1 rounded text-sm">
          <i class="fa fa-load mr-1"></i>åŠ è½½
        </button>
      </div>
      <!-- <h1 class="text-[clamp(1.5rem,5vw,3rem)] font-bold text-accent text-shadow mb-1">æ·±æ¸Šå¡ç‰Œ</h1>
      <p class="text-light/70 text-sm md:text-base">æ— é™æŒ‘æˆ˜ Â· æ¯ä¸€æ¬¡éƒ½æ˜¯æ–°çš„å†’é™©</p> -->
    </header>
    
    <!-- çŠ¶æ€é¢æ¿ - ä»…åœ¨æ¡Œé¢æ˜¾ç¤º -->
    <div class="hidden md:grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <!-- ç©å®¶çŠ¶æ€ -->
      <div class="bg-dark/50 rounded-xl p-4 border border-primary/30 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold flex items-center">
            <i class="fa fa-user-circle mr-2 text-secondary"></i>ç©å®¶
          </h2>
          <span class="bg-primary/20 px-2 py-1 rounded-full text-sm">ç­‰çº§ <span id="player-level">1</span></span>
        </div>
        
        <div class="flex gap-4">
          <div class="flex-1">
            <div class="text-sm text-light/70 mb-1">ç”Ÿå‘½å€¼</div>
            <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
              <div id="player-hp-bar" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 100%"></div>
            </div>
            <div class="text-right mt-1 text-sm">
              <span id="player-hp">100</span> / <span id="player-max-hp">100</span>
            </div>
          </div>
          
          <div class="flex-1">
            <div class="text-sm text-light/70 mb-1">ç»éªŒå€¼</div>
            <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
              <div id="player-exp-bar" class="h-full bg-accent rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="text-right mt-1 text-sm">
              <span id="player-exp">0</span> / <span id="player-next-level">100</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ•ŒäººçŠ¶æ€ -->
      <div class="bg-dark/50 rounded-xl p-4 border border-primary/30 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold flex items-center">
            <i class="fa fa-skull mr-2 text-red-500"></i><span id="enemy-name">åˆçº§é­”ç‰©</span>
          </h2>
          <span class="bg-red-500/20 px-2 py-1 rounded-full text-sm">å¨èƒåº¦ <span id="enemy-threat">ä½</span></span>
        </div>
        
        <div>
          <div class="text-sm text-light/70 mb-1">ç”Ÿå‘½å€¼</div>
          <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
            <div id="enemy-hp-bar" class="h-full bg-red-500 rounded-full transition-all duration-500" style="width: 100%"></div>
          </div>
          <div class="text-right mt-1 text-sm">
            <span id="enemy-hp">50</span> / <span id="enemy-max-hp">50</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- è£…å¤‡é¢æ¿ - ç§»åŠ¨ç«¯ç¼©å° -->
    <div class="mb-4 md:mb-6">
      <h2 class="text-lg md:text-xl font-bold mb-2 md:mb-3 flex items-center">
        <i class="fa fa-shield mr-2 text-accent"></i>è£…å¤‡
      </h2>
      <div id="equipment-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
        <!-- æ­¦å™¨ -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1">æ­¦å™¨</div>
          <div id="weapon-slot" class="text-xs md:text-sm">æ— </div>
        </div>
        <!--  armor -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1"> armor</div>
          <div id="armor-slot" class="text-xs md:text-sm">æ— </div>
        </div>
        <!-- é¥°å“ -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1">é¥°å“</div>
          <div id="trinket-slot" class="text-xs md:text-sm">æ— </div>
        </div>
        <!-- æˆ’æŒ‡ -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1">æˆ’æŒ‡</div>
          <div id="ring-slot" class="text-xs md:text-sm">æ— </div>
        </div>
      </div>
      
      <!-- å¥—è£…æ•ˆæœæ˜¾ç¤ºåŒºåŸŸ -->
      <div id="set-effects-container" class="mt-3">
        <div class="text-xs text-light/50 italic">è£…å¤‡ç›¸åŒå¥—è£…çš„è£…å¤‡å¯è·å¾—é¢å¤–åŠ æˆ</div>
      </div>
    </div>
    
    <!-- æˆ˜æ–—åŒºåŸŸ - å‹ç¼©é«˜åº¦é€‚åº”ç§»åŠ¨è®¾å¤‡ -->
    <div class="flex-grow mb-4 md:mb-6 relative">
      <div id="battle-area" class="bg-dark/30 rounded-xl p-3 md:p-4 h-full min-h-[140px] md:min-h-[200px] flex flex-col items-center justify-center border border-primary/20">
        <div id="battle-message" class="text-center mb-3 md:mb-6 text-sm md:text-lg text-light/90"></div>
        
        <!-- è§’è‰²å½¢è±¡ - ç¼©å°ç§»åŠ¨ç‰ˆå°ºå¯¸ -->
        <div class="flex justify-around items-center w-full max-w-md mb-3 md:mb-6">
          <div class="text-center animate-float">
            <div class="w-16 h-16 md:w-20 md:h-20 bg-secondary/20 rounded-full flex items-center justify-center mb-1 md:mb-2 border-2 border-secondary">
              <i class="fa fa-user text-3xl md:text-4xl text-secondary"></i>
            </div>
            <div class="text-xs md:text-sm font-medium">ç©å®¶</div>
          </div>
          
          <div class="text-xl md:text-2xl">
            <i class="fa fa-exchange text-accent/70"></i>
          </div>
          
          <div class="text-center animate-float" style="animation-delay: 0.5s">
            <div id="enemy-sprite" class="w-16 h-16 md:w-20 md:h-20 bg-red-500/20 rounded-full flex items-center justify-center mb-1 md:mb-2 border-2 border-red-500">
              <i class="fa fa-asterisk text-3xl md:text-4xl text-red-500"></i>
            </div>
            <div class="text-xs md:text-sm font-medium" id="enemy-display-name">åˆçº§é­”ç‰©</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å¡ç‰ŒåŒºåŸŸ - æ”¹ä¸ºæ°´å¹³æ»šåŠ¨ï¼Œæ–¹ä¾¿æ‰‹æœºæ“ä½œ -->
    <div class="mb-4 md:mb-6">
      <h2 class="text-lg md:text-xl font-bold mb-2 md:mb-3 flex items-center">
        <i class="fa fa-th-large mr-2 text-accent"></i>ä½ çš„å¡ç‰Œ
      </h2>
      <div class="relative">
        <div id="card-container" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide md:grid md:grid-cols-2 md:md:grid-cols-3 md:gap-4">
          <!-- å¡ç‰Œå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <!-- æ»šåŠ¨æŒ‡ç¤ºå™¨ -->
        <div class="hidden md:flex absolute -bottom-1 left-0 right-0 justify-center gap-1">
          <span class="w-2 h-2 rounded-full bg-primary/30"></span>
          <span class="w-2 h-2 rounded-full bg-primary/30"></span>
          <span class="w-2 h-2 rounded-full bg-primary/30"></span>
        </div>
      </div>
    </div>
    
    <!-- å¡ç‰Œåˆæˆæç¤º - æ–°å¢åŠŸèƒ½ -->
    <div id="card-fusion-hint" class="mb-4 bg-primary/20 border border-primary/40 rounded-lg p-3 hidden">
      <div class="flex items-start">
        <i class="fa fa-lightbulb-o text-accent mt-0.5 mr-2"></i>
        <div>
          <h3 class="font-bold text-sm">å¡ç‰Œåˆæˆ</h3>
          <p class="text-xs text-light/80">é›†é½3å¼ ç›¸åŒå¡ç‰Œå¯è‡ªåŠ¨åˆæˆæ›´é«˜çº§çš„å¡ç‰Œ</p>
        </div>
      </div>
    </div>
    
    <!-- æŠ€èƒ½åˆ—è¡¨ - ç§»åŠ¨ç«¯æ”¹ä¸ºå¯æ»šåŠ¨ -->
    <div class="mb-4 md:mb-6">
      <h2 class="text-lg md:text-xl font-bold mb-2 md:mb-3 flex items-center">
        <i class="fa fa-star mr-2 text-secondary"></i>å·²å­¦æŠ€èƒ½
      </h2>
      <div id="skills-container" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto scrollbar-hide pb-2">
        <div class="bg-gray-700/30 px-3 py-1 rounded-full text-sm">
          åˆå§‹æŠ€èƒ½: åŸºç¡€æ”»å‡»
        </div>
      </div>
    </div>
  </div>
  
  <!-- å‡çº§é€‰æ‹©æ¨¡æ€æ¡† - ä¼˜åŒ–ç§»åŠ¨ç«¯å°ºå¯¸ -->
  <div id="level-up-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-5 max-w-md w-full mx-4">
      <h2 class="text-xl md:text-2xl font-bold text-accent text-center mb-3 md:mb-4">å‡çº§äº†ï¼</h2>
      <p class="text-center mb-4 md:mb-6 text-sm md:text-base">é€‰æ‹©ä¸€é¡¹æŠ€èƒ½æå‡ï¼š</p>
      
      <div class="grid grid-cols-1 gap-3 md:gap-4">
        <div id="skill-option-1" class="skill-option bg-primary/20 hover:bg-primary/40 p-3 md:p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-1 md:mb-2">æŠ€èƒ½åç§°</h3>
          <p class="text-xs md:text-sm text-light/80">æŠ€èƒ½æè¿°</p>
        </div>
        
        <div id="skill-option-2" class="skill-option bg-primary/20 hover:bg-primary/40 p-3 md:p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-1 md:mb-2">æŠ€èƒ½åç§°</h3>
          <p class="text-xs md:text-sm text-light/80">æŠ€èƒ½æè¿°</p>
        </div>
        
        <div id="skill-option-3" class="skill-option bg-primary/20 hover:bg-primary/40 p-3 md:p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-1 md:mb-2">æŠ€èƒ½åç§°</h3>
          <p class="text-xs md:text-sm text-light/80">æŠ€èƒ½æè¿°</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å‰§æƒ…å™äº‹æ¨¡æ€æ¡† -->
  <div id="story-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-5 max-w-md w-full mx-4">
      <div class="flex items-center justify-center mb-4">
        <i class="fa fa-book text-3xl text-accent mr-3"></i>
        <h2 class="text-xl md:text-2xl font-bold text-accent">å†’é™©æ—¥å¿—</h2>
      </div>
      <div id="story-content" class="text-center mb-6 leading-relaxed text-light/90">
        <!-- å‰§æƒ…å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <button id="story-continue" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover w-full">
        ç»§ç»­å†’é™©
      </button>
    </div>
  </div>
  
  <!-- å¤§ç»“å±€æ¨¡æ€æ¡† -->
  <div id="ending-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-yellow-500 rounded-xl p-5 max-w-md w-full mx-4 text-center">
      <div class="mb-4">
        <i class="fa fa-trophy text-4xl text-yellow-500"></i>
      </div>
      <h2 class="text-2xl md:text-3xl font-bold text-yellow-500 mb-4">ğŸ‰ å†’é™©å®Œæˆï¼</h2>
      <div id="ending-content" class="mb-6 leading-relaxed text-light/90">
        <!-- å¤§ç»“å±€å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <button id="restart-after-ending" class="bg-yellow-500 hover:bg-yellow-400 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover w-full">
        é‡æ–°å¼€å§‹å†’é™©
      </button>
    </div>
  </div>
  
  <!-- å¡ç‰Œå‡çº§æç¤º - ä¸‰åˆä¸€åŠŸèƒ½ -->
  <div id="card-upgrade-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-5 max-w-md w-full mx-4 text-center">
      <div class="w-12 h-12 bg-accent/20 rounded-full flex items-center justify-center mx-auto mb-3">
        <i class="fa fa-arrow-circle-up text-2xl text-accent"></i>
      </div>
      <h2 class="text-xl md:text-2xl font-bold text-accent mb-3">å¡ç‰Œå‡çº§ï¼</h2>
      <div class="mb-5">
        <p class="text-sm">3å¼ <span id="upgrade-from" class="text-blue-400 font-bold"></span>å·²åˆæˆä¸º</p>
        <p class="mt-2 text-base md:text-xl"><span id="upgrade-to" class="text-yellow-400 font-bold card-upgraded px-2 py-1 rounded"></span></p>
      </div>
      <button id="upgrade-confirm" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover w-full">
        ç¡®è®¤
      </button>
    </div>
  </div>
  
  <!-- è£…å¤‡æ‰è½æ¨¡æ€æ¡† -->
  <div id="loot-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-5 max-w-md w-full mx-4">
      <h2 class="text-xl md:text-2xl font-bold text-accent text-center mb-3 md:mb-4">è·å¾—æˆ˜åˆ©å“ï¼</h2>
      <div id="loot-content" class="mb-4 md:mb-6">
        <!-- æˆ˜åˆ©å“å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="flex gap-2">
        <button id="equip-button" class="flex-1 bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover">
          è£…å¤‡ç‰©å“
        </button>
        <button id="discard-button" class="flex-1 bg-purple-700 hover:bg-purple-600 text-light font-bold py-2 px-6 rounded-full transition-all card-hover"> 
           å¼ºåŒ– 
         </button>
      </div>
    </div>
  </div>
  
  <!-- æ¸¸æˆç»“æŸæ¨¡æ€æ¡† -->
  <div id="game-over-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-red-500 rounded-xl p-5 max-w-md w-full mx-4 text-center">
      <h2 class="text-xl md:text-2xl font-bold text-red-500 mb-3 md:mb-4">æ¸¸æˆç»“æŸ</h2>
      <p class="mb-2 text-sm md:text-base">ä½ çš„å†’é™©ç»“æŸäº†</p>
      <p class="text-lg md:text-xl font-bold mb-5 md:mb-6">æœ€ç»ˆç­‰çº§: <span id="final-level">1</span></p>
      <button id="restart-button" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover w-full">
        é‡æ–°å¼€å§‹
      </button>
    </div>
  </div>
  
  <script>
    // å‰§æƒ…æ•°æ®åº“ - å‹‡è€…æ•‘å…¬ä¸»çš„ç‹é“å‰§æƒ…ï¼ˆ20çº§ï¼‰
    const storyDatabase = {
      1: {
        title: "å†’é™©çš„å¼€å§‹",
        content: "ä½œä¸ºæ‘é‡Œæœ€å‹‡æ•¢çš„å¹´è½»äººï¼Œä½ æ¥åˆ°äº†ä¸€ä¸ªç´§æ€¥ä»»åŠ¡ã€‚ç‹å›½çš„å…¬ä¸»è¢«é‚ªæ¶çš„é»‘é¾™ç»‘æ¶äº†ï¼Œå›½ç‹è®¸è¯ºå°†æŠŠå…¬ä¸»è®¸é…ç»™èƒ½æ•‘å›å¥¹çš„å‹‡è€…ã€‚ä½ æ”¶æ‹¾è¡Œå›Šï¼Œè¸ä¸Šäº†è¿™æ®µå……æ»¡æœªçŸ¥çš„æ—…ç¨‹..."
      },
      2: {
        title: "é¦–ä¸ªè¯•ç‚¼",
        content: "ä½ æ¥åˆ°äº†ç‹å›½è¾¹å¢ƒçš„æ£®æ—ã€‚æ£®æ—é‡Œçš„é‡å…½å¯¹ä½ æ¥è¯´æ˜¯ç¬¬ä¸€ä¸ªæŒ‘æˆ˜ï¼Œä½†ä½ å‡­å€Ÿç€å‹‡æ°”å’ŒåŸºç¡€çš„æˆ˜æ–—æŠ€å·§æˆåŠŸé€šè¿‡ï¼Œè¯æ˜äº†è‡ªå·±çš„å®åŠ›ã€‚"
      },
      3: {
        title: "é‡åˆ°å¯¼å¸ˆ",
        content: "åœ¨æ£®æ—æ·±å¤„ï¼Œä½ é‡åˆ°äº†ä¸€ä½éšå±…çš„è€æˆ˜å£«ã€‚ä»–çœ‹å‡ºäº†ä½ çš„æ½œåŠ›ï¼Œä¼ æˆäº†ä½ ä¸€äº›åŸºæœ¬çš„æˆ˜æ–—æŠ€å·§ï¼Œä½¿ä½ çš„å®åŠ›å¾—åˆ°äº†æå‡ã€‚"
      },
      4: {
        title: "ç¥ç§˜æ´ç©´",
        content: "ç¦»å¼€æ£®æ—åï¼Œä½ æ¥åˆ°äº†ä¸€åº§ç¥ç§˜çš„æ´ç©´ã€‚æ®è¯´è¿™é‡Œè—ç€å¤ä»£æˆ˜å£«ç•™ä¸‹çš„å®è—ï¼Œä½†ä¹Ÿæœ‰å±é™©çš„ç”Ÿç‰©å®ˆæŠ¤ç€å®ƒä»¬ã€‚"
      },
      5: {
        title: "è·å¾—è£…å¤‡",
        content: "åœ¨æ´ç©´ä¸­ï¼Œä½ å‘ç°äº†ä¸€å¥—å¤è€çš„ç›”ç”²å’Œæ­¦å™¨ã€‚è¿™äº›è£…å¤‡è™½ç„¶æœ‰äº›é™ˆæ—§ï¼Œä½†ä¾ç„¶åšå›ºè€ç”¨ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°åº”å¯¹æœªæ¥çš„æŒ‘æˆ˜ã€‚"
      },
      6: {
        title: "ç©¿è¶Šå±±è„‰",
        content: "ç¿»è¿‡é™©å³»çš„å±±è„‰ï¼Œä½ çœ‹åˆ°äº†é»‘é¾™æ‰€åœ¨çš„æ–¹å‘ã€‚è·¯é€”è¶Šæ¥è¶Šè‰°éš¾ï¼Œä½†ä½ çš„å†³å¿ƒä¹Ÿè¶Šæ¥è¶Šåšå®šã€‚"
      },
      7: {
        title: "ç¬¬ä¸€ä¸ªBOSS",
        content: "åœ¨å±±è·¯çš„é¡¶ç«¯ï¼Œä½ é‡åˆ°äº†ä¸€åªå·¨å¤§çš„å±±æ€ªã€‚è¿™æ˜¯ä½ è¿„ä»Šä¸ºæ­¢é‡åˆ°çš„æœ€å¼ºå¤§çš„æ•Œäººï¼Œä½†ä½ å‡­å€Ÿå­¦åˆ°çš„æŠ€å·§å’Œè£…å¤‡çš„åŠ›é‡ï¼ŒæˆåŠŸå‡»è´¥äº†å®ƒï¼"
      },
      8: {
        title: "æ¥åˆ°æ¹–ç•”",
        content: "è¶Šè¿‡å±±è„‰åï¼Œä½ æ¥åˆ°äº†ä¸€ç‰‡å®é™çš„æ¹–æ³Šã€‚æ¹–é¢ä¸Šæ³¢å…‰ç²¼ç²¼ï¼Œä¼¼ä¹éšè—ç€ä»€ä¹ˆç§˜å¯†ã€‚æ¹–è¾¹çš„æ‘æ°‘å‘Šè¯‰ä½ ï¼Œæ¹–åº•å¯èƒ½æœ‰é€šå¾€é»‘é¾™å·¢ç©´çš„ç§˜å¯†é€šé“ã€‚"
      },
      9: {
        title: "æ¹–ä¸­è¯•ç‚¼",
        content: "ä½ æ½œå…¥æ¹–ä¸­æ¢ç´¢ï¼Œå‘ç°äº†ä¸€ä¸ªå¤è€çš„æ°´ä¸‹ç¥æ®¿ã€‚åœ¨è¿™é‡Œï¼Œä½ æ¥å—äº†æ°´å…ƒç´ çš„è¯•ç‚¼ï¼Œè·å¾—äº†æ–°çš„åŠ›é‡ã€‚"
      },
      10: {
        title: "æ²™æ¼ ä¹‹æ—…",
        content: "ç¦»å¼€æ¹–ç•”åï¼Œä½ è¿›å…¥äº†ä¸€ç‰‡å¹¿é˜”çš„æ²™æ¼ ã€‚çƒˆæ—¥ç‚ç‚ï¼Œä½†ä½ æ²¡æœ‰é€€ç¼©ï¼Œç»§ç»­å‘é»‘é¾™çš„å·¢ç©´å‰è¿›ã€‚"
      },
      11: {
        title: "æ²™æ¼ ç»¿æ´²",
        content: "åœ¨æ²™æ¼ ä¸­ï¼Œä½ å‘ç°äº†ä¸€ç‰‡ç»¿æ´²ã€‚åœ¨è¿™é‡Œä¼‘æ¯æ—¶ï¼Œä½ é‡åˆ°äº†ä¸€ä½å•†é˜Ÿçš„å‘å¯¼ï¼Œä»–å‘Šè¯‰äº†ä½ ä¸€äº›å…³äºé»‘é¾™çš„æƒ…æŠ¥ã€‚"
      },
      12: {
        title: "é­é‡å¼ºç›—",
        content: "ç»§ç»­å‰è¿›çš„è·¯ä¸Šï¼Œä½ é­é‡äº†ä¸€ç¾¤æ²™æ¼ å¼ºç›—ã€‚ä»–ä»¬è§Šè§ä½ çš„è£…å¤‡ï¼Œä½†ä½ è½»æ¾å‡»è´¥äº†ä»–ä»¬ï¼Œå±•ç¤ºäº†è‡ªå·±æ—¥ç›Šå¢é•¿çš„å®åŠ›ã€‚"
      },
      13: {
        title: "ç«å±±åœ°å¸¦",
        content: "ç©¿è¿‡æ²™æ¼ ï¼Œä½ æ¥åˆ°äº†ç«å±±åœ°å¸¦ã€‚è¿™é‡Œæ˜¯é»‘é¾™å·¢ç©´çš„æ‰€åœ¨åœ°ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€ç¡«ç£ºçš„å‘³é“ï¼Œåœ°é¢æ»šçƒ«ã€‚"
      },
      14: {
        title: "ç†”å²©è¯•ç‚¼",
        content: "åœ¨ç«å±±å£é™„è¿‘ï¼Œä½ é‡åˆ°äº†ä¸€åªç«å…ƒç´ å®ˆå«ã€‚å®ƒæµ‹è¯•äº†ä½ çš„å‹‡æ°”å’Œå®åŠ›ï¼Œåœ¨ç¡®è®¤ä½ è¶³å¤Ÿå¼ºå¤§åï¼Œä¸ºä½ æŒ‡å¼•äº†é€šå¾€é»‘é¾™å·¢ç©´çš„æ­£ç¡®é“è·¯ã€‚"
      },
      15: {
        title: "å·¢ç©´å…¥å£",
        content: "ç»ˆäºï¼Œä½ æ¥åˆ°äº†é»‘é¾™å·¢ç©´çš„å…¥å£ã€‚æ´ç©´æ·±é‚ƒé»‘æš—ï¼Œä½†ä½ èƒ½æ„Ÿå—åˆ°é‡Œé¢ä¼ æ¥çš„å¼ºå¤§æ°”æ¯ã€‚è¿™æ˜¯æœ€åçš„æŒ‘æˆ˜ï¼Œä½ æ·±å¸ä¸€å£æ°”ï¼Œèµ°äº†è¿›å»ã€‚"
      },
      16: {
        title: "å†…éƒ¨é™·é˜±",
        content: "å·¢ç©´å†…éƒ¨å¸ƒæ»¡äº†å„ç§é™·é˜±å’Œå®ˆå«ã€‚ä½†ç»è¿‡é‡é‡è€ƒéªŒçš„ä½ å·²ç»ä»Šéæ˜”æ¯”ï¼Œè½»æ¾åŒ–è§£äº†è¿™äº›å±é™©ã€‚"
      },
      17: {
        title: "æ¥è¿‘å…¬ä¸»",
        content: "æ·±å…¥å·¢ç©´åï¼Œä½ ç»ˆäºå¬åˆ°äº†å…¬ä¸»çš„å‘¼æ•‘å£°ã€‚å¥¹è¢«å›šç¦åœ¨å·¢ç©´æ·±å¤„çš„ä¸€ä¸ªåä¸½æˆ¿é—´é‡Œï¼Œé»‘é¾™å°±åœ¨é™„è¿‘å®ˆæŠ¤ç€å¥¹ã€‚"
      },
      18: {
        title: "æœ€åçš„å‡†å¤‡",
        content: "åœ¨ä¸é»‘é¾™å†³æˆ˜å‰ï¼Œä½ æ•´ç†äº†è‡ªå·±çš„è£…å¤‡å’ŒçŠ¶æ€ï¼Œå›æƒ³èµ·è¿™æ®µæ—…ç¨‹ä¸­çš„ç‚¹ç‚¹æ»´æ»´ã€‚ä½ å·²ç»ä»ä¸€ä¸ªæ™®é€šçš„å¹´è½»äººæˆé•¿ä¸ºçœŸæ­£çš„å‹‡è€…ï¼Œç°åœ¨æ˜¯æ—¶å€™è¯æ˜è¿™ä¸€ç‚¹äº†ã€‚"
      },
      19: {
        title: "å†³æˆ˜å‰å¤•",
        content: "ä½ ç«™åœ¨é»‘é¾™çš„é¢å‰ã€‚è¿™åªå·¨å¤§çš„é»‘è‰²å·¨é¾™æ•£å‘ç€ä»¤äººææƒ§çš„æ°”æ¯ï¼Œä½†ä½ æ¯«ä¸ç•æƒ§ã€‚å…¬ä¸»çš„å‘½è¿å’Œç‹å›½çš„å’Œå¹³éƒ½æŒæ¡åœ¨ä½ çš„æ‰‹ä¸­ï¼Œä½ å¿…é¡»èƒœåˆ©ï¼"
      },
      20: {
        title: "æœ€ç»ˆèƒœåˆ©",
        content: "ç»è¿‡ä¸€åœºæƒŠå¿ƒåŠ¨é­„çš„æˆ˜æ–—ï¼Œä½ ç»ˆäºå‡»è´¥äº†é‚ªæ¶çš„é»‘é¾™ï¼å…¬ä¸»å¾—æ•‘äº†ï¼Œä½ æˆåŠŸå®Œæˆäº†ä½¿å‘½ã€‚å½“ä½ å¸¦ç€å…¬ä¸»è¿”å›ç‹å›½æ—¶ï¼Œå…¨åŸçš„äººæ°‘éƒ½ä¸ºä½ æ¬¢å‘¼å–å½©ï¼Œå›½ç‹å…‘ç°äº†ä»–çš„æ‰¿è¯º..."
      }
    };
    
    // æ¸¸æˆçŠ¶æ€
    const gameState = {
      player: {
        level: 1,
        hp: 100,
        maxHp: 100,
        exp: 0,
        nextLevelExp: 100,
        attack: 10,
        defense: 0,
        critChance: 5, // ç™¾åˆ†æ¯”
        cards: [],
        cardCounts: {}, // ç”¨äºè·Ÿè¸ªå„ç±»å¡ç‰Œæ•°é‡ï¼Œå®ç°å‡çº§
        skills: [
          { id: 'basic_attack', name: 'åŸºç¡€æ”»å‡»', description: 'é€ æˆ10ç‚¹ä¼¤å®³' }
        ],
        equipment: {
          weapon: null,
          armor: null,
          trinket: null,
          ring: null
        }
      },
      enemy: {
        name: 'åˆçº§é­”ç‰©',
        displayName: 'åˆçº§é­”ç‰©',
        hp: 50,
        maxHp: 50,
        attack: 8,
        threat: 'ä½',
        expReward: 50,
        sprite: 'fa-asterisk',
        lootChance: 30 // æ‰è½æ¦‚ç‡ç™¾åˆ†æ¯”
      },
      isPlayerTurn: true,
      isBattleActive: true,
      difficulty: 1,
      currentLoot: null,
      // å¡ç‰Œä¸‰åˆä¸€ç›¸å…³é…ç½®
      cardFusion: {
        required: 3, // éœ€è¦3å¼ ç›¸åŒå¡ç‰Œæ‰èƒ½åˆæˆ
        shownHint: false // æ˜¯å¦å·²æ˜¾ç¤ºåˆæˆæç¤º
      }
    };
    // å­˜æ¡£åŠŸèƒ½
    function saveGame() {
      try {
        localStorage.setItem('abyssCardsSave', JSON.stringify(gameState));
        showToast('æ¸¸æˆå·²ä¿å­˜');
      } catch (e) {
        showToast('ä¿å­˜å¤±è´¥');
      }
    }

    function loadGame() {
      const saved = localStorage.getItem('abyssCardsSave');
      if (saved) {
        const parsed = JSON.parse(saved);
        Object.assign(gameState, parsed);
        renderGame();
        showToast('å·²åŠ è½½å­˜æ¡£');
        return true;
      }
      showToast('æ— å­˜æ¡£æ•°æ®');
      return false;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-dark/80 text-light px-4 py-2 rounded-full backdrop-blur-sm z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    // æ‰©å±•å¡ç‰Œæ•°æ®åº“ - æ–°å¢å¤šç§ç±»å‹å¡ç‰Œ
    const cardDatabase = [
      // åŸºç¡€æ”»å‡»ç±»
      {
        id: 'basic_attack',
        name: 'åŸºç¡€æ”»å‡»',
        description: 'å¯¹æ•Œäººé€ æˆåŸºç¡€ä¼¤å®³',
        color: 'bg-secondary/20',
        borderColor: 'border-secondary',
        icon: 'fa-hand-paper-o',
        damageMultiplier: 1,
        type: 'attack',
        upgradeTo: 'power_attack' // åŸºç¡€æ”»å‡»å¯å‡çº§ä¸ºå¼ºåŠ›æ”»å‡»
      },
      {
        id: 'power_attack',
        name: 'å¼ºåŠ›æ”»å‡»',
        description: 'å¯¹æ•Œäººé€ æˆ1.5å€åŸºç¡€ä¼¤å®³',
        color: 'bg-accent/20',
        borderColor: 'border-accent',
        icon: 'fa-hand-rock-o',
        damageMultiplier: 1.5,
        type: 'attack',
        upgradeTo: 'devastating_attack'
      },
      {
        id: 'piercing_attack',
        name: 'ç©¿åˆºæ”»å‡»',
        description: 'æ— è§†æ•Œäºº2ç‚¹é˜²å¾¡ï¼Œé€ æˆåŸºç¡€ä¼¤å®³',
        color: 'bg-indigo-500/20',
        borderColor: 'border-indigo-500',
        icon: 'fa-arrow-right',
        damageMultiplier: 1,
        ignoreDefense: 2,
        type: 'attack',
        upgradeTo: 'armor_break_attack'
      },
      {
        id: 'combo_attack',
        name: 'è¿å‡»',
        description: 'è¿ç»­æ”»å‡»ä¸¤æ¬¡ï¼Œæ¯æ¬¡é€ æˆ60%ä¼¤å®³',
        color: 'bg-rose-500/20',
        borderColor: 'border-rose-500',
        icon: 'fa-repeat',
        damageMultiplier: 0.6,
        hitCount: 2,
        type: 'attack',
        upgradeTo: 'triple_attack'
      },
      {
        id: 'backstab',
        name: 'èƒŒåˆº',
        description: 'è‹¥æ•Œäººç”Ÿå‘½å€¼é«˜äº70%ï¼Œé€ æˆ2å€ä¼¤å®³',
        color: 'bg-emerald-500/20',
        borderColor: 'border-emerald-500',
        icon: 'fa-street-view',
        damageMultiplier: 2,
        condition: 'high_hp',
        type: 'attack',
        upgradeTo: 'assassinate'
      },
      
      // // é˜²å¾¡ç±»
      // {
      //   id: 'defend',
      //   name: 'é˜²å¾¡',
      //   description: 'æœ¬å›åˆå‡å°‘50%å—åˆ°çš„ä¼¤å®³',
      //   color: 'bg-blue-500/20',
      //   borderColor: 'border-blue-500',
      //   icon: 'fa-shield',
      //   defend: 0.5,
      //   type: 'defense',
      //   upgradeTo: 'fortify'
      // },
      {
        id: 'parry',
        name: 'æ ¼æŒ¡',
        description: 'æœ‰30%å‡ ç‡å®Œå…¨æ ¼æŒ¡ä¸€æ¬¡æ”»å‡»',
        color: 'bg-cyan-500/20',
        borderColor: 'border-cyan-500',
        icon: 'fa-ban',
        parryChance: 30,
        type: 'defense',
        upgradeTo: 'perfect_parry'
      },
      {
        id: 'dodge',
        name: 'é—ªé¿',
        description: 'æœ¬å›åˆæœ‰40%å‡ ç‡é—ªé¿æ”»å‡»',
        color: 'bg-teal-500/20',
        borderColor: 'border-teal-500',
        icon: 'fa-bolt',
        dodgeChance: 40,
        type: 'defense',
        upgradeTo: 'blink'
      },
      
      // ç‰¹æ®Šæ•ˆæœç±»
      {
        id: 'sacrifice_attack',
        name: 'çŒ®ç¥­æ”»å‡»',
        description: 'æ¶ˆè€—10ç‚¹ç”Ÿå‘½ï¼Œé€ æˆ2å€ä¼¤å®³',
        color: 'bg-red-600/20',
        borderColor: 'border-red-600',
        icon: 'fa-balance-scale',
        damageMultiplier: 2,
        healthCost: 10,
        type: 'special',
        upgradeTo: 'life_steal_attack'
      },
      {
        id: 'fireball',
        name: 'ç«çƒæœ¯',
        description: 'é€ æˆ15ç‚¹ç«ç„°ä¼¤å®³ï¼Œæœ‰20%å‡ ç‡ç¼çƒ§æ•Œäºº',
        color: 'bg-orange-500/20',
        borderColor: 'border-orange-500',
        icon: 'fa-fire',
        damage: 15,
        burnChance: 20,
        type: 'magic',
        upgradeTo: 'flame_strike'
      },
      {
        id: 'frost_bolt',
        name: 'å¯’å†°ç®­',
        description: 'é€ æˆ12ç‚¹ä¼¤å®³ï¼Œæœ‰30%å‡ ç‡å‡ç¼“æ•Œäºº',
        color: 'bg-sky-500/20',
        borderColor: 'border-sky-500',
        icon: 'fa-snowflake-o',
        damage: 12,
        slowChance: 30,
        type: 'magic',
        upgradeTo: 'ice_lance'
      },
      {
        id: 'heal',
        name: 'æ²»æ„ˆ',
        description: 'æ¢å¤20ç‚¹ç”Ÿå‘½å€¼',
        color: 'bg-green-500/20',
        borderColor: 'border-green-500',
        icon: 'fa-heart',
        heal: 20,
        type: 'support',
        upgradeTo: 'greater_heal'
      },
      {
        id: 'poison_sting',
        name: 'æ¯’åˆº',
        description: 'ä½¿æ•Œäººä¸­æ¯’ï¼Œæ¯å›åˆå—åˆ°5ç‚¹ä¼¤å®³ï¼ŒæŒç»­3å›åˆ',
        color: 'bg-green-600/20',
        borderColor: 'border-green-600',
        icon: 'fa-bug',
        applyPoison: 5,
        poisonDuration: 3,
        type: 'dot',
        upgradeTo: 'deadly_poison'
      },
      {
        id: 'whirlwind',
        name: 'æ—‹é£æ–©',
        description: 'å¯¹æ•Œäººé€ æˆä¸¤æ¬¡50%ä¼¤å®³',
        color: 'bg-blue-500/20',
        borderColor: 'border-blue-500',
        icon: 'fa-sync',
        damageMultiplier: 0.5,
        hitCount: 2,
        type: 'attack',
        upgradeTo: 'tornado'
      },
      
      // å‡çº§åçš„é«˜çº§å¡ç‰Œ
      {
        id: 'fortify',
        name: 'å¼ºåŒ–é˜²å¾¡',
        description: 'æœ¬å›åˆå‡å°‘70%å—åˆ°çš„ä¼¤å®³ï¼Œå¹¶æ¢å¤5ç‚¹ç”Ÿå‘½å€¼',
        color: 'bg-blue-600/30',
        borderColor: 'border-blue-600',
        icon: 'fa-shield',
        defend: 0.3,
        heal: 5,
        type: 'defense',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'devastating_attack',
        name: 'æ¯ç­æ€§æ”»å‡»',
        description: 'å¯¹æ•Œäººé€ æˆ2å€åŸºç¡€ä¼¤å®³ï¼Œæœ‰10%å‡ ç‡å‡»æ™•æ•Œäºº',
        color: 'bg-accent/30',
        borderColor: 'border-accent',
        icon: 'fa-hand-rock-o',
        damageMultiplier: 2,
        stunChance: 10,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'armor_break_attack',
        name: 'ç ´ç”²æ”»å‡»',
        description: 'æ— è§†æ•Œäºº5ç‚¹é˜²å¾¡ï¼Œé€ æˆ1.2å€ä¼¤å®³',
        color: 'bg-indigo-600/30',
        borderColor: 'border-indigo-600',
        icon: 'fa-arrow-right',
        damageMultiplier: 1.2,
        ignoreDefense: 5,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'triple_attack',
        name: 'ä¸‰é‡æ‰“å‡»',
        description: 'è¿ç»­æ”»å‡»ä¸‰æ¬¡ï¼Œæ¯æ¬¡é€ æˆ60%ä¼¤å®³',
        color: 'bg-rose-600/30',
        borderColor: 'border-rose-600',
        icon: 'fa-repeat',
        damageMultiplier: 0.6,
        hitCount: 3,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'assassinate',
        name: 'æš—æ€',
        description: 'è‹¥æ•Œäººç”Ÿå‘½å€¼é«˜äº50%ï¼Œé€ æˆ3å€ä¼¤å®³',
        color: 'bg-emerald-600/30',
        borderColor: 'border-emerald-600',
        icon: 'fa-street-view',
        damageMultiplier: 3,
        condition: 'medium_hp',
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'perfect_parry',
        name: 'å®Œç¾æ ¼æŒ¡',
        description: 'æœ‰50%å‡ ç‡å®Œå…¨æ ¼æŒ¡ä¸€æ¬¡æ”»å‡»ï¼Œå¹¶åå‡»é€ æˆ20%ä¼¤å®³',
        color: 'bg-cyan-600/30',
        borderColor: 'border-cyan-600',
        icon: 'fa-ban',
        parryChance: 50,
        counterDamage: 0.2,
        type: 'defense',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'blink',
        name: 'é—ªç°',
        description: 'æœ¬å›åˆæœ‰70%å‡ ç‡é—ªé¿æ”»å‡»ï¼Œå¹¶è·å¾—ä¸€æ¬¡é¢å¤–æŠ½ç‰Œ',
        color: 'bg-teal-600/30',
        borderColor: 'border-teal-600',
        icon: 'fa-bolt',
        dodgeChance: 70,
        drawCard: 1,
        type: 'defense',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'life_steal_attack',
        name: 'ç”Ÿå‘½å·å–æ”»å‡»',
        description: 'æ¶ˆè€—5ç‚¹ç”Ÿå‘½ï¼Œé€ æˆ2.5å€ä¼¤å®³ï¼Œå›å¤10ç‚¹ç”Ÿå‘½',
        color: 'bg-red-700/30',
        borderColor: 'border-red-700',
        icon: 'fa-balance-scale',
        damageMultiplier: 2.5,
        healthCost: 5,
        heal: 10,
        type: 'special',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'flame_strike',
        name: 'çƒˆç„°æ‰“å‡»',
        description: 'é€ æˆ25ç‚¹ç«ç„°ä¼¤å®³ï¼Œæœ‰50%å‡ ç‡ç¼çƒ§æ•Œäºº',
        color: 'bg-orange-600/30',
        borderColor: 'border-orange-600',
        icon: 'fa-fire',
        damage: 25,
        burnChance: 50,
        type: 'magic',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'ice_lance',
        name: 'å†°æªæœ¯',
        description: 'é€ æˆ20ç‚¹ä¼¤å®³ï¼Œæœ‰60%å‡ ç‡å‡ç¼“æ•Œäººå¹¶ä½¿å…¶ä¸‹ä¸€å›åˆä¼¤å®³é™ä½',
        color: 'bg-sky-600/30',
        borderColor: 'border-sky-600',
        icon: 'fa-snowflake-o',
        damage: 20,
        slowChance: 60,
        reduceDamage: 0.3,
        type: 'magic',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'greater_heal',
        name: 'å¼ºæ•ˆæ²»æ„ˆ',
        description: 'æ¢å¤40ç‚¹ç”Ÿå‘½å€¼ï¼Œå¹¶è·å¾—2ç‚¹ä¸´æ—¶é˜²å¾¡',
        color: 'bg-green-600/30',
        borderColor: 'border-green-600',
        icon: 'fa-heart',
        heal: 40,
        tempDefense: 2,
        type: 'support',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'deadly_poison',
        name: 'è‡´å‘½æ¯’è¯',
        description: 'ä½¿æ•Œäººä¸­å‰§æ¯’ï¼Œæ¯å›åˆå—åˆ°10ç‚¹ä¼¤å®³ï¼ŒæŒç»­4å›åˆ',
        color: 'bg-green-700/30',
        borderColor: 'border-green-700',
        icon: 'fa-bug',
        applyPoison: 10,
        poisonDuration: 4,
        type: 'dot',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'tornado',
        name: 'é¾™å·é£',
        description: 'å¯¹æ•Œäººé€ æˆä¸‰æ¬¡70%ä¼¤å®³',
        color: 'bg-blue-600/30',
        borderColor: 'border-blue-600',
        icon: 'fa-sync',
        damageMultiplier: 0.7,
        hitCount: 3,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      }
    ];
    
    // æŠ€èƒ½æ•°æ®åº“
    const skillDatabase = [
      { 
        id: 'strong_attack', 
        name: 'å¼ºåŒ–æ”»å‡»', 
        description: 'æ”»å‡»åŠ›æå‡5ç‚¹',
        effect: (player) => { player.attack += 5; }
      },
      { 
        id: 'toughness', 
        name: 'åšéŸ§', 
        description: 'æœ€å¤§ç”Ÿå‘½å€¼æå‡20ç‚¹',
        effect: (player) => { 
          player.maxHp += 20;
        }
      },
      { 
        id: 'critical_strike', 
        name: 'æš´å‡»ç²¾é€š', 
        description: 'æš´å‡»å‡ ç‡æå‡5%ï¼Œæš´å‡»ä¼¤å®³ä¸º1.5å€',
        effect: (player) => { player.critChance += 5; }
      },
      { 
        id: 'shield', 
        name: 'é˜²å¾¡å§¿æ€', 
        description: 'è·å¾—5ç‚¹é˜²å¾¡åŠ›ï¼Œå‡å°‘å—åˆ°çš„ä¼¤å®³',
        effect: (player) => { player.defense += 5; }
      },
      { 
        id: 'vampirism', 
        name: 'å¸è¡€', 
        description: 'æ”»å‡»æ—¶æ¢å¤5ç‚¹ç”Ÿå‘½å€¼',
        effect: (player) => { 
          if (!player.skills.some(s => s.id === 'vampirism_active')) {
            player.skills.push({ 
              id: 'vampirism_active', 
              name: 'å¸è¡€', 
              description: 'æ”»å‡»æ—¶æ¢å¤5ç‚¹ç”Ÿå‘½å€¼' 
            });
          }
        }
      },
      { 
        id: 'second_wind', 
        name: 'äºŒæ¬¡æ”»å‡»', 
        description: 'è·å¾—ä¸€å¼ "äºŒæ¬¡æ‰“å‡»"å¡ç‰Œ',
        effect: (player) => { 
          addCardToPlayer({
            id: 'second_strike',
            name: 'äºŒæ¬¡æ‰“å‡»',
            description: 'å¯¹æ•Œäººé€ æˆ1.2å€æ™®é€šæ”»å‡»ä¼¤å®³',
            damageMultiplier: 1.2,
            color: 'bg-accent/20',
            borderColor: 'border-accent',
            icon: 'fa-repeat',
            type: 'attack',
            upgradeTo: null
          });
        }
      },
      { 
        id: 'card_mastery', 
        name: 'å¡ç‰Œç²¾é€š', 
        description: 'å¢åŠ ä¸€å¼ æ‰‹ç‰Œä¸Šé™',
        effect: (player) => { 
          player.maxCards = (player.maxCards || 5) + 1;
        }
      },
      { 
        id: 'upgrade_mastery', 
        name: 'å¡ç‰Œåˆæˆ', 
        description: 'ä¸¤å¼ ç›¸åŒå¡ç‰Œå³å¯åˆæˆå‡çº§',
        effect: (player) => { 
          gameState.cardFusion.required = 2;
          addSkillToPlayer({
            id: 'upgrade_mastery_active',
            name: 'å¡ç‰Œåˆæˆ',
            description: 'ä¸¤å¼ ç›¸åŒå¡ç‰Œå³å¯åˆæˆå‡çº§'
          });
        }
      },
      { 
        id: 'magic_affinity', 
        name: 'é­”æ³•äº²å’Œ', 
        description: 'é­”æ³•å¡ç‰Œæ•ˆæœæå‡20%',
        effect: (player) => { 
          addSkillToPlayer({
            id: 'magic_affinity_active',
            name: 'é­”æ³•äº²å’Œ',
            description: 'é­”æ³•å¡ç‰Œæ•ˆæœæå‡20%'
          });
        }
      },
      { 
        id: 'battle_trance', 
        name: 'æˆ˜æ–—ä¸“æ³¨', 
        description: 'æ¯ä½¿ç”¨3å¼ æ”»å‡»å¡ç‰Œï¼Œè·å¾—ä¸€å¼ éšæœºæ”»å‡»å¡ç‰Œ',
        effect: (player) => { 
          addSkillToPlayer({
            id: 'battle_trance_active',
            name: 'æˆ˜æ–—ä¸“æ³¨',
            description: 'æ¯ä½¿ç”¨3å¼ æ”»å‡»å¡ç‰Œï¼Œè·å¾—ä¸€å¼ éšæœºæ”»å‡»å¡ç‰Œ'
          });
          player.attackCardCounter = 0;
        }
      }
    ];
    
    // éšæœºæŠ€èƒ½ç”Ÿæˆå‡½æ•°
    function generateRandomSkill() {
      const baseEffects = [
        { type: 'attack', min: 3, max: 7, namePart: ['ç²¾å‡†', 'å¼ºåŠ›', 'è‡´å‘½'] },
        { type: 'defense', min: 2, max: 5, namePart: ['åšå›º', 'é’¢é“', 'å®ˆæŠ¤'] },
        { type: 'hp', min: 10, max: 30, namePart: ['æ´»åŠ›', 'ç”Ÿå‘½', 'ä½“è´¨'] },
        { type: 'crit', min: 3, max: 8, namePart: ['æš´å‡»', 'è‡´å‘½', 'ç²¾å‡†'] }
      ];
      
      const modifiers = [
        { name: 'åˆçº§', multiplier: 1 },
        { name: 'ä¸­çº§', multiplier: 1.5 },
        { name: 'é«˜çº§', multiplier: 2 }
      ];
      
      const effectTypes = [
        { name: 'æå‡', func: (stat, value) => stat + value },
        { name: 'å¼ºåŒ–', func: (stat, value) => stat + Math.round(value * 1.2) },
        { name: 'ç²¾é€š', func: (stat, value) => stat + Math.round(value * 1.5) }
      ];
      
      // éšæœºé€‰æ‹©åŸºç¡€æ•ˆæœ
      const base = baseEffects[Math.floor(Math.random() * baseEffects.length)];
      const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
      const effectType = effectTypes[Math.floor(Math.random() * effectTypes.length)];
      
      // è®¡ç®—æ•°å€¼
      const value = Math.floor((Math.random() * (base.max - base.min + 1) + base.min) * modifier.multiplier);
      
      // ç”Ÿæˆåç§°å’Œæè¿°
      const namePart = base.namePart[Math.floor(Math.random() * base.namePart.length)];
      const skillName = `${modifier.name}${namePart}${effectType.name}`;
      
      let description, effect;
      
      switch (base.type) {
        case 'attack':
          description = `æ”»å‡»åŠ›æå‡${value}ç‚¹`;
          effect = (player) => { player.attack = effectType.func(player.attack, value); };
          break;
        case 'defense':
          description = `é˜²å¾¡åŠ›æå‡${value}ç‚¹`;
          effect = (player) => { player.defense = effectType.func(player.defense, value); };
          break;
        case 'hp':
          description = `æœ€å¤§ç”Ÿå‘½å€¼æå‡${value}ç‚¹`;
          effect = (player) => { player.maxHp = effectType.func(player.maxHp, value); };
          break;
        case 'crit':
          description = `æš´å‡»å‡ ç‡æå‡${value}%`;
          effect = (player) => { player.critChance = effectType.func(player.critChance, value); };
          break;
      }
      
      return {
        id: `random_${Date.now()}`,
        name: skillName,
        description: description,
        effect: effect,
        isRandom: true
      };
    }
    
    // è£…å¤‡æ•°æ®åº“
    const equipmentDatabase = [
      // æ­¦å™¨ - å¢åŠ æ”»å‡»åŠ›
      // ä¼ å¥‡è£…å¤‡ - é¾™éª‘å£«å¥—è£…
      {  
        id: 'legendary_dragon_slayer',
        name: 'å± é¾™å‰‘',
        type: 'weapon',
        bonus: { attack: 30, critChance: 12 },
        rarity: 'legendary',
        description: 'ä¼ è¯´ä¸­å± è¿‡é¾™çš„ç¥å‰‘',
        set: 'dragon_knight',
        setEffect: 'é¾™éª‘å£«å¥—è£…'  
      },
      {  
        id: 'legendary_dragon_armor',
        name: 'é¾™è¡€é“ ç”²',
        type: 'armor',
        bonus: { defense: 20, maxHp: 120 },
        rarity: 'legendary',
        description: 'æ±²å–é¾™è¡€ç²¾åçš„ç¥ç§˜é“ ç”²',
        set: 'dragon_knight',
        setEffect: 'é¾™éª‘å£«å¥—è£…'  
      },
      {  
        id: 'legendary_dragon_amulet',
        name: 'é¾™ä¹‹æŠ¤ç¬¦',
        type: 'trinket',
        bonus: { maxHp: 70, critChance: 8 },
        rarity: 'legendary',
        description: 'å°å°ç€å·¨é¾™çµé­‚çš„æŠ¤ç¬¦',
        set: 'dragon_knight',
        setEffect: 'é¾™éª‘å£«å¥—è£…'  
      },
      {  
        id: 'legendary_dragon_ring',
        name: 'é¾™é³æŒ‡ç¯',
        type: 'ring',
        bonus: { attack: 15, defense: 15, maxHp: 30 },
        rarity: 'legendary',
        description: 'ç”¨é¾™é³æ‰“é€ çš„ç¥ç§˜æŒ‡ç¯',
        set: 'dragon_knight',
        setEffect: 'é¾™éª‘å£«å¥—è£…'  
      },
      
      // å…ƒç´ å¥—è£…
      {  
        id: 'legendary_elemental_blade',
        name: 'å…ƒç´ ä¹‹å‰‘',
        type: 'weapon',
        bonus: { attack: 28, critChance: 10 },
        rarity: 'legendary',
        description: 'æŒæ§å››ç§å…ƒç´ åŠ›é‡çš„é­”å‰‘',
        set: 'elemental',
        setEffect: 'å…ƒç´ å¥—è£…'  
      },
      {  
        id: 'legendary_elemental_robe',
        name: 'å…ƒç´ æ³•è¢',
        type: 'armor',
        bonus: { defense: 15, maxHp: 80, critChance: 5 },
        rarity: 'legendary',
        description: 'å¸æ”¶å…ƒç´ èƒ½é‡çš„ç¥ç§˜æ³•è¢',
        set: 'elemental',
        setEffect: 'å…ƒç´ å¥—è£…'  
      },
      {  
        id: 'legendary_elemental_orb',
        name: 'å…ƒç´ æ ¸å¿ƒ',
        type: 'trinket',
        bonus: { attack: 10, maxHp: 60, critChance: 10 },
        rarity: 'legendary',
        description: 'è•´å«åŸå§‹å…ƒç´ ä¹‹åŠ›çš„æ ¸å¿ƒ',
        set: 'elemental',
        setEffect: 'å…ƒç´ å¥—è£…'  
      },
      {  
        id: 'legendary_elemental_ring',
        name: 'å…ƒç´ æŒ‡ç¯',
        type: 'ring',
        bonus: { attack: 12, defense: 12, critChance: 8 },
        rarity: 'legendary',
        description: 'å¹³è¡¡å…ƒç´ åŠ›é‡çš„ç¥å¥‡æŒ‡ç¯',
        set: 'elemental',
        setEffect: 'å…ƒç´ å¥—è£…'  
      },
      
      // æš—å½±å¥—è£…
      {  
        id: 'legendary_shadow_dagger',
        name: 'æš—å½±åŒ•é¦–',
        type: 'weapon',
        bonus: { attack: 25, critChance: 20 },
        rarity: 'legendary',
        description: 'èƒ½åˆ‡å¼€å½±å­çš„è‡´å‘½åŒ•é¦–',
        set: 'shadow',
        setEffect: 'æš—å½±å¥—è£…'  
      },
      {  
        id: 'legendary_shadow_cloak',
        name: 'æš—å½±æ–—ç¯·',
        type: 'armor',
        bonus: { defense: 18, maxHp: 70 },
        rarity: 'legendary',
        description: 'èƒ½èå…¥é»‘æš—çš„ç¥ç§˜æ–—ç¯·',
        set: 'shadow',
        setEffect: 'æš—å½±å¥—è£…'  
      },
      {  
        id: 'legendary_shadow_amulet',
        name: 'æš—å½±ä¹‹å¿ƒ',
        type: 'trinket',
        bonus: { critChance: 15, attack: 8 },
        rarity: 'legendary',
        description: 'è·³åŠ¨ç€æš—å½±èƒ½é‡çš„æŠ¤ç¬¦',
        set: 'shadow',
        setEffect: 'æš—å½±å¥—è£…'  
      },
      {  
        id: 'legendary_shadow_ring',
        name: 'é˜´å½±æŒ‡ç¯',
        type: 'ring',
        bonus: { attack: 10, defense: 10, critChance: 12 },
        rarity: 'legendary',
        description: 'èƒ½æ“æ§é˜´å½±çš„ç¥å¥‡æŒ‡ç¯',
        set: 'shadow',
        setEffect: 'æš—å½±å¥—è£…'  
      },
      
      // å…‰æ˜å¥—è£…
      {  
        id: 'legendary_light_sword',
        name: 'å…‰æ˜åœ£å‰‘',
        type: 'weapon',
        bonus: { attack: 27, defense: 5, critChance: 10 },
        rarity: 'legendary',
        description: 'æ•£å‘ç¥åœ£å…‰èŠ’çš„åœ£å‰‘',
        set: 'light',
        setEffect: 'å…‰æ˜å¥—è£…'  
      },
      {  
        id: 'legendary_light_armor',
        name: 'å…‰æ˜é“ ç”²',
        type: 'armor',
        bonus: { defense: 22, maxHp: 110 },
        rarity: 'legendary',
        description: 'è¢«åœ£å…‰ç¥ç¦çš„ç¥åœ£é“ ç”²',
        set: 'light',
        setEffect: 'å…‰æ˜å¥—è£…'  
      },
      {  
        id: 'legendary_light_amulet',
        name: 'å…‰æ˜åŠå ',
        type: 'trinket',
        bonus: { maxHp: 80, defense: 8 },
        rarity: 'legendary',
        description: 'æ•£å‘æ²»æ„ˆä¹‹å…‰çš„ç¥åœ£åŠå ',
        set: 'light',
        setEffect: 'å…‰æ˜å¥—è£…'  
      },
      {  
        id: 'legendary_light_ring',
        name: 'åœ£å…‰æŒ‡ç¯',
        type: 'ring',
        bonus: { attack: 12, defense: 18, maxHp: 20 },
        rarity: 'legendary',
        description: 'è•´å«åœ£å…‰ä¹‹åŠ›çš„æŒ‡ç¯',
        set: 'light',
        setEffect: 'å…‰æ˜å¥—è£…'  
      },
      // æ™®é€šè£…å¤‡
      {
        id: 'sword_1',
        name: 'é“å‰‘',
        type: 'weapon',
        bonus: { attack: 5 },
        rarity: 'common',
        description: 'ä¸€æŠŠæ™®é€šçš„é“å‰‘ï¼Œå¢åŠ 5ç‚¹æ”»å‡»åŠ›'
      },
      {
        id: 'axe_1',
        name: 'æˆ˜æ–§',
        type: 'weapon',
        bonus: { attack: 7, critChance: 2 },
        rarity: 'common',
        description: 'æ²‰é‡çš„æˆ˜æ–§ï¼Œå¢åŠ 7ç‚¹æ”»å‡»åŠ›å’Œ2%æš´å‡»ç‡'
      },
      {
        id: 'dagger_1',
        name: 'åŒ•é¦–',
        type: 'weapon',
        bonus: { attack: 3, critChance: 5 },
        rarity: 'common',
        description: 'é”‹åˆ©çš„åŒ•é¦–ï¼Œå¢åŠ 3ç‚¹æ”»å‡»åŠ›å’Œ5%æš´å‡»ç‡'
      },
      {
        id: 'sword_2',
        name: 'é’¢å‰‘',
        type: 'weapon',
        bonus: { attack: 10 },
        rarity: 'rare',
        description: 'ç²¾è‰¯çš„é’¢å‰‘ï¼Œå¢åŠ 10ç‚¹æ”»å‡»åŠ›'
      },
      {
        id: 'sword_3',
        name: 'åœ£å‰‘',
        type: 'weapon',
        bonus: { attack: 15, critChance: 5 },
        rarity: 'epic',
        description: 'ç¥åœ£çš„å‰‘ï¼Œå¢åŠ 15ç‚¹æ”»å‡»åŠ›å’Œ5%æš´å‡»ç‡'
      },
      
      //  armor - å¢åŠ é˜²å¾¡åŠ›å’Œç”Ÿå‘½å€¼
      {
        id: 'cloth_1',
        name: 'å¸ƒè¡£',
        type: 'armor',
        bonus: { defense: 2, maxHp: 10 },
        rarity: 'common',
        description: 'ç®€å•çš„å¸ƒè¡£ï¼Œå¢åŠ 2ç‚¹é˜²å¾¡åŠ›å’Œ10ç‚¹ç”Ÿå‘½å€¼'
      },
      {
        id: 'leather_1',
        name: 'çš®ç”²',
        type: 'armor',
        bonus: { defense: 4, maxHp: 20 },
        rarity: 'common',
        description: 'åšéŸ§çš„çš®ç”²ï¼Œå¢åŠ 4ç‚¹é˜²å¾¡åŠ›å’Œ20ç‚¹ç”Ÿå‘½å€¼'
      },
      {
        id: 'iron_1',
        name: 'é“ç”²',
        type: 'armor',
        bonus: { defense: 7, maxHp: 30 },
        rarity: 'rare',
        description: 'åšå›ºçš„é“ç”²ï¼Œå¢åŠ 7ç‚¹é˜²å¾¡åŠ›å’Œ30ç‚¹ç”Ÿå‘½å€¼'
      },
      {
        id: 'steel_1',
        name: 'é’¢ç”²',
        type: 'armor',
        bonus: { defense: 10, maxHp: 50 },
        rarity: 'epic',
        description: 'ç²¾è‰¯çš„é’¢ç”²ï¼Œå¢åŠ 10ç‚¹é˜²å¾¡åŠ›å’Œ50ç‚¹ç”Ÿå‘½å€¼'
      },
      
      // é¥°å“ - å¢åŠ å„ç§å±æ€§
      {
        id: 'amulet_1',
        name: 'é“œé¡¹é“¾',
        type: 'trinket',
        bonus: { maxHp: 15, critChance: 2 },
        rarity: 'common',
        description: 'æ™®é€šçš„é“œé¡¹é“¾ï¼Œå¢åŠ 15ç‚¹ç”Ÿå‘½å€¼å’Œ2%æš´å‡»ç‡'
      },
      {
        id: 'amulet_2',
        name: 'é“¶é¡¹é“¾',
        type: 'trinket',
        bonus: { maxHp: 30, critChance: 4 },
        rarity: 'rare',
        description: 'ç²¾è‡´çš„é“¶é¡¹é“¾ï¼Œå¢åŠ 30ç‚¹ç”Ÿå‘½å€¼å’Œ4%æš´å‡»ç‡'
      },
      {
        id: 'ring_1',
        name: 'é“æˆ’æŒ‡',
        type: 'ring',
        bonus: { attack: 2, defense: 2 },
        rarity: 'common',
        description: 'æ™®é€šçš„é“æˆ’æŒ‡ï¼Œå¢åŠ 2ç‚¹æ”»å‡»åŠ›å’Œ2ç‚¹é˜²å¾¡åŠ›'
      },
      {
        id: 'ring_2',
        name: 'é“¶æˆ’æŒ‡',
        type: 'ring',
        bonus: { attack: 4, defense: 4, critChance: 2 },
        rarity: 'rare',
        description: 'ç²¾è‡´çš„é“¶æˆ’æŒ‡ï¼Œå¢åŠ 4ç‚¹æ”»å‡»åŠ›ã€4ç‚¹é˜²å¾¡åŠ›å’Œ2%æš´å‡»ç‡'
      },
      {
        id: 'ring_3',
        name: 'é’»çŸ³æˆ’æŒ‡',
        type: 'ring',
        bonus: { attack: 7, defense: 7, critChance: 5 },
        rarity: 'epic',
        description: 'åä¸½çš„é’»çŸ³æˆ’æŒ‡ï¼Œå¢åŠ 7ç‚¹æ”»å‡»åŠ›ã€7ç‚¹é˜²å¾¡åŠ›å’Œ5%æš´å‡»ç‡'
      }
    ];
    
    // æ•Œäººåç§°å’Œç±»å‹æ•°æ®åº“
    const enemyNameDatabase = {
      low: [
        'ç–¯ç‹‚çš„è€é¼ ', 'å •è½çš„å­¦å¾’', 'å˜å¼‚çš„ç”²è™«', 'æ„¤æ€’çš„åœ°ç²¾', 'å°å‹å²è±å§†',
        'å“­æ³£çš„å¹½çµ', 'æš´èºçš„é‡å…”', 'è…çƒ‚çš„éª·é«…', 'é†‰é…’çš„æµ·ç›—', 'è¿·è·¯çš„æ¶é­”'
      ],
      medium: [
        'æš—å½±çŒæ‰‹', 'æ·±æ¸Šç¥­å¸', 'é’¢é“å®ˆå«', 'ç«ç„°æ³•å¸ˆ', 'å†°éœœå·¨äºº',
        'æ¯’æ¶²èœ˜è››', 'äº¡çµæˆ˜å£«', 'é£æš´å…ƒç´ ', 'è¡€æœˆç‹¼äºº', 'è¯…å’’éª‘å£«'
      ],
      high: [
        'æ¯ç­ä½¿è€…', 'æœ«æ—¥å®ˆå«', 'è™šç©ºè¡Œè€…', 'æ­»äº¡éª‘å£«', 'åœ°ç‹±ç«é­”',
        'æš—å½±é¢†ä¸»', 'å†°éœœå¥³ç‹', 'ç˜Ÿç–«ä½¿è€…', 'æ··æ²Œå·«å¸ˆ', 'çµé­‚æ”¶å‰²è€…'
      ],
      extreme: [
        'æ·±æ¸Šä¹‹ä¸»', 'å®‡å®™åå™¬è€…', 'æœ«æ—¥å®¡åˆ¤è€…', 'ä¸‡é­‚ä¹‹ç‹', 'ç‚¼ç‹±ç„šé­”',
        'æš—å½±æœ¬æº', 'æ··æ²Œä¹‹ç¥', 'æ°¸æ’å·«å¦–', 'æ¯ç­å·¨é¾™', 'è™šç©ºé€ ç‰©'
      ]
    };
    
    // æ•Œäººç±»å‹æ•°æ®åº“ - å¢åŠ ç‹¬ç‰¹ç‰¹æ€§
    const enemyTypes = [
      // ä½å¨èƒæ•Œäºº
      { 
        baseHp: 50, 
        baseAttack: 8, 
        exp: 50, 
        threat: 'ä½', 
        sprite: 'fa-asterisk', 
        names: enemyNameDatabase.low,
        type: 'basic',
        ability: null
      },
      { 
        baseHp: 60, 
        baseAttack: 6, 
        exp: 55, 
        threat: 'ä½', 
        sprite: 'fa-shield', 
        names: ['å°çŸ³é­”', 'å²©çŸ³å®ˆå«', 'çŸ³è‚¤æ€ª', 'åœ°å…ƒç´ '],
        type: 'stone',
        ability: 'highDefense', // é«˜é˜²å¾¡
        defense: 4 // é¢å¤–é˜²å¾¡
      },
      { 
        baseHp: 40, 
        baseAttack: 10, 
        exp: 55, 
        threat: 'ä½', 
        sprite: 'fa-heartbeat', 
        names: ['å°å¸è¡€é¬¼', 'å¸è¡€è™è ', 'è¡€è™«'],
        type: 'vampire',
        ability: 'vampirism', // å¸è¡€
        vampirismRate: 0.3 // å¸è¡€æ¯”ä¾‹
      },
      
      // ä¸­å¨èƒæ•Œäºº
      { 
        baseHp: 80, 
        baseAttack: 12, 
        exp: 80, 
        threat: 'ä¸­', 
        sprite: 'fa-moon-o', 
        names: enemyNameDatabase.medium,
        type: 'medium',
        ability: null
      },
      { 
        baseHp: 100, 
        baseAttack: 10, 
        exp: 85, 
        threat: 'ä¸­', 
        sprite: 'fa-paw', 
        names: ['æ£®æ—ç‹¼äºº', 'è¡€æœˆç‹¼äºº', 'ç‹¼äººæˆ˜å£«'],
        type: 'werewolf',
        ability: 'vampirism', // å¸è¡€
        vampirismRate: 0.4 // å¸è¡€æ¯”ä¾‹
      },
      { 
        baseHp: 70, 
        baseAttack: 15, 
        exp: 85, 
        threat: 'ä¸­', 
        sprite: 'fa-bolt', 
        names: ['é—ªç”µæ³•å¸ˆ', 'é£æš´å·«å¸ˆ', 'é›·éœ†æœ¯å£«'],
        type: 'mage',
        ability: 'spellDamage', // é­”æ³•ä¼¤å®³ï¼Œæ— è§†é˜²å¾¡
        isMagicDamage: true
      },
      
      // é«˜å¨èƒæ•Œäºº
      { 
        baseHp: 120, 
        baseAttack: 16, 
        exp: 120, 
        threat: 'é«˜', 
        sprite: 'fa-shield', 
        names: enemyNameDatabase.high,
        type: 'high',
        ability: null
      },
      { 
        baseHp: 150, 
        baseAttack: 12, 
        exp: 130, 
        threat: 'é«˜', 
        sprite: 'fa-shield', 
        names: ['çŸ³å·¨äºº', 'ç†”å²©å®ˆå«', 'æ³°å¦çŸ³åƒ'],
        type: 'stoneGiant',
        ability: 'highDefense', // é«˜é˜²å¾¡
        defense: 8 // é¢å¤–é˜²å¾¡
      },
      { 
        baseHp: 100, 
        baseAttack: 20, 
        exp: 130, 
        threat: 'é«˜', 
        sprite: 'fa-dagger', 
        names: ['å½±åˆºå®¢', 'æš—å¤œæ€æ‰‹', 'è‡´å‘½ç›—è´¼'],
        type: 'assassin',
        ability: 'highCrit', // é«˜æš´å‡»
        critChance: 30 // æš´å‡»ç‡
      },
      { 
        baseHp: 120, 
        baseAttack: 15, 
        exp: 130, 
        threat: 'é«˜', 
        sprite: 'fa-plus-circle', 
        names: ['ç”Ÿå‘½ç¥­å¸', 'ç¥åœ£åŒ»å¸ˆ', 'æ²»ç–—æ¶é­”'],
        type: 'healer',
        ability: 'selfHeal', // è‡ªæˆ‘æ²»ç–—
        healAmount: 15, // æ¯æ¬¡æ²»ç–—é‡
        healFrequency: 3 // æ¯3å›åˆæ²»ç–—ä¸€æ¬¡
      },
      
      // æé«˜å¨èƒæ•Œäººï¼ˆBOSSï¼‰
      { 
        baseHp: 200, 
        baseAttack: 25, 
        exp: 200, 
        threat: 'æé«˜', 
        sprite: 'fa-fire', 
        names: enemyNameDatabase.extreme,
        type: 'extreme',
        ability: null
      },
      { 
        baseHp: 250, 
        baseAttack: 20, 
        exp: 220, 
        threat: 'æé«˜', 
        sprite: 'fa-shield', 
        names: ['è¿œå¤çŸ³é­”', 'å¤§åœ°å®ˆæŠ¤è€…', 'å²©çŸ³æ³°å¦'],
        type: 'ancientStone',
        ability: 'highDefense', // é«˜é˜²å¾¡
        defense: 12, // é¢å¤–é˜²å¾¡
        passive: 'damageReturn', // åå¼¹ä¼¤å®³
        damageReturnRate: 0.2 // åå¼¹20%ä¼¤å®³
      },
      { 
        baseHp: 180, 
        baseAttack: 30, 
        exp: 220, 
        threat: 'æé«˜', 
        sprite: 'fa-heartbeat', 
        names: ['å¸è¡€é¬¼ä¼¯çˆµ', 'è¡€ä¹‹é¢†ä¸»', 'ä¸æœ½å¸è¡€é¬¼'],
        type: 'vampireLord',
        ability: 'vampirism', // å¸è¡€
        vampirismRate: 0.5, // å¸è¡€æ¯”ä¾‹
        passive: 'lifeStealAura', // ç”Ÿå‘½å·å–å…‰ç¯
        auraDamage: 5 // æ¯å›åˆå¯¹ç©å®¶é€ æˆå›ºå®šä¼¤å®³å¹¶å¸è¡€
      },
      { 
        baseHp: 220, 
        baseAttack: 25, 
        exp: 220, 
        threat: 'æé«˜', 
        sprite: 'fa-star', 
        names: ['å…ƒç´ æŒæ§è€…', 'é­”æ³•ä¹‹ç‹', 'å¥¥æœ¯ä¸»å®°'],
        type: 'archMage',
        ability: 'spellDamage', // é­”æ³•ä¼¤å®³
        isMagicDamage: true,
        passive: 'manaShield', // é­”æ³•æŠ¤ç›¾
        shieldStrength: 20 // æŠ¤ç›¾å€¼
      }
    ];
    
    // DOMå…ƒç´  - æ–°å¢ç§»åŠ¨ç«¯è¡€æ¡å…ƒç´ 
    const elements = {
      // ç§»åŠ¨ç«¯å…ƒç´ 
      playerLevelMobile: document.getElementById('player-level-mobile'),
      playerHpMobile: document.getElementById('player-hp-mobile'),
      playerMaxHpMobile: document.getElementById('player-max-hp-mobile'),
      playerHpBarMobile: document.getElementById('player-hp-bar-mobile'),
      enemyNameMobile: document.getElementById('enemy-name-mobile'),
      enemyHpMobile: document.getElementById('enemy-hp-mobile'),
      enemyMaxHpMobile: document.getElementById('enemy-max-hp-mobile'),
      enemyHpBarMobile: document.getElementById('enemy-hp-bar-mobile'),
      
      // æ¡Œé¢ç«¯å…ƒç´ 
      playerLevel: document.getElementById('player-level'),
      playerHp: document.getElementById('player-hp'),
      playerMaxHp: document.getElementById('player-max-hp'),
      playerHpBar: document.getElementById('player-hp-bar'),
      playerExp: document.getElementById('player-exp'),
      playerNextLevel: document.getElementById('player-next-level'),
      playerExpBar: document.getElementById('player-exp-bar'),
      
      enemyName: document.getElementById('enemy-name'),
      enemyDisplayName: document.getElementById('enemy-display-name'),
      enemyHp: document.getElementById('enemy-hp'),
      enemyMaxHp: document.getElementById('enemy-max-hp'),
      enemyHpBar: document.getElementById('enemy-hp-bar'),
      enemyThreat: document.getElementById('enemy-threat'),
      enemySprite: document.getElementById('enemy-sprite'),
      
      battleMessage: document.getElementById('battle-message'),
      cardContainer: document.getElementById('card-container'),
      skillsContainer: document.getElementById('skills-container'),
      cardFusionHint: document.getElementById('card-fusion-hint'),
      
      // è£…å¤‡æ§½
      weaponSlot: document.getElementById('weapon-slot'),
      armorSlot: document.getElementById('armor-slot'),
      trinketSlot: document.getElementById('trinket-slot'),
      ringSlot: document.getElementById('ring-slot'),
      setEffectsContainer: document.getElementById('set-effects-container'),
      
      levelUpModal: document.getElementById('level-up-modal'),
      skillOptions: [
        document.getElementById('skill-option-1'),
        document.getElementById('skill-option-2'),
        document.getElementById('skill-option-3')
      ],
      
      // å¡ç‰Œå‡çº§æ¨¡æ€æ¡†
      cardUpgradeModal: document.getElementById('card-upgrade-modal'),
      upgradeFrom: document.getElementById('upgrade-from'),
      upgradeTo: document.getElementById('upgrade-to'),
      upgradeConfirm: document.getElementById('upgrade-confirm'),
      
      lootModal: document.getElementById('loot-modal'),
      lootContent: document.getElementById('loot-content'),
      equipButton: document.getElementById('equip-button'),
      
      gameOverModal: document.getElementById('game-over-modal'),
      finalLevel: document.getElementById('final-level'),
      restartButton: document.getElementById('restart-button'),
      
      // å‰§æƒ…ç³»ç»Ÿå…ƒç´ 
      storyModal: document.getElementById('story-modal'),
      storyContent: document.getElementById('story-content'),
      storyContinue: document.getElementById('story-continue'),
      
      // å¤§ç»“å±€å…ƒç´ 
      endingModal: document.getElementById('ending-modal'),
      endingContent: document.getElementById('ending-content'),
      restartAfterEnding: document.getElementById('restart-after-ending')
    };
    
    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
      // æ·»åŠ åˆ°initGame()å‡½æ•°ä¸­
      document.getElementById('discard-button').addEventListener('click', () => {
        if (!gameState.currentLoot) return;
        
        // è·å–å½“å‰æˆ˜åˆ©å“
        const loot = gameState.currentLoot;
        
        // æ£€æŸ¥ç©å®¶æ˜¯å¦å·²æœ‰è¯¥ç±»å‹çš„è£…å¤‡
        if (!gameState.player.equipment[loot.type]) {
          showToast('ä½ è¿˜æ²¡æœ‰è£…å¤‡è¯¥ç±»å‹çš„è£…å¤‡ï¼è¯·å…ˆè£…å¤‡åå†å¼ºåŒ–ã€‚');
          return;
        }
        
        // æ‰§è¡Œå¼ºåŒ–é€»è¾‘
        const success = upgradeEquipment(loot);
        
        // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½å…³é—­æ¨¡æ€æ¡†å¹¶ç»§ç»­æ¸¸æˆ
        setTimeout(() => {
          elements.lootModal.classList.add('hidden');
          gameState.currentLoot = null;
          
          // é‡æ–°æ¸²æŸ“è£…å¤‡å’Œç©å®¶çŠ¶æ€
          renderEquipment();
          renderPlayerStats();
          
          if (gameState.player.exp >= gameState.player.nextLevelExp) {
            checkLevelUp();
          } else {
            setTimeout(spawnNewEnemy, 1000);
          }
        }, 1000); // å»¶è¿Ÿå…³é—­ï¼Œè®©ç©å®¶çœ‹åˆ°å¼ºåŒ–ç»“æœ
      });
      // åˆå§‹åŒ–ç©å®¶å¡ç‰Œ
      gameState.player.cards = [
        cardDatabase.find(card => card.id === 'basic_attack'),
        cardDatabase.find(card => card.id === 'basic_attack'),
        cardDatabase.find(card => card.id === 'defend')
      ].filter(Boolean); // è¿‡æ»¤æ‰undefinedçš„å¡ç‰Œ
      
      // åˆå§‹åŒ–å¡ç‰Œè®¡æ•°
      gameState.player.cardCounts = {};
      gameState.player.cards.forEach(card => {
        if (card && card.id) { // å®‰å…¨æ£€æŸ¥
          incrementCardCount(card.id);
        }
      });
      
      // åˆå§‹åŒ–è£…å¤‡ä¸ºç©º
      gameState.player.equipment = {
        weapon: null,
        armor: null,
        trinket: null,
        ring: null
      };
      
      // æ˜¾ç¤ºå¡ç‰Œåˆæˆæç¤º
      setTimeout(() => {
        if (!gameState.cardFusion.shownHint) {
          elements.cardFusionHint.classList.remove('hidden');
          gameState.cardFusion.shownHint = true;
          
          // 3ç§’åè‡ªåŠ¨éšè—æç¤º
          setTimeout(() => {
            elements.cardFusionHint.classList.add('hidden');
          }, 5000);
        }
      }, 3000);
      
      // æ¸²æŸ“æ¸¸æˆçŠ¶æ€
      renderGame();
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬
      elements.restartButton.addEventListener('click', restartGame);
      elements.equipButton.addEventListener('click', equipLoot);
      elements.upgradeConfirm.addEventListener('click', () => {
        elements.cardUpgradeModal.classList.add('hidden');
        checkForCardUpgrades(); // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯å‡çº§çš„å¡ç‰Œ
      });
      
      // å‰§æƒ…ç³»ç»Ÿäº‹ä»¶ç›‘å¬
      elements.storyContinue.addEventListener('click', continueAfterStory);
      elements.restartAfterEnding.addEventListener('click', restartGameAfterEnding);
    }
    
    // æ¸²æŸ“æ¸¸æˆ
    function renderGame() {
      renderPlayerStats();
      renderEnemyStats();
      renderCards();
      renderSkills();
      renderEquipment();
    }
    
    // æ¸²æŸ“ç©å®¶çŠ¶æ€ - åŒæ—¶æ›´æ–°ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
    function renderPlayerStats() {
      // æ›´æ–°æ¡Œé¢ç«¯
      elements.playerLevel.textContent = gameState.player.level;
      elements.playerHp.textContent = gameState.player.hp;
      elements.playerMaxHp.textContent = gameState.player.maxHp;
      elements.playerHpBar.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
      
      elements.playerExp.textContent = gameState.player.exp;
      elements.playerNextLevel.textContent = gameState.player.nextLevelExp;
      elements.playerExpBar.style.width = `${(gameState.player.exp / gameState.player.nextLevelExp) * 100}%`;
      
      // æ›´æ–°ç§»åŠ¨ç«¯
      elements.playerLevelMobile.textContent = gameState.player.level;
      elements.playerHpMobile.textContent = gameState.player.hp;
      elements.playerMaxHpMobile.textContent = gameState.player.maxHp;
      elements.playerHpBarMobile.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
      
      // ç§»åŠ¨ç«¯è¡€æ¡é¢œè‰²å˜åŒ–
      if (gameState.player.hp / gameState.player.maxHp < 0.3) {
        elements.playerHpBarMobile.classList.remove('bg-green-500');
        elements.playerHpBarMobile.classList.add('bg-red-500');
      } else {
        elements.playerHpBarMobile.classList.remove('bg-red-500');
        elements.playerHpBarMobile.classList.add('bg-green-500');
      }
    }
    
    // æ¸²æŸ“æ•ŒäººçŠ¶æ€ - åŒæ—¶æ›´æ–°ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
    function renderEnemyStats() {
      // æ›´æ–°æ¡Œé¢ç«¯
      elements.enemyName.textContent = gameState.enemy.name;
      elements.enemyDisplayName.textContent = gameState.enemy.displayName;
      elements.enemyHp.textContent = gameState.enemy.hp;
      elements.enemyMaxHp.textContent = gameState.enemy.maxHp;
      elements.enemyHpBar.style.width = `${(gameState.enemy.hp / gameState.enemy.maxHp) * 100}%`;
      elements.enemyThreat.textContent = gameState.enemy.threat;
      
      // æ›´æ–°æ•Œäººå›¾æ ‡
      elements.enemySprite.innerHTML = `<i class="fa ${gameState.enemy.sprite} text-3xl md:text-4xl text-red-500"></i>`;
      
      // æ›´æ–°ç§»åŠ¨ç«¯
      elements.enemyNameMobile.textContent = gameState.enemy.name;
      elements.enemyHpMobile.textContent = gameState.enemy.hp;
      elements.enemyMaxHpMobile.textContent = gameState.enemy.maxHp;
      elements.enemyHpBarMobile.style.width = `${(gameState.enemy.hp / gameState.enemy.maxHp) * 100}%`;
    }
    
    // æ¸²æŸ“å¡ç‰Œ - ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º
    function renderCards() {
      elements.cardContainer.innerHTML = '';
      
      gameState.player.cards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        // ç§»åŠ¨ç«¯å¡ç‰Œå›ºå®šå®½åº¦ï¼Œæ¡Œé¢ç«¯è‡ªé€‚åº”
        const cardClass = `min-w-[140px] ${card.color} ${card.borderColor} border rounded-xl p-3 md:p-4 card-hover cursor-pointer ${card.isUpgraded ? 'card-upgraded' : ''}`;
        cardElement.className = cardClass;
        cardElement.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-base">${card.name}${card.isUpgraded ? '+' : ''}</h3>
            <i class="fa ${card.icon} text-lg"></i>
          </div>
          <p class="text-xs md:text-sm text-light/80">${card.description}</p>
        `;
        
        // å¢åŠ è§¦æ‘¸åŒºåŸŸå¤§å°
        cardElement.style.touchAction = 'manipulation';
        cardElement.addEventListener('click', () => useCard(index));
        elements.cardContainer.appendChild(cardElement);
      });
      
      // ç§»åŠ¨ç«¯è‡ªåŠ¨æ»šåŠ¨åˆ°ç¬¬ä¸€å¼ å¡ç‰Œ
      if (window.innerWidth < 768) {
        elements.cardContainer.scrollLeft = 0;
      }
    }
    
    // æ¸²æŸ“æŠ€èƒ½
    function renderSkills() {
      elements.skillsContainer.innerHTML = '';
      
      gameState.player.skills.forEach(skill => {
        const skillElement = document.createElement('div');
        skillElement.className = 'bg-primary/20 px-3 py-1 rounded-full text-xs md:text-sm whitespace-nowrap';
        skillElement.textContent = `${skill.name}: ${skill.description}`;
        elements.skillsContainer.appendChild(skillElement);
      });
    }
    
    // æ¸²æŸ“è£…å¤‡
    function renderEquipment() {
      const equipment = gameState.player.equipment;
      
      elements.weaponSlot.textContent = equipment.weapon ? 
        `${equipment.weapon.name}${equipment.weapon.set ? ` [${equipment.weapon.setEffect}]` : ''} (æ”»å‡»+${equipment.weapon.bonus.attack || 0})` : 'æ— ';
        
      elements.armorSlot.textContent = equipment.armor ? 
        `${equipment.armor.name}${equipment.armor.set ? ` [${equipment.armor.setEffect}]` : ''} (é˜²å¾¡+${equipment.armor.bonus.defense || 0})` : 'æ— ';
        
      elements.trinketSlot.textContent = equipment.trinket ? 
        `${equipment.trinket.name}${equipment.trinket.set ? ` [${equipment.trinket.setEffect}]` : ''} (ç”Ÿå‘½+${equipment.trinket.bonus.maxHp || 0})` : 'æ— ';
        
      elements.ringSlot.textContent = equipment.ring ? 
        `${equipment.ring.name}${equipment.ring.set ? ` [${equipment.ring.setEffect}]` : ''} (æ”»å‡»+${equipment.ring.bonus.attack || 0}, é˜²å¾¡+${equipment.ring.bonus.defense || 0})` : 'æ— ';
        
      // æ¸²æŸ“å¥—è£…æ•ˆæœ
      renderSetEffects();
    }
    
    // ä½¿ç”¨å¡ç‰Œ
    function useCard(index) {
      if (!gameState.isPlayerTurn || !gameState.isBattleActive) return;
      
      const card = gameState.player.cards[index];
      let message = '';
      let hasUsedCard = false;
      
      // å¤„ç†å¡ç‰Œæ•ˆæœ
      if (card.damage || card.damageMultiplier) {
        hasUsedCard = true;
        // è®¡ç®—åŸºç¡€æ”»å‡»åŠ›ï¼ˆåŒ…æ‹¬è£…å¤‡åŠ æˆï¼‰
        let baseAttack = gameState.player.attack;
        if (gameState.player.equipment.weapon && gameState.player.equipment.weapon.bonus.attack) {
          baseAttack += gameState.player.equipment.weapon.bonus.attack;
        }
        if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.attack) {
          baseAttack += gameState.player.equipment.ring.bonus.attack;
        }
        
        // ç‹‚æ€’æ•ˆæœ
        const hasFrenzy = gameState.player.skills.some(skill => skill.id === 'frenzy_active');
        if (hasFrenzy && gameState.player.hp / gameState.player.maxHp < 0.3) {
          baseAttack = Math.round(baseAttack * 1.2);
          message += 'ç‹‚æ€’æ¿€æ´»ï¼æ”»å‡»åŠ›æå‡ï¼';
        }
        
        // é­”æ³•äº²å’Œæ•ˆæœ
        const hasMagicAffinity = gameState.player.skills.some(skill => skill.id === 'magic_affinity_active');
        if (hasMagicAffinity && card.type === 'magic') {
          baseAttack = Math.round(baseAttack * 1.2);
          message += 'é­”æ³•äº²å’Œå¢å¼ºäº†æ•ˆæœï¼';
        }
        
        // è®¡ç®—ä¼¤å®³
        let damage = card.damage || Math.round(baseAttack * (card.damageMultiplier || 1));
        
        // å¤„ç†ç ´ç”²æ•ˆæœå’Œæ•Œäººé˜²å¾¡ç‰¹æ€§
        let effectiveDefense = gameState.enemy.defense || 0;
        
        // æ£€æŸ¥æ•Œäººæ˜¯å¦æœ‰ç‰¹æ®Šé˜²å¾¡èƒ½åŠ›
        if (gameState.enemy.ability === 'highDefense' && gameState.enemy.defenseMultiplier) {
          effectiveDefense = Math.round(effectiveDefense * gameState.enemy.defenseMultiplier);
        }
        
        // å¤„ç†ç ´ç”²æ•ˆæœ
        if (card.ignoreDefense) {
          effectiveDefense = Math.max(0, effectiveDefense - card.ignoreDefense);
        }
        
        // è®¡ç®—ä¼¤å®³ï¼ˆè€ƒè™‘é˜²å¾¡ï¼‰
        damage = Math.max(1, damage - effectiveDefense);
        
        // æ£€æŸ¥æ¡ä»¶ä¼¤å®³ï¼ˆå¦‚èƒŒåˆºï¼‰
        if (card.condition === 'high_hp' && gameState.enemy.hp / gameState.enemy.maxHp < 0.7) {
          damage = Math.round(damage / card.damageMultiplier); // ç§»é™¤å€ç‡
          message += 'æ•Œäººç”Ÿå‘½å€¼ä¸è¶³ï¼Œæ— æ³•å‘æŒ¥å…¨éƒ¨å¨åŠ›ï¼';
        }
        if (card.condition === 'medium_hp' && gameState.enemy.hp / gameState.enemy.maxHp < 0.5) {
          damage = Math.round(damage / 3); // ç§»é™¤æš—æ€çš„3å€å€ç‡
          message += 'æ•Œäººç”Ÿå‘½å€¼è¿‡ä½ï¼Œæš—æ€æ•ˆæœå‡å¼±ï¼';
        }
        
        // æ£€æŸ¥æš´å‡»ï¼ˆåŒ…æ‹¬è£…å¤‡åŠ æˆï¼‰
        let critChance = gameState.player.critChance;
        if (gameState.player.equipment.weapon && gameState.player.equipment.weapon.bonus.critChance) {
          critChance += gameState.player.equipment.weapon.bonus.critChance;
        }
        if (gameState.player.equipment.trinket && gameState.player.equipment.trinket.bonus.critChance) {
          critChance += gameState.player.equipment.trinket.bonus.critChance;
        }
        if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.critChance) {
          critChance += gameState.player.equipment.ring.bonus.critChance;
        }
        
        const isCrit = Math.random() * 100 < critChance;
        if (isCrit) {
          damage = Math.round(damage * 1.5);
          message += `ä½ ä½¿ç”¨äº†${card.name}ï¼Œé€ æˆäº†${damage}ç‚¹æš´å‡»ä¼¤å®³ï¼`;
        } else {
          message += `ä½ ä½¿ç”¨äº†${card.name}ï¼Œé€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`;
        }
        
        // å¤„ç†å¤šæ®µæ”»å‡»
        const hitCount = card.hitCount || 1;
        if (hitCount > 1) {
          damage *= hitCount;
          message = message.replace(`é€ æˆäº†${damage/hitCount}`, `é€ æˆäº†${hitCount}æ¬¡${damage/hitCount}ï¼Œæ€»è®¡${damage}`);
        }
        
        // å¤„ç†é­”æ³•æŠ¤ç›¾
        let damageToEnemy = damage;
        let damageToShield = 0;
        
        if (gameState.enemy.passive === 'manaShield' && gameState.enemy.shieldStrength > 0) {
          damageToShield = Math.min(damage, gameState.enemy.shieldStrength);
          gameState.enemy.shieldStrength -= damageToShield;
          damageToEnemy -= damageToShield;
          message += ` é­”æ³•æŠ¤ç›¾å¸æ”¶äº†${damageToShield}ç‚¹ä¼¤å®³ï¼`;
        }
        
        // åº”ç”¨å‰©ä½™ä¼¤å®³åˆ°æ•Œäºº
        if (damageToEnemy > 0) {
          gameState.enemy.hp -= damageToEnemy;
          if (gameState.enemy.hp < 0) gameState.enemy.hp = 0;
        }
        
        // å¤„ç†åå¼¹ä¼¤å®³ï¼ˆè†æ£˜å…‰ç¯ï¼‰
        if (gameState.enemy.passive === 'thorns' && damageToEnemy > 0 && gameState.enemy.thornsDamage > 0) {
          const thornsDamage = Math.round(damageToEnemy * gameState.enemy.thornsDamage);
          gameState.player.hp = Math.max(0, gameState.player.hp - thornsDamage);
          message += ` ${gameState.enemy.displayName}çš„è†æ£˜å…‰ç¯å¯¹ä½ é€ æˆäº†${thornsDamage}ç‚¹ä¼¤å®³ï¼`;
          
          // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
          if (gameState.player.hp <= 0) {
            gameState.player.hp = 0;
            renderPlayerStats();
            handleGameOver();
            return;
          }
        }
        
        // å¤„ç†å‡»æ™•æ•ˆæœ
        if (card.stunChance && Math.random() * 100 < card.stunChance) {
          gameState.enemy.stunned = true;
          message += ` æ•Œäººè¢«å‡»æ™•äº†ï¼Œä¸‹ä¸€å›åˆæ— æ³•è¡ŒåŠ¨ï¼`;
        }
        
        // å¤„ç†ç¼çƒ§æ•ˆæœ
        if (card.burnChance && Math.random() * 100 < card.burnChance) {
          gameState.enemy.burn = {
            damage: 5,
            duration: 2
          };
          message += ` æ•Œäººè¢«ç¼çƒ§ï¼Œæ¯å›åˆå—åˆ°5ç‚¹ä¼¤å®³ï¼`;
        }
        
        // æ£€æŸ¥å¸è¡€æ•ˆæœ
        const hasVampirism = gameState.player.skills.some(skill => skill.id === 'vampirism_active');
        if (hasVampirism) {
          const healAmount = Math.min(5 * hitCount, gameState.player.maxHp - gameState.player.hp);
          gameState.player.hp += healAmount;
          message += ` ä½ å¸å–äº†${healAmount}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        }
        
        // å¤„ç†çŒ®ç¥­æ”»å‡»çš„ç”Ÿå‘½æ¶ˆè€—
        if (card.healthCost) {
          gameState.player.hp = Math.max(1, gameState.player.hp - card.healthCost);
          message += ` ä½ æ¶ˆè€—äº†${card.healthCost}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        }
        
        // å¤„ç†ç”Ÿå‘½å·å–
        if (card.heal) {
          const actualHeal = Math.min(card.heal, gameState.player.maxHp - gameState.player.hp);
          gameState.player.hp += actualHeal;
          message += ` ä½ æ¢å¤äº†${actualHeal}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        }
        
        // æˆ˜æ–—ä¸“æ³¨è®¡æ•°
        if (gameState.player.skills.some(skill => skill.id === 'battle_trance_active')) {
          gameState.player.attackCardCounter = (gameState.player.attackCardCounter || 0) + 1;
          if (gameState.player.attackCardCounter >= 3) {
            // è·å¾—éšæœºæ”»å‡»å¡ç‰Œ
            const attackCards = cardDatabase.filter(c => c.type === 'attack' && !c.isUpgraded);
            const randomCard = attackCards[Math.floor(Math.random() * attackCards.length)];
            addCardToPlayer({...randomCard});
            message += ` æˆ˜æ–—ä¸“æ³¨æ¿€æ´»ï¼Œè·å¾—äº†${randomCard.name}ï¼`;
            gameState.player.attackCardCounter = 0;
          }
        }
      } else if (card.heal) {
        hasUsedCard = true;
        // æ²»ç–—æ•ˆæœ
        const actualHeal = Math.min(card.heal, gameState.player.maxHp - gameState.player.hp);
        gameState.player.hp += actualHeal;
        message = `ä½ ä½¿ç”¨äº†${card.name}ï¼Œæ¢å¤äº†${actualHeal}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        
        // ä¸´æ—¶é˜²å¾¡
        if (card.tempDefense) {
          gameState.player.tempDefense += card.tempDefense;
          message += ` è·å¾—äº†${card.tempDefense}ç‚¹ä¸´æ—¶é˜²å¾¡ï¼`;
        }
      } else if (card.defend || card.parryChance || card.dodgeChance) {
        hasUsedCard = true;
        if (card.defend) {
          // é˜²å¾¡æ•ˆæœ
          gameState.player.tempDefense = (gameState.player.defense * card.defend) || card.defend;
          message = `ä½ ä½¿ç”¨äº†${card.name}ï¼Œæœ¬å›åˆå‡å°‘${Math.round((1 - card.defend) * 100)}%å—åˆ°çš„ä¼¤å®³ï¼`;
        } else if (card.parryChance) {
          // æ ¼æŒ¡æ•ˆæœ
          gameState.player.parryChance = card.parryChance;
          gameState.player.counterDamage = card.counterDamage || 0;
          message = `ä½ ä½¿ç”¨äº†${card.name}ï¼Œæœ‰${card.parryChance}%å‡ ç‡å®Œå…¨æ ¼æŒ¡æ”»å‡»ï¼`;
        } else if (card.dodgeChance) {
          // é—ªé¿æ•ˆæœ
          gameState.player.dodgeChance = card.dodgeChance;
          message = `ä½ ä½¿ç”¨äº†${card.name}ï¼Œæœ‰${card.dodgeChance}%å‡ ç‡é—ªé¿æ”»å‡»ï¼`;
        }
        
        // æ²»ç–—æ•ˆæœï¼ˆå¦‚å¼ºåŒ–é˜²å¾¡ï¼‰
        if (card.heal) {
          const actualHeal = Math.min(card.heal, gameState.player.maxHp - gameState.player.hp);
          gameState.player.hp += actualHeal;
          message += ` åŒæ—¶æ¢å¤äº†${actualHeal}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        }
      } else if (card.applyPoison) {
        hasUsedCard = true;
        // æ¯’æ•ˆæœ
        gameState.enemy.poison = {
          damage: card.applyPoison,
          duration: card.poisonDuration
        };
        message = `ä½ ä½¿ç”¨äº†${card.name}ï¼Œä½¿æ•Œäººä¸­æ¯’ï¼Œæ¯å›åˆå—åˆ°${card.applyPoison}ç‚¹ä¼¤å®³ï¼ŒæŒç»­${card.poisonDuration}å›åˆï¼`;
      }
      
      if (hasUsedCard) {
        // è®°å½•å¡ç‰ŒIDç”¨äºè®¡æ•°æ›´æ–°
        const cardId = card.id;
        
        // ç§»é™¤å·²ä½¿ç”¨çš„å¡ç‰Œ
        gameState.player.cards.splice(index, 1);
        
        // æ›´æ–°å¡ç‰Œè®¡æ•°
        decrementCardCount(cardId);
        
        // æ›´æ–°æˆ˜æ–—ä¿¡æ¯
        elements.battleMessage.textContent = message;
        
        // é‡æ–°æ¸²æŸ“
        renderPlayerStats();
        renderEnemyStats();
        renderCards();
        
        // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
        if (gameState.enemy.hp <= 0) {
          handleEnemyDeath();
          return;
        }
        
        // åˆ‡æ¢åˆ°æ•Œäººå›åˆ
        gameState.isPlayerTurn = false;
        setTimeout(enemyTurn, 1500);
      }
    }
    
    // æ•Œäººå›åˆ
    function enemyTurn() {
      if (gameState.isPlayerTurn || !gameState.isBattleActive) return;
      
      // å¢åŠ æ•Œäººå›åˆè®¡æ•°
      gameState.enemy.turnCount = (gameState.enemy.turnCount || 0) + 1;
      
      // æ£€æŸ¥æ˜¯å¦è¢«å‡»æ™•
      if (gameState.enemy.stunned) {
        elements.battleMessage.textContent = `${gameState.enemy.displayName}è¢«å‡»æ™•äº†ï¼Œæ— æ³•è¡ŒåŠ¨ï¼`;
        gameState.enemy.stunned = false;
        
        // æŠ½ç‰Œè¡¥å……æ‰‹ç‰Œ
        drawNewCards();
        
        // åˆ‡æ¢å›ç©å®¶å›åˆ
        gameState.isPlayerTurn = true;
        return;
      }
      
      // å¤„ç†ç”Ÿå‘½å·å–å…‰ç¯ï¼ˆè¢«åŠ¨ï¼‰
      if (gameState.enemy.passive === 'lifeStealAura' && gameState.enemy.auraDamage > 0) {
        const auraDamage = gameState.enemy.auraDamage;
        gameState.player.hp = Math.max(0, gameState.player.hp - auraDamage);
        gameState.enemy.hp = Math.min(gameState.enemy.hp + auraDamage, gameState.enemy.maxHp);
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}çš„ç”Ÿå‘½å¸å–å…‰ç¯å¯¹ä½ é€ æˆäº†${auraDamage}ç‚¹ä¼¤å®³ï¼Œå¹¶æ¢å¤äº†${auraDamage}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        
        renderPlayerStats();
        renderEnemyStats();
        
        // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
        if (gameState.player.hp <= 0) {
          gameState.player.hp = 0;
          renderPlayerStats();
          handleGameOver();
          return;
        }
        
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      // å¤„ç†è‡ªæˆ‘æ²»ç–—èƒ½åŠ›
      if (gameState.enemy.ability === 'selfHeal' && 
          gameState.enemy.healAmount > 0 && 
          gameState.enemy.healFrequency && 
          gameState.enemy.turnCount % gameState.enemy.healFrequency === 0) {
        const healAmount = gameState.enemy.healAmount;
        gameState.enemy.hp = Math.min(gameState.enemy.hp + healAmount, gameState.enemy.maxHp);
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}ä½¿ç”¨äº†è‡ªæˆ‘æ²»ç–—ï¼Œæ¢å¤äº†${healAmount}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        
        renderEnemyStats();
        
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      // å¤„ç†ä¸­æ¯’æ•ˆæœ
      if (gameState.enemy.poison && gameState.enemy.poison.duration > 0) {
        gameState.enemy.hp -= gameState.enemy.poison.damage;
        gameState.enemy.poison.duration -= 1;
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}å—åˆ°${gameState.enemy.poison.damage}ç‚¹æ¯’ç´ ä¼¤å®³ï¼`;
        
        if (gameState.enemy.hp <= 0) {
          gameState.enemy.hp = 0;
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
        
        renderEnemyStats();
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      // å¤„ç†ç¼çƒ§æ•ˆæœ
      if (gameState.enemy.burn && gameState.enemy.burn.duration > 0) {
        gameState.enemy.hp -= gameState.enemy.burn.damage;
        gameState.enemy.burn.duration -= 1;
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}å—åˆ°${gameState.enemy.burn.damage}ç‚¹ç¼çƒ§ä¼¤å®³ï¼`;
        
        if (gameState.enemy.hp <= 0) {
          gameState.enemy.hp = 0;
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
        
        renderEnemyStats();
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      processNextEnemyAction();
    }
    
    // å¤„ç†æ•Œäººä¸‹ä¸€ä¸ªåŠ¨ä½œï¼ˆæ”»å‡»å‰çš„é€»è¾‘ï¼‰
    function processNextEnemyAction() {
      // ç»§ç»­å¤„ç†æ•Œäººçš„ä¸»è¦æ”»å‡»
      continueEnemyTurn();
    }
    
    // ç»§ç»­æ•Œäººå›åˆï¼ˆå¤„ç†æ”»å‡»ï¼‰
    function continueEnemyTurn() {
      // æ£€æŸ¥é—ªé¿
      if (gameState.player.dodgeChance && Math.random() * 100 < gameState.player.dodgeChance) {
        elements.battleMessage.textContent = `ä½ æˆåŠŸé—ªé¿äº†${gameState.enemy.displayName}çš„æ”»å‡»ï¼`;
        
        // é—ªç°çš„é¢å¤–æŠ½ç‰Œ
        const hasBlink = gameState.player.cards.some(c => c.id === 'blink' && c.drawCard);
        if (hasBlink) {
          drawNewCards(1); // é¢å¤–æŠ½1å¼ ç‰Œ
          elements.battleMessage.textContent += ` é—ªç°ä½¿ä½ è·å¾—äº†ä¸€å¼ é¢å¤–å¡ç‰Œï¼`;
        }
        
        // é‡ç½®é—ªé¿å‡ ç‡
        gameState.player.dodgeChance = 0;
        
        // æŠ½ç‰Œè¡¥å……æ‰‹ç‰Œ
        drawNewCards();
        
        // åˆ‡æ¢å›ç©å®¶å›åˆ
        gameState.isPlayerTurn = true;
        return;
      }
      
      // æ£€æŸ¥æ ¼æŒ¡
      if (gameState.player.parryChance && Math.random() * 100 < gameState.player.parryChance) {
        let message = `ä½ æˆåŠŸæ ¼æŒ¡äº†${gameState.enemy.displayName}çš„æ”»å‡»ï¼`;
        
        // å¤„ç†åå‡»ä¼¤å®³ï¼ˆè€ƒè™‘é­”æ³•æŠ¤ç›¾ï¼‰
        if (gameState.player.counterDamage > 0) {
          let counterDamage = Math.round(gameState.player.attack * gameState.player.counterDamage);
          
          // æ£€æŸ¥é­”æ³•æŠ¤ç›¾
          if (gameState.enemy.passive === 'manaShield' && gameState.enemy.shieldStrength > 0) {
            const damageToShield = Math.min(counterDamage, gameState.enemy.shieldStrength);
            gameState.enemy.shieldStrength -= damageToShield;
            counterDamage -= damageToShield;
            message += ` é­”æ³•æŠ¤ç›¾å¸æ”¶äº†${damageToShield}ç‚¹ä¼¤å®³ï¼`;
          }
          
          // å¯¹æ•Œäººé€ æˆå‰©ä½™ä¼¤å®³
          if (counterDamage > 0) {
            gameState.enemy.hp = Math.max(0, gameState.enemy.hp - counterDamage);
            message += ` åå‡»é€ æˆäº†${counterDamage}ç‚¹ä¼¤å®³ï¼`;
          }
          
          // æ£€æŸ¥æ•Œäººæ˜¯å¦å› åå‡»æ­»äº¡
          if (gameState.enemy.hp <= 0) {
            renderEnemyStats();
            elements.battleMessage.textContent = message;
            handleEnemyDeath();
            return;
          }
        }
        
        // é‡ç½®æ ¼æŒ¡å‡ ç‡å’Œåå‡»ä¼¤å®³
        gameState.player.parryChance = 0;
        gameState.player.counterDamage = 0;
        
        elements.battleMessage.textContent = message;
        renderEnemyStats();
        
        // æŠ½ç‰Œè¡¥å……æ‰‹ç‰Œ
        drawNewCards();
        
        // åˆ‡æ¢å›ç©å®¶å›åˆ
        gameState.isPlayerTurn = true;
        return;
      }
      
      // è®¡ç®—ç©å®¶æ€»é˜²å¾¡ï¼ˆåŒ…æ‹¬è£…å¤‡ï¼‰
      let totalDefense = gameState.player.defense;
      if (gameState.player.equipment.armor && gameState.player.equipment.armor.bonus.defense) {
        totalDefense += gameState.player.equipment.armor.bonus.defense;
      }
      if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.defense) {
        totalDefense += gameState.player.equipment.ring.bonus.defense;
      }
      
      // è®¡ç®—åŸºç¡€ä¼¤å®³
      let damage = gameState.enemy.attack;
      
      // å¤„ç†æš´å‡»ï¼ˆåˆºå®¢ç‰¹æ€§ï¼‰
      if (gameState.enemy.ability === 'highCrit' && gameState.enemy.critChance && Math.random() * 100 < gameState.enemy.critChance) {
        damage = Math.round(damage * 1.5); // 50%æš´å‡»ä¼¤å®³åŠ æˆ
        elements.battleMessage.textContent = `${gameState.enemy.displayName}å¯¹ä½ å‘åŠ¨äº†æš´å‡»ï¼`;
      }
      
      // å¤„ç†é­”æ³•ä¼¤å®³ï¼ˆæ³•å¸ˆç‰¹æ€§ï¼‰
      if (gameState.enemy.ability === 'spellDamage' && gameState.enemy.isMagicDamage) {
        // é­”æ³•ä¼¤å®³æ— è§†é˜²å¾¡ï¼Œä½†ä»ç„¶å¯ä»¥è¢«ä¸´æ—¶é˜²å¾¡å‡å…
        elements.battleMessage.textContent = `${gameState.enemy.displayName}å¯¹ä½ é€ æˆäº†${damage}ç‚¹é­”æ³•ä¼¤å®³ï¼`;
      } else {
        // ç‰©ç†ä¼¤å®³è€ƒè™‘é˜²å¾¡
        damage = damage - totalDefense;
        elements.battleMessage.textContent = `${gameState.enemy.displayName}å¯¹ä½ é€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`;
      }
      
      // åº”ç”¨ä¸´æ—¶é˜²å¾¡
      if (gameState.player.tempDefense) {
        damage = Math.round(damage * gameState.player.tempDefense);
        gameState.player.tempDefense = 0; // é‡ç½®ä¸´æ—¶é˜²å¾¡
      }
      
      // ç¡®ä¿ä¼¤å®³ä¸ä¸ºè´Ÿ
      damage = Math.max(1, damage);
      
      // åº”ç”¨ä¼¤å®³
      gameState.player.hp -= damage;
      
      // å¤„ç†å¸è¡€ç‰¹æ€§
      if (gameState.enemy.ability === 'vampirism' && gameState.enemy.vampirismRate) {
        const healAmount = Math.round(damage * gameState.enemy.vampirismRate);
        gameState.enemy.hp = Math.min(gameState.enemy.hp + healAmount, gameState.enemy.maxHp);
        elements.battleMessage.textContent += ` ${gameState.enemy.displayName}å¸å–äº†${healAmount}ç‚¹ç”Ÿå‘½å€¼ï¼`;
        renderEnemyStats();
      }
      
      // æ£€æŸ¥åå‡»æ•ˆæœ
      const hasCounterAttack = gameState.player.skills.some(skill => skill.id === 'counter_attack_active');
      if (hasCounterAttack && Math.random() * 100 < 30) {
        let counterDamage = Math.round(gameState.player.attack * 0.5);
        
        // æ£€æŸ¥é­”æ³•æŠ¤ç›¾
        if (gameState.enemy.passive === 'manaShield' && gameState.enemy.shieldStrength > 0) {
          const damageToShield = Math.min(counterDamage, gameState.enemy.shieldStrength);
          gameState.enemy.shieldStrength -= damageToShield;
          counterDamage -= damageToShield;
          elements.battleMessage.textContent += ` é­”æ³•æŠ¤ç›¾å¸æ”¶äº†${damageToShield}ç‚¹ä¼¤å®³ï¼`;
        }
        
        // å¯¹æ•Œäººé€ æˆå‰©ä½™ä¼¤å®³
        if (counterDamage > 0) {
          gameState.enemy.hp = Math.max(0, gameState.enemy.hp - counterDamage);
          elements.battleMessage.textContent += ` ä½ åå‡»é€ æˆäº†${counterDamage}ç‚¹ä¼¤å®³ï¼`;
        }
        
        // æ£€æŸ¥æ•Œäººæ˜¯å¦å› åå‡»æ­»äº¡
        if (gameState.enemy.hp <= 0) {
          renderPlayerStats();
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
      }
      
      // é‡æ–°æ¸²æŸ“
      renderPlayerStats();
      renderEnemyStats();
      
      // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
      if (gameState.player.hp <= 0) {
        gameState.player.hp = 0;
        renderPlayerStats();
        handleGameOver();
        return;
      }
      
      // å›åˆç»“æŸï¼Œæ£€æŸ¥ç¥åœ£ç¥ç¦
      const hasBlessing = gameState.player.skills.some(skill => skill.id === 'blessing_active');
      if (hasBlessing) {
        gameState.player.hp = Math.min(gameState.player.hp + 3, gameState.player.maxHp);
        elements.battleMessage.textContent += ` ç¥åœ£ç¥ç¦æ¢å¤äº†3ç‚¹ç”Ÿå‘½å€¼ï¼`;
        renderPlayerStats();
      }
      
      // æŠ½ç‰Œè¡¥å……æ‰‹ç‰Œ
      drawNewCards();
      
      // åˆ‡æ¢å›ç©å®¶å›åˆ
      gameState.isPlayerTurn = true;
    }
    
    // æŠ½æ–°å¡ç‰Œ
    function drawNewCards(additional = 0) {
      const maxCards = (gameState.player.maxCards || 5) + additional;
      while (gameState.player.cards.length < maxCards) {
        // éšç€éš¾åº¦æå‡ï¼Œè·å¾—é«˜çº§å¡ç‰Œçš„æ¦‚ç‡å¢åŠ ï¼ŒåŒæ—¶å‡å°‘é˜²å¾¡å¡ç‰Œçš„æ¦‚ç‡
        const random = Math.random();
        let newCard;
        
        // æ ¹æ®å¡ç‰Œç±»å‹è®¾ç½®ä¸åŒçš„æŠ½å–æ¦‚ç‡ï¼Œå‡å°‘é˜²å¾¡å¡ç‰Œçš„å‡ºç°é¢‘ç‡
        if (random < 0.05 * gameState.difficulty) {
          // å¼ºåŠ›æ”»å‡»å¡ç‰Œ
          newCard = getRandomCardByType(['attack'], true);
        } else if (random < 0.2 * gameState.difficulty) {
          // ç‰¹æ®Šæ”»å‡»å¡ç‰Œ
          newCard = getRandomCardByType(['attack', 'magic', 'special'], false);
        } else if (random < 0.25 * gameState.difficulty) {
          // æŒç»­ä¼¤å®³å¡ç‰Œ
          newCard = getRandomCardByType(['dot'], false);
        } else if (random < 0.3 + 0.05 * gameState.difficulty) {
          // æ²»ç–—å¡ç‰Œ
          newCard = getRandomCardByType(['support'], false);
        } else if (random < 0.35 + 0.05 * gameState.difficulty) {
          // é˜²å¾¡å¡ç‰Œ - æ¦‚ç‡æœ€ä½
          newCard = getRandomCardByType(['defense'], false);
        } else {
          // åŸºç¡€æ”»å‡»
          newCard = cardDatabase.find(card => card.id === 'basic_attack');
        }
        
        addCardToPlayer({...newCard});
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å¯å‡çº§çš„å¡ç‰Œ
      checkForCardUpgrades();
      
      renderCards();
    }
    
    // æ ¹æ®ç±»å‹è·å–éšæœºå¡ç‰Œ
    function getRandomCardByType(types, preferUpgradable) {
      let candidates = cardDatabase.filter(card => 
        types.includes(card.type) && (!preferUpgradable || card.upgradeTo)
      );
      
      // å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ï¼Œæ”¾å®½æ¡ä»¶
      if (candidates.length === 0) {
        candidates = cardDatabase.filter(card => types.includes(card.type));
      }
      
      return candidates[Math.floor(Math.random() * candidates.length)];
    }
    
    // æ·»åŠ å¡ç‰Œç»™ç©å®¶
    function addCardToPlayer(card) {
      gameState.player.cards.push(card);
      
      // æ›´æ–°å¡ç‰Œè®¡æ•°
      incrementCardCount(card.id);
      
      // ç¡®ä¿å¡ç‰Œæ•°é‡ä¸è¶…è¿‡ä¸Šé™
      const maxCards = gameState.player.maxCards || 5;
      if (gameState.player.cards.length > maxCards) {
        // ä¼˜å…ˆç§»é™¤åŸºç¡€æ”»å‡»
        const basicAttackIndex = gameState.player.cards.findIndex(c => c.id === 'basic_attack');
        if (basicAttackIndex !== -1) {
          const removedCardId = gameState.player.cards[basicAttackIndex].id;
          gameState.player.cards.splice(basicAttackIndex, 1);
          decrementCardCount(removedCardId);
        } else {
          // å¦åˆ™ç§»é™¤æœ€æ—©çš„å¡ç‰Œ
          const removedCardId = gameState.player.cards[0].id;
          gameState.player.cards.shift();
          decrementCardCount(removedCardId);
        }
      }
    }
    
    // å¢åŠ å¡ç‰Œè®¡æ•°
    function incrementCardCount(cardId) {
      gameState.player.cardCounts[cardId] = (gameState.player.cardCounts[cardId] || 0) + 1;
      
      // æ¯å¢åŠ ä¸€å¼ å¡å°±æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
      checkForCardUpgrades();
    }
    
    // å‡å°‘å¡ç‰Œè®¡æ•°
    function decrementCardCount(cardId) {
      if (gameState.player.cardCounts[cardId]) {
        gameState.player.cardCounts[cardId]--;
        if (gameState.player.cardCounts[cardId] === 0) {
          delete gameState.player.cardCounts[cardId];
        }
      }
    }
    
    // æ£€æŸ¥å¡ç‰Œå‡çº§ - å®Œå–„ä¸‰åˆä¸€åŠŸèƒ½
    function checkForCardUpgrades() {
      // å¦‚æœæœ‰æ¨¡æ€æ¡†æ­£åœ¨æ˜¾ç¤ºï¼Œåˆ™ä¸æ£€æŸ¥
      if (!elements.cardUpgradeModal.classList.contains('hidden')) {
        return;
      }
      
      // æ£€æŸ¥æ¯ç§å¯å‡çº§çš„å¡ç‰Œ
      for (const [cardId, count] of Object.entries(gameState.player.cardCounts)) {
        // ä½¿ç”¨é…ç½®çš„æ•°é‡è¦æ±‚ï¼ˆé»˜è®¤3å¼ ï¼Œå¯é€šè¿‡æŠ€èƒ½æ”¹ä¸º2å¼ ï¼‰
        if (count >= gameState.cardFusion.required) {
          const card = cardDatabase.find(c => c.id === cardId);
          if (card && card.upgradeTo) {
            const upgradedCard = cardDatabase.find(c => c.id === card.upgradeTo);
            if (upgradedCard) {
              // æ˜¾ç¤ºå‡çº§æç¤º
              elements.upgradeFrom.textContent = card.name;
              elements.upgradeTo.textContent = upgradedCard.name;
              elements.cardUpgradeModal.classList.remove('hidden');
              
              // ç§»é™¤ç›¸åº”æ•°é‡çš„æ—§å¡ç‰Œ
              for (let i = 0; i < gameState.cardFusion.required; i++) {
                const index = gameState.player.cards.findIndex(c => c.id === cardId);
                if (index !== -1) {
                  gameState.player.cards.splice(index, 1);
                }
              }
              
              // æ›´æ–°è®¡æ•°
              gameState.player.cardCounts[cardId] -= gameState.cardFusion.required;
              if (gameState.player.cardCounts[cardId] <= 0) {
                delete gameState.player.cardCounts[cardId];
              }
              
              // æ·»åŠ å‡çº§åçš„å¡ç‰Œ
              addCardToPlayer({...upgradedCard});
              
              return; // ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªå‡çº§
            }
          }
        }
      }
    }
    
    // å¤„ç†æ•Œäººæ­»äº¡
    function handleEnemyDeath(enemy = gameState.enemy) {
      gameState.isBattleActive = false;
      elements.battleMessage.textContent = `ä½ å‡»è´¥äº†${enemy.displayName}ï¼è·å¾—äº†${enemy.expReward}ç‚¹ç»éªŒå€¼ï¼`;
      
      // å¥–åŠ±ç»éªŒ
      gameState.player.exp += enemy.expReward;
      
      // å¿…å®šæ‰è½è£…å¤‡
      generateLoot();
      
      // é‡æ–°æ¸²æŸ“
      renderPlayerStats();
      
      // æ£€æŸ¥æ˜¯å¦å‡çº§
      checkLevelUp();
      
      // å¦‚æœæ²¡æœ‰å‡çº§ä¹Ÿæ²¡æœ‰æ‰è½ï¼Œç›´æ¥ç”Ÿæˆæ–°æ•Œäºº
      if (gameState.player.exp < gameState.player.nextLevelExp && !gameState.currentLoot) {
        setTimeout(spawnNewEnemy, 2000);
      }
    }
    
    // å¼ºåŒ–è£…å¤‡å‡½æ•°
    function upgradeEquipment(upgradeItem) {
      if (!gameState.player.equipment[upgradeItem.type]) {
        showToast('ä½ è¿˜æ²¡æœ‰è£…å¤‡è¯¥éƒ¨ä½çš„è£…å¤‡ï¼');
        return false;
      }
      
      // æ ¹æ®è£…å¤‡å“çº§ç¡®å®šå¼ºåŒ–æˆåŠŸç‡
      let successRate;
      switch(upgradeItem.rarity) {
        case 'common':
          successRate = 0.8; // 80%æˆåŠŸç‡
          break;
        case 'rare':
          successRate = 0.6; // 60%æˆåŠŸç‡
          break;
        case 'epic':
          successRate = 0.4; // 40%æˆåŠŸç‡
          break;
        case 'legendary':
          successRate = 0.3; // 30%æˆåŠŸç‡ï¼Œä½†å¼ºåŒ–æ”¶ç›Šæ›´é«˜
          break;
        default:
          successRate = 0.5; // é»˜è®¤50%
      }
      
      // æ‰§è¡Œå¼ºåŒ–
      if (Math.random() < successRate) {
        // å¼ºåŒ–æˆåŠŸ
        const equipment = gameState.player.equipment[upgradeItem.type];
        
        // ç§»é™¤æ—§çš„è£…å¤‡åŠ æˆ
        applyEquipmentBonuses(equipment, false);
        
        // æ›´æ–°è£…å¤‡å±æ€§
        if (!equipment.bonus) equipment.bonus = {};
        
        // ä¸ºæ¯ä¸ªå±æ€§å¢åŠ å¯¹åº”çš„å¼ºåŒ–å€¼
        let upgradeText = '';
        for (const [key, value] of Object.entries(upgradeItem.bonus)) {
          if (!equipment.bonus[key]) equipment.bonus[key] = 0;
          // æ ¹æ®è£…å¤‡ç¨€æœ‰åº¦å¢åŠ ä¸åŒçš„éšæœºåŠ æˆ
          let randomBonus;
          if (equipment.rarity === 'legendary') {
            randomBonus = Math.floor(Math.random() * 5) + 2; // ä¼ å¥‡è£…å¤‡ï¼š2-6ç‚¹é¢å¤–åŠ æˆ
          } else if (equipment.rarity === 'epic') {
            randomBonus = Math.floor(Math.random() * 4) + 1; // å²è¯—è£…å¤‡ï¼š1-5ç‚¹é¢å¤–åŠ æˆ
          } else if (equipment.rarity === 'rare') {
            randomBonus = Math.floor(Math.random() * 3) + 1; // ç¨€æœ‰è£…å¤‡ï¼š1-4ç‚¹é¢å¤–åŠ æˆ
          } else {
            randomBonus = Math.floor(Math.random() * 3); // æ™®é€šè£…å¤‡ï¼š0-3ç‚¹é¢å¤–åŠ æˆ
          }
          const totalBonus = value + randomBonus;
          equipment.bonus[key] += totalBonus;
          
          // æ„å»ºæç¤ºæ–‡æœ¬
          const keyText = key === 'attack' ? 'æ”»å‡»åŠ›' : 
                         key === 'defense' ? 'é˜²å¾¡åŠ›' : 
                         key === 'maxHp' ? 'æœ€å¤§ç”Ÿå‘½å€¼' : 
                         key === 'critChance' ? 'æš´å‡»ç‡' : '';
          upgradeText += `${keyText}+${totalBonus} `;
        }
        
        if (!equipment.upgrades) equipment.upgrades = 0;
        equipment.upgrades++;
        
        // ä¿å­˜åŸå§‹åç§°ç”¨äºå‡çº§æ˜¾ç¤º
        if (!equipment.baseName) equipment.baseName = equipment.name;
        equipment.name = `${equipment.baseName} +${equipment.upgrades}`;
        
        // é‡æ–°åº”ç”¨è£…å¤‡åŠ æˆ
        applyEquipmentBonuses(equipment, true);
        
        showToast(`${equipment.baseName}å¼ºåŒ–æˆåŠŸï¼${upgradeText}`);
        return true;
      } else {
        // å¼ºåŒ–å¤±è´¥ï¼Œæ— æƒ©ç½š
        showToast('å¼ºåŒ–å¤±è´¥ï¼Œä½†æ²¡æœ‰æŸå¤±ï¼');
        return false;
      }
    }
    
    // ç”Ÿæˆæˆ˜åˆ©å“
    function generateLoot() {
      // æ ¹æ®éš¾åº¦å’Œæ•Œäººç±»å‹è°ƒæ•´è£…å¤‡ç¨€æœ‰åº¦æ¦‚ç‡
      const random = Math.random() * 100;
      let rarityThreshold;
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯BOSSæˆ˜
      const isBoss = gameState.enemy && gameState.enemy.isBoss;
      
      if (isBoss) {
        // BOSSæˆ˜ï¼šæœ‰å‡ ç‡æ‰è½ä¼ å¥‡è£…å¤‡
        rarityThreshold = { legendary: 30, epic: 50, rare: 80, common: 100 };
      } else if (gameState.difficulty < 3) {
        rarityThreshold = { epic: 5, rare: 20, common: 100 };
      } else if (gameState.difficulty < 7) {
        rarityThreshold = { epic: 10, rare: 30, common: 100 };
      } else {
        rarityThreshold = { epic: 15, rare: 40, common: 100 };
      }
      
      let selectedEquipment;
      
      if (random < rarityThreshold.legendary && isBoss) {
        // ä¼ å¥‡è£…å¤‡ï¼ˆåªæœ‰BOSSæ‰ä¼šæ‰è½ï¼‰
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'legendary')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'legendary').length)];
      } else if (random < rarityThreshold.epic) {
        // å²è¯—è£…å¤‡
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'epic')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'epic').length)];
      } else if (random < rarityThreshold.rare) {
        // ç¨€æœ‰è£…å¤‡
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'rare')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'rare').length)];
      } else {
        // æ™®é€šè£…å¤‡
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'common')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'common').length)];
      }
      
      // ä¿å­˜å½“å‰æˆ˜åˆ©å“
      gameState.currentLoot = selectedEquipment;
      
      // æ˜¾ç¤ºæˆ˜åˆ©å“æ¨¡æ€æ¡†
      let rarityColor = 'text-light';
      if (selectedEquipment.rarity === 'legendary') rarityColor = 'text-yellow-400';
      if (selectedEquipment.rarity === 'rare') rarityColor = 'text-blue-400';
      if (selectedEquipment.rarity === 'epic') rarityColor = 'text-purple-400';
      
      elements.lootContent.innerHTML = `
        <div class="bg-dark/60 rounded-lg p-3 border ${selectedEquipment.rarity === 'legendary' ? 'border-yellow-500 glow pulse' :
          selectedEquipment.rarity === 'epic' ? 'border-purple-500 glow' : 
          selectedEquipment.rarity === 'rare' ? 'border-blue-500' : 'border-gray-500'}">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-base ${rarityColor}">${selectedEquipment.name}</h3>
            <span class="text-xs px-2 py-1 rounded-full ${selectedEquipment.rarity === 'legendary' ? 'bg-yellow-500/20 text-yellow-400' :
              selectedEquipment.rarity === 'epic' ? 'bg-purple-500/20 text-purple-400' : 
              selectedEquipment.rarity === 'rare' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-500/20 text-gray-400'}">
              ${selectedEquipment.rarity === 'legendary' ? 'ä¼ å¥‡' : selectedEquipment.rarity === 'epic' ? 'å²è¯—' : selectedEquipment.rarity === 'rare' ? 'ç¨€æœ‰' : 'æ™®é€š'}
            </span>
          </div>
          <p class="text-xs text-light/80 mb-2">${selectedEquipment.description}</p>
          <div class="text-xs">
            ${Object.entries(selectedEquipment.bonus).map(([key, value]) => {
              const keyText = key === 'attack' ? 'æ”»å‡»åŠ›' : 
                             key === 'defense' ? 'é˜²å¾¡åŠ›' : 
                             key === 'maxHp' ? 'æœ€å¤§ç”Ÿå‘½å€¼' : 
                             key === 'critChance' ? 'æš´å‡»ç‡' : '';
              return `<span class="mr-3">+${value} ${keyText}</span>`;
            }).join('')}
          </div>
        </div>
      `;
      
      elements.lootModal.classList.remove('hidden');
    }
    
    // è£…å¤‡æˆ˜åˆ©å“ï¼ˆç°åœ¨æ”¹ä¸ºå¼ºåŒ–è£…å¤‡ï¼‰
    function equipLoot() {
      if (!gameState.currentLoot) return;
      
      const equipment = gameState.currentLoot;
      
      applyEquipmentBonuses(equipment, true);
      gameState.player.equipment[equipment.type] = equipment;
      showToast(`è£…å¤‡äº† ${equipment.name}ï¼`);
      
      // éšè—æ¨¡æ€æ¡†
      elements.lootModal.classList.add('hidden');
      gameState.currentLoot = null;
      
      // é‡æ–°æ¸²æŸ“
      renderEquipment();
      renderPlayerStats();
      
      // æ£€æŸ¥æ˜¯å¦å‡çº§ï¼Œå¦åˆ™ç”Ÿæˆæ–°æ•Œäºº
      if (gameState.player.exp >= gameState.player.nextLevelExp) {
        checkLevelUp();
      } else {
        setTimeout(spawnNewEnemy, 1000);
      }
    }
    
    // å¥—è£…æ•ˆæœå®šä¹‰
    const setEffects = {
      dragon_knight: {
        2: { attack: 10, defense: 8 },
        3: { maxHp: 50, critChance: 5 },
        4: { attack: 15, defense: 12, maxHp: 100, critChance: 8 }
      },
      elemental: {
        2: { attack: 12, critChance: 6 },
        3: { defense: 10, maxHp: 40 },
        4: { attack: 20, defense: 15, maxHp: 80, critChance: 10 }
      },
      shadow: {
        2: { attack: 8, critChance: 10 },
        3: { defense: 8, maxHp: 30 },
        4: { attack: 20, defense: 12, maxHp: 60, critChance: 15 }
      },
      light: {
        2: { defense: 12, maxHp: 50 },
        3: { attack: 8, critChance: 5 },
        4: { attack: 15, defense: 20, maxHp: 100, critChance: 8 }
      }
    };
    
    // è®°å½•å½“å‰å¥—è£…åŠ æˆ
    let currentSetBonuses = {};
    
    // æ£€æŸ¥å’Œåº”ç”¨å¥—è£…æ•ˆæœ
    function checkAndApplySetEffects() {
      // ç§»é™¤æ—§çš„å¥—è£…åŠ æˆ
      removeSetBonuses();
      
      // è®¡ç®—æ¯ä¸ªå¥—è£…çš„è£…å¤‡æ•°é‡
      const setCounts = {};
      const equipment = gameState.player.equipment;
      
      for (const slot in equipment) {
        const item = equipment[slot];
        if (item && item.set) {
          setCounts[item.set] = (setCounts[item.set] || 0) + 1;
        }
      }
      
      // åº”ç”¨å¥—è£…æ•ˆæœ
      currentSetBonuses = {};
      
      for (const setName in setCounts) {
        const count = setCounts[setName];
        const setEffect = setEffects[setName];
        
        if (setEffect && setEffect[count]) {
          // åº”ç”¨å¯¹åº”æ•°é‡çš„å¥—è£…æ•ˆæœ
          for (const [attr, value] of Object.entries(setEffect[count])) {
            if (!currentSetBonuses[attr]) currentSetBonuses[attr] = 0;
            currentSetBonuses[attr] += value;
            
            // åº”ç”¨åˆ°ç©å®¶å±æ€§
            if (attr === 'maxHp') {
              const hpPercentage = gameState.player.hp / gameState.player.maxHp;
              gameState.player.maxHp += value;
              gameState.player.hp = Math.round(gameState.player.maxHp * hpPercentage);
            } else {
              gameState.player[attr] += value;
            }
          }
          
          // æ˜¾ç¤ºå¥—è£…æ•ˆæœæ¿€æ´»æç¤º
          const effectName = setName === 'dragon_knight' ? 'é¾™éª‘å£«å¥—è£…' : 
                            setName === 'elemental' ? 'å…ƒç´ å¥—è£…' : 
                            setName === 'shadow' ? 'æš—å½±å¥—è£…' : 
                            setName === 'light' ? 'å…‰æ˜å¥—è£…' : '';
          
          if (count === 2) {
            showToast(`âœ… ${effectName}æ¿€æ´»ï¼è£…å¤‡2ä»¶è·å¾—åŸºç¡€åŠ æˆï¼`);
          } else if (count === 3) {
            showToast(`âœ¨ ${effectName}å¼ºåŒ–ï¼è£…å¤‡3ä»¶è·å¾—é«˜çº§åŠ æˆï¼`);
          } else if (count === 4) {
            showToast(`ğŸ‘‘ ${effectName}å®Œæ•´ï¼è£…å¤‡4ä»¶è·å¾—ç»ˆæåŠ æˆï¼`);
          }
        }
      }
      
      // é‡æ–°æ¸²æŸ“UI
      renderSetEffects();
    }
    
    // ç§»é™¤å¥—è£…åŠ æˆ
    function removeSetBonuses() {
      for (const [attr, value] of Object.entries(currentSetBonuses)) {
        if (attr === 'maxHp') {
          const hpPercentage = gameState.player.hp / gameState.player.maxHp;
          gameState.player.maxHp -= value;
          gameState.player.hp = Math.round(gameState.player.maxHp * hpPercentage);
        } else {
          gameState.player[attr] -= value;
        }
      }
      currentSetBonuses = {};
    }
    
    // æ¸²æŸ“å¥—è£…æ•ˆæœæ˜¾ç¤º
    function renderSetEffects() {
      const equipment = gameState.player.equipment;
      const setCounts = {};
      let setHtml = '';
      
      // è®¡ç®—å¥—è£…æ•°é‡
      for (const slot in equipment) {
        const item = equipment[slot];
        if (item && item.set) {
          setCounts[item.set] = (setCounts[item.set] || 0) + 1;
        }
      }
      
      // æ„å»ºå¥—è£…æ˜¾ç¤ºHTML
      for (const setName in setCounts) {
        const count = setCounts[setName];
        const setEffect = setEffects[setName];
        const effectName = setName === 'dragon_knight' ? 'é¾™éª‘å£«å¥—è£…' : 
                          setName === 'elemental' ? 'å…ƒç´ å¥—è£…' : 
                          setName === 'shadow' ? 'æš—å½±å¥—è£…' : 
                          setName === 'light' ? 'å…‰æ˜å¥—è£…' : '';
        
        const bonusText = [];
        
        // è®¡ç®—æ€»å¥—è£…åŠ æˆ
        for (let i = 2; i <= count && i <= 4; i++) {
          if (setEffect && setEffect[i]) {
            for (const [attr, value] of Object.entries(setEffect[i])) {
              const attrText = attr === 'attack' ? 'æ”»å‡»åŠ›' : 
                             attr === 'defense' ? 'é˜²å¾¡åŠ›' : 
                             attr === 'maxHp' ? 'æœ€å¤§ç”Ÿå‘½å€¼' : 
                             attr === 'critChance' ? 'æš´å‡»ç‡' : '';
              bonusText.push(`+${value} ${attrText}`);
            }
          }
        }
        
        setHtml += `
          <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-2 mt-2">
            <div class="text-sm font-semibold text-yellow-400 mb-1">
              ${effectName} (${count}/4)
            </div>
            <div class="text-xs text-yellow-300">
              ${bonusText.join(' | ')}
            </div>
          </div>
        `;
      }
      
      // å¦‚æœæ²¡æœ‰å¥—è£…æ•ˆæœï¼Œæ˜¾ç¤ºç©ºæç¤º
      if (!setHtml) {
        setHtml = '<div class="text-xs text-light/50 italic">è£…å¤‡ç›¸åŒå¥—è£…çš„è£…å¤‡å¯è·å¾—é¢å¤–åŠ æˆ</div>';
      }
      
      // æ›´æ–°UIæ˜¾ç¤º
      if (elements.setEffectsContainer) {
        elements.setEffectsContainer.innerHTML = setHtml;
      }
    }
    
    // åº”ç”¨è£…å¤‡å±æ€§åŠ æˆ
    function applyEquipmentBonuses(equipment, apply) {
      const multiplier = apply ? 1 : -1;
      
      if (equipment.bonus.attack) {
        gameState.player.attack += equipment.bonus.attack * multiplier;
      }
      
      if (equipment.bonus.defense) {
        gameState.player.defense += equipment.bonus.defense * multiplier;
      }
      
      if (equipment.bonus.maxHp) {
        // è®¡ç®—ç”Ÿå‘½å€¼ç™¾åˆ†æ¯”ï¼Œä¿æŒæ¯”ä¾‹
        const hpPercentage = gameState.player.hp / gameState.player.maxHp;
        gameState.player.maxHp += equipment.bonus.maxHp * multiplier;
        gameState.player.hp = Math.round(gameState.player.maxHp * hpPercentage);
      }
      
      if (equipment.bonus.critChance) {
        gameState.player.critChance += equipment.bonus.critChance * multiplier;
      }
      
      // å¦‚æœæ˜¯åº”ç”¨è£…å¤‡ï¼Œå»¶è¿Ÿæ£€æŸ¥å¥—è£…æ•ˆæœä»¥ç¡®ä¿æ‰€æœ‰è£…å¤‡æ“ä½œå®Œæˆ
      if (apply) {
        setTimeout(checkAndApplySetEffects, 0);
      }
    }
    
    // æ·»åŠ æŠ€èƒ½ç»™ç©å®¶
    function addSkillToPlayer(skill) {
      if (!gameState.player.skills.some(s => s.id === skill.id)) {
        gameState.player.skills.push(skill);
      }
    }
    
    // æ£€æŸ¥å‡çº§
    function checkLevelUp() {
      while (gameState.player.exp >= gameState.player.nextLevelExp) {
        // å‡çº§
        gameState.player.level += 1;
        gameState.player.exp -= gameState.player.nextLevelExp;
        
        // å‡çº§åå›æ»¡ç”Ÿå‘½å€¼
        gameState.player.hp = gameState.player.maxHp;
        
        // è®¡ç®—ä¸‹ä¸€çº§æ‰€éœ€ç»éªŒï¼ˆé€’å¢ï¼‰
        gameState.player.nextLevelExp = Math.round(gameState.player.nextLevelExp * 1.5);
        
        // æ˜¾ç¤ºå‰§æƒ…ï¼ˆå¦‚æœæ˜¯1-20çº§ï¼‰
        if (gameState.player.level <= 20 && storyDatabase[gameState.player.level]) {
          showStoryScene(gameState.player.level);
          
          // æš‚åœæ¸¸æˆç›´åˆ°å‰§æƒ…ç»“æŸ
          gameState.isBattleActive = false;
          return; // ç­‰å¾…å‰§æƒ…ç»“æŸåå†æ˜¾ç¤ºå‡çº§é€‰æ‹©
        }
        
        // æ˜¾ç¤ºå‡çº§é€‰æ‹©
        showLevelUpOptions();
        
        // æé«˜éš¾åº¦
        gameState.difficulty += 0.3;
        gameState.enemy.lootChance = Math.min(70, 30 + gameState.difficulty * 5); // æé«˜æ‰è½æ¦‚ç‡
        
        // æš‚åœæ¸¸æˆç›´åˆ°é€‰æ‹©æŠ€èƒ½
        gameState.isBattleActive = false;
        return; // ä¸€æ¬¡åªå¤„ç†ä¸€çº§å‡çº§ï¼Œç­‰å¾…ç©å®¶é€‰æ‹©æŠ€èƒ½åç»§ç»­
      }
    }
    
    // æ˜¾ç¤ºå‰§æƒ…åœºæ™¯
    function showStoryScene(level) {
      const story = storyDatabase[level];
      
      if (story) {
        // ç‰¹æ®Šå¤„ç†20çº§å¤§ç»“å±€
        if (level === 20) {
          // æ˜¾ç¤ºå¤§ç»“å±€æ¨¡æ€æ¡†
          elements.endingContent.innerHTML = `
            <p class="text-lg font-medium mb-4">å‹‡è€…ä¼ è¯´ Â· ç»ˆç« </p>
            <p class="mb-4">${story.content}</p>
            <p class="text-sm text-yellow-400">æ­å–œä½ å®Œæˆäº†è¿™æ®µç²¾å½©çš„å†’é™©ï¼</p>
            <p class="text-sm text-light/70 mt-2">ä½ ä»ä¸€ä¸ªæ™®é€šçš„å¹´è½»äººæˆé•¿ä¸ºæ‹¯æ•‘ç‹å›½çš„è‹±é›„ï¼Œ<br>å…¬ä¸»è·æ•‘ï¼Œç‹å›½é‡è·å’Œå¹³ï¼Œ<br>è€Œä½ ä¹Ÿæ”¶è·äº†å±äºè‡ªå·±çš„è£è€€ä¸çˆ±æƒ…ã€‚</p>
          `;
          elements.endingModal.classList.remove('hidden');
          
          // é˜»æ­¢ç”Ÿæˆæ–°æ•Œäººï¼Œæ¸¸æˆç»“æŸ
          gameState.isBattleActive = false;
        } else {
          // æ˜¾ç¤ºæ™®é€šå‰§æƒ…æ¨¡æ€æ¡†
          elements.storyContent.innerHTML = `
            <p class="text-lg font-medium mb-3">ç¬¬${level}ç« ï¼š${story.title}</p>
            <p>${story.content}</p>
          `;
          elements.storyModal.classList.remove('hidden');
        }
      }
    }
    
    // ç»§ç»­æ¸¸æˆï¼ˆå¤„ç†å‰§æƒ…ç»“æŸåï¼‰
    function continueAfterStory() {
      // éšè—å‰§æƒ…æ¨¡æ€æ¡†
      elements.storyModal.classList.add('hidden');
      
      // æ˜¾ç¤ºå‡çº§é€‰æ‹©
      showLevelUpOptions();
    }
    
    // é‡æ–°å¼€å§‹æ¸¸æˆï¼ˆé€šå…³åï¼‰
    function restartGameAfterEnding() {
      // éšè—å¤§ç»“å±€æ¨¡æ€æ¡†
      elements.endingModal.classList.add('hidden');
      
      // é‡ç½®æ¸¸æˆçŠ¶æ€åˆ°åˆå§‹å€¼
      gameState.player = {
        level: 1,
        hp: 100,
        maxHp: 100,
        exp: 0,
        nextLevelExp: 100,
        attack: 10,
        defense: 0,
        critChance: 5,
        cards: [],
        cardCounts: {},
        skills: [
          { id: 'basic_attack', name: 'åŸºç¡€æ”»å‡»', description: 'é€ æˆ10ç‚¹ä¼¤å®³' }
        ],
        equipment: {
          weapon: null,
          armor: null,
          trinket: null,
          ring: null
        }
      };
      
      gameState.difficulty = 1;
      gameState.isBattleActive = true;
      
      // æ¸…ç©ºå¥—è£…åŠ æˆ
      removeSetBonuses();
      
      // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
      initGame();
      renderGame();
      spawnNewEnemy();
    }
    
    // æ˜¾ç¤ºå‡çº§é€‰æ‹©
    function showLevelUpOptions() {
      // éšæœºé€‰æ‹©2ä¸ªå›ºå®šæŠ€èƒ½å’Œ1ä¸ªéšæœºç”Ÿæˆçš„æŠ€èƒ½
      const shuffledSkills = [...skillDatabase].sort(() => 0.5 - Math.random());
      const fixedSkills = shuffledSkills.slice(0, 2);
      const randomSkill = generateRandomSkill();
      const selectedSkills = [...fixedSkills, randomSkill].sort(() => 0.5 - Math.random());
      
      // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„æŠ€èƒ½é€‰é¡¹
      elements.skillOptions.forEach((option, index) => {
        const skill = selectedSkills[index];
        option.innerHTML = `
          <h3 class="font-bold mb-1 ${skill.isRandom ? 'text-purple-400' : ''}">${skill.name}</h3>
          <p class="text-xs text-light/80">${skill.description}</p>
        `;
        
        // æ·»åŠ é€‰æ‹©äº‹ä»¶
        option.onclick = () => {
          // åº”ç”¨æŠ€èƒ½æ•ˆæœ
          skill.effect(gameState.player);
          
          // æ·»åŠ æŠ€èƒ½åˆ°ç©å®¶æŠ€èƒ½åˆ—è¡¨ï¼ˆå¦‚æœä¸æ˜¯ä¸´æ—¶æŠ€èƒ½ï¼‰
          if (!skill.isRandom && !gameState.player.skills.some(s => s.id === skill.id)) {
            gameState.player.skills.push({
              id: skill.id,
              name: skill.name,
              description: skill.description
            });
          } else if (skill.isRandom) {
            gameState.player.skills.push({
              id: skill.id,
              name: skill.name,
              description: skill.description
            });
          }
          
          // éšè—æ¨¡æ€æ¡†
          elements.levelUpModal.classList.add('hidden');
          
          // æ¢å¤æ¸¸æˆ
          gameState.isBattleActive = true;
          
          // ç»§ç»­æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
          checkLevelUp();
          
          // å¦‚æœæ²¡æœ‰æ›´å¤šå‡çº§ï¼Œç”Ÿæˆæ–°æ•Œäºº
          if (gameState.player.exp < gameState.player.nextLevelExp) {
            setTimeout(spawnNewEnemy, 1000);
          }
          
          // é‡æ–°æ¸²æŸ“
          renderGame();
        };
      });
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      elements.levelUpModal.classList.remove('hidden');
    }
    
    // ç”Ÿæˆæ–°æ•Œäºº
    function spawnNewEnemy() {
      // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç”Ÿæˆå¤´ç›®ï¼ˆé¦–æ¬¡7çº§ï¼Œä¹‹åæ¯5çº§ä¸€æ¬¡ï¼‰
      let isBossFight = false;
      let suitableEnemies;
      
      if (gameState.player.level === 7 || (gameState.player.level > 7 && (gameState.player.level - 7) % 5 === 0)) {
        isBossFight = true;
        // å¤´ç›®æˆ˜æ—¶åªé€‰æ‹©æé«˜å¨èƒæ•Œäºº
        suitableEnemies = enemyTypes.filter(enemy => enemy.threat === 'æé«˜');
      } else {
        // æ ¹æ®éš¾åº¦é€‰æ‹©é€‚åˆçš„æ•Œäººç±»å‹ç»„
        if (gameState.difficulty < 2) {
          // éš¾åº¦1ï¼šåªæœ‰ä½å¨èƒæ•Œäºº
          suitableEnemies = enemyTypes.filter(enemy => enemy.threat === 'ä½');
        } else if (gameState.difficulty < 4) {
          // éš¾åº¦2-3ï¼šä½å¨èƒå’Œä¸­å¨èƒæ•Œäºº
          suitableEnemies = enemyTypes.filter(enemy => enemy.threat === 'ä½' || enemy.threat === 'ä¸­');
        } else if (gameState.difficulty < 6) {
          // éš¾åº¦4-5ï¼šä¸­å¨èƒå’Œé«˜å¨èƒæ•Œäºº
          suitableEnemies = enemyTypes.filter(enemy => enemy.threat === 'ä¸­' || enemy.threat === 'é«˜');
        } else {
          // éš¾åº¦6+ï¼šé«˜å¨èƒå’Œæé«˜å¨èƒæ•Œäºº
          suitableEnemies = enemyTypes.filter(enemy => enemy.threat === 'é«˜' || enemy.threat === 'æé«˜');
        }
      }
      
      // éšæœºé€‰æ‹©ä¸€ä¸ªæ•Œäººç±»å‹
      const randomIndex = Math.floor(Math.random() * suitableEnemies.length);
      const baseEnemy = suitableEnemies[randomIndex];
      
      // éšéš¾åº¦å¢å¼ºæ•Œäººå±æ€§
      const difficultyMultiplier = 1 + (gameState.difficulty - 1) * 0.2;
      
      // åŠ å¼ºBOSSå±æ€§
      const bossLevel = isBossFight ? Math.floor((gameState.player.level - 7) / 5) + 1 : 0;
      const bossMultiplier = isBossFight ? 2 + bossLevel * 0.5 : 1;
      
      // éšæœºé€‰æ‹©æ•Œäººåç§°
      const randomNameIndex = Math.floor(Math.random() * baseEnemy.names.length);
      const enemyName = baseEnemy.names[randomNameIndex];
      
      // åˆ›å»ºæ•Œäººå¯¹è±¡ï¼ŒåŒ…å«ç‰¹æ€§
      gameState.enemy = {
        name: enemyName,
        displayName: isBossFight ? `${enemyName} (BOSS)` : enemyName,
        hp: Math.round(baseEnemy.baseHp * difficultyMultiplier * bossMultiplier),
        maxHp: Math.round(baseEnemy.baseHp * difficultyMultiplier * bossMultiplier),
        attack: Math.round(baseEnemy.baseAttack * difficultyMultiplier * bossMultiplier),
        defense: baseEnemy.defense ? Math.round(baseEnemy.defense * difficultyMultiplier * bossMultiplier) : Math.floor(baseEnemy.baseAttack * difficultyMultiplier * bossMultiplier * 0.3),
        expReward: Math.round(baseEnemy.exp * difficultyMultiplier * bossMultiplier * 2), // BOSSæä¾›æ›´å¤šç»éªŒå€¼
        threat: baseEnemy.threat,
        sprite: baseEnemy.sprite,
        lootChance: 100, // ç¡®ä¿æ¯åªæ€ªéƒ½å¿…å®šæ‰è½è£…å¤‡
        poison: null,
        burn: null,
        stunned: false,
        type: baseEnemy.type,
        ability: baseEnemy.ability,
        passive: baseEnemy.passive,
        turnCount: 0, // ç”¨äºè¿½è¸ªæ•Œäººçš„å›åˆæ•°
        isBoss: isBossFight, // æ ‡è®°æ˜¯å¦ä¸ºå¤´ç›®
        // å¤åˆ¶æ•Œäººç‰¹æœ‰çš„èƒ½åŠ›å‚æ•°
        vampirismRate: baseEnemy.vampirismRate,
        isMagicDamage: baseEnemy.isMagicDamage,
        critChance: baseEnemy.critChance,
        healAmount: baseEnemy.healAmount,
        healFrequency: baseEnemy.healFrequency,
        damageReturnRate: baseEnemy.damageReturnRate,
        auraDamage: baseEnemy.auraDamage,
        shieldStrength: baseEnemy.shieldStrength ? Math.round(baseEnemy.shieldStrength * difficultyMultiplier) : null
      };
      
      // æ£€æŸ¥æ˜¯å¦ç”Ÿæˆç¬¬äºŒåªå°æ€ªï¼ˆ30%æ¦‚ç‡ï¼Œéå¤´ç›®æˆ˜æ—¶ï¼‰
      if (!isBossFight && Math.random() < 0.3) {
        // éšæœºé€‰æ‹©ç¬¬äºŒä¸ªæ•Œäººç±»å‹ï¼ˆåªèƒ½æ˜¯ä½å¨èƒæˆ–ä¸­å¨èƒï¼‰
        const secondaryEnemyTypes = enemyTypes.filter(enemy => enemy.threat === 'ä½' || enemy.threat === 'ä¸­');
        const secondaryIndex = Math.floor(Math.random() * secondaryEnemyTypes.length);
        const secondaryBaseEnemy = secondaryEnemyTypes[secondaryIndex];
        const secondaryNameIndex = Math.floor(Math.random() * secondaryBaseEnemy.names.length);
        const secondaryEnemyName = secondaryBaseEnemy.names[secondaryNameIndex];
        
        gameState.secondEnemy = {
          name: secondaryEnemyName,
          displayName: secondaryEnemyName,
          hp: Math.round(secondaryBaseEnemy.baseHp * difficultyMultiplier * 0.7), // ç¬¬äºŒåªæ€ªè¡€é‡å‡å°‘30%
          maxHp: Math.round(secondaryBaseEnemy.baseHp * difficultyMultiplier * 0.7),
          attack: Math.round(secondaryBaseEnemy.baseAttack * difficultyMultiplier * 0.7), // æ”»å‡»å‡å°‘30%
          defense: secondaryBaseEnemy.defense ? Math.round(secondaryBaseEnemy.defense * difficultyMultiplier * 0.7) : Math.floor(secondaryBaseEnemy.baseAttack * difficultyMultiplier * 0.3 * 0.7),
          expReward: Math.round(secondaryBaseEnemy.exp * difficultyMultiplier * 1.5 * 0.7), // ç»éªŒå‡å°‘30%
          threat: secondaryBaseEnemy.threat,
          sprite: secondaryBaseEnemy.sprite,
          lootChance: 100, // ç¡®ä¿æ¯åªæ€ªéƒ½å¿…å®šæ‰è½è£…å¤‡
          poison: null,
          burn: null,
          stunned: false,
          type: secondaryBaseEnemy.type,
          ability: secondaryBaseEnemy.ability,
          passive: secondaryBaseEnemy.passive,
          turnCount: 0,
          // å¤åˆ¶æ•Œäººç‰¹æœ‰çš„èƒ½åŠ›å‚æ•°
          vampirismRate: secondaryBaseEnemy.vampirismRate,
          isMagicDamage: secondaryBaseEnemy.isMagicDamage,
          critChance: secondaryBaseEnemy.critChance,
          healAmount: secondaryBaseEnemy.healAmount,
          healFrequency: secondaryBaseEnemy.healFrequency,
          damageReturnRate: secondaryBaseEnemy.damageReturnRate,
          auraDamage: secondaryBaseEnemy.auraDamage,
          shieldStrength: secondaryBaseEnemy.shieldStrength ? Math.round(secondaryBaseEnemy.shieldStrength * difficultyMultiplier * 0.7) : null
        };
      } else {
        gameState.secondEnemy = null;
      }
      
      // æŠ½æ–°ç‰Œ
      drawNewCards();
      
      // æ¢å¤æˆ˜æ–—çŠ¶æ€
      gameState.isBattleActive = true;
      gameState.isPlayerTurn = true;
      
      // æ·»åŠ æ•Œäººç‰¹æ€§æè¿°
      let enemyDescription = '';
      if (isBossFight) {
        enemyDescription = `âš ï¸ å±é™©ï¼å¼ºå¤§çš„BOSS ${gameState.enemy.displayName} å‡ºç°äº†ï¼å®ƒçš„å®åŠ›è¿œè¶…æ™®é€šæ•Œäººï¼`;
      } else {
        enemyDescription = `æ–°çš„æ•Œäºº ${gameState.enemy.displayName} å‡ºç°äº†ï¼`;
      }
      
      // å¦‚æœæœ‰ç¬¬äºŒåªæ•Œäººï¼Œæ·»åŠ åˆ°æè¿°ä¸­
      if (gameState.secondEnemy) {
        enemyDescription += ` åŒæ—¶ï¼Œ${gameState.secondEnemy.displayName} ä¹ŸåŠ å…¥äº†æˆ˜æ–—ï¼`;
      }
      if (gameState.enemy.ability === 'highDefense') {
        enemyDescription += ' å®ƒæ‹¥æœ‰åšç¡¬çš„æŠ¤ç”²ï¼';
      } else if (gameState.enemy.ability === 'vampirism') {
        enemyDescription += ' å®ƒèƒ½ä»æ”»å‡»ä¸­å¸å–ç”Ÿå‘½ï¼';
      } else if (gameState.enemy.ability === 'spellDamage') {
        enemyDescription += ' å®ƒçš„æ”»å‡»æ— è§†é˜²å¾¡ï¼';
      } else if (gameState.enemy.ability === 'highCrit') {
        enemyDescription += ' å®ƒç»å¸¸æš´å‡»ï¼';
      } else if (gameState.enemy.ability === 'selfHeal') {
        enemyDescription += ' å®ƒèƒ½è‡ªæˆ‘æ²»ç–—ï¼';
      }
      
      if (gameState.enemy.passive) {
        if (gameState.enemy.passive === 'damageReturn') {
          enemyDescription += ' å®ƒä¼šåå¼¹ä¼¤å®³ï¼';
        } else if (gameState.enemy.passive === 'lifeStealAura') {
          enemyDescription += ' å®ƒå‘¨å›´ç¯ç»•ç€ç”Ÿå‘½å¸å–å…‰ç¯ï¼';
        } else if (gameState.enemy.passive === 'manaShield') {
          enemyDescription += ' å®ƒæ‹¥æœ‰é­”æ³•æŠ¤ç›¾ï¼';
        }
      }
      
      elements.battleMessage.textContent = enemyDescription;
      
      // é‡æ–°æ¸²æŸ“
      renderEnemyStats();
    }
    
    // å¤„ç†æ¸¸æˆç»“æŸ
    function handleGameOver() {
      gameState.isBattleActive = false;
      elements.finalLevel.textContent = gameState.player.level;
      elements.gameOverModal.classList.remove('hidden');
    }
    
    // é‡æ–°å¼€å§‹æ¸¸æˆ
    function restartGame() {
      // é‡ç½®æ¸¸æˆçŠ¶æ€
      gameState.player = {
        level: 1,
        hp: 100,
        maxHp: 100,
        exp: 0,
        nextLevelExp: 100,
        attack: 10,
        defense: 0,
        critChance: 5,
        cards: [],
        cardCounts: {},
        skills: [
          { id: 'basic_attack', name: 'åŸºç¡€æ”»å‡»', description: 'é€ æˆ10ç‚¹ä¼¤å®³' }
        ],
        equipment: {
          weapon: null,
          armor: null,
          trinket: null,
          ring: null
        }
      };
      
      // åˆå§‹åŒ–ç¬¬äºŒæ•ŒäººçŠ¶æ€
      gameState.secondEnemy = null;
      
      gameState.enemy = {
        name: 'åˆçº§é­”ç‰©',
        displayName: 'åˆçº§é­”ç‰©',
        hp: 50,
        maxHp: 50,
        attack: 8,
        defense: 2,
        threat: 'ä½',
        expReward: 50,
        sprite: 'fa-asterisk',
        lootChance: 30,
        poison: null,
        burn: null,
        stunned: false
      };
      
      // é‡ç½®å¡ç‰Œåˆæˆé…ç½®
      gameState.cardFusion = {
        required: 3,
        shownHint: false
      };
      
      gameState.isPlayerTurn = true;
      gameState.isBattleActive = true;
      gameState.difficulty = 1;
      gameState.currentLoot = null;
      
      // éšè—æ¨¡æ€æ¡†
      elements.gameOverModal.classList.add('hidden');
      elements.levelUpModal.classList.add('hidden');
      elements.lootModal.classList.add('hidden');
      elements.cardUpgradeModal.classList.add('hidden');
      
      // é‡æ–°åˆå§‹åŒ–
      initGame();
    }
    
    // å¯åŠ¨æ¸¸æˆ
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>