<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>深渊卡牌 - 肉鸽卡牌游戏</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6D28D9', // 主色调：深紫色
            secondary: '#EC4899', // 辅助色：粉色
            accent: '#F59E0B', // 强调色：金色
            dark: '#1E1B4B', // 深色背景
            light: '#E0E7FF', // 浅色文本
          },
          fontFamily: {
            game: ['Segoe UI', 'Roboto', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:scale-105 hover:shadow-lg;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .bg-game {
        background-image: radial-gradient(circle at center, #2D1B69 0%, #111827 100%);
      }
      .glow {
        box-shadow: 0 0 15px rgba(110, 40, 217, 0.6);
      }
      .card-upgraded {
        border: 2px solid #F59E0B !important;
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
  </style>
</head>
<body class="bg-game font-game text-light min-h-screen flex flex-col overflow-x-hidden">
  <!-- 固定顶部的状态面板 - 在移动设备上始终可见 -->
  <div class="fixed top-0 left-0 right-0 z-40 bg-dark/80 backdrop-blur-md border-b border-primary/30 md:hidden">
    <div class="container mx-auto px-3 py-2">
      <!-- 玩家状态 - 精简版 -->
      <div class="flex justify-between items-center mb-1">
        <div class="flex items-center">
          <i class="fa fa-user-circle mr-1 text-secondary text-sm"></i>
          <span class="text-xs bg-primary/20 px-1.5 py-0.5 rounded-full">Lv <span id="player-level-mobile">1</span></span>
        </div>
        <div class="text-xs">
          <span id="player-hp-mobile">100</span>/<span id="player-max-hp-mobile">100</span>
        </div>
      </div>
      <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden mb-2">
        <div id="player-hp-bar-mobile" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 100%"></div>
      </div>
      
      <!-- 敌人状态 - 精简版 -->
      <div class="flex justify-between items-center mb-1">
        <div class="flex items-center">
          <i class="fa fa-skull mr-1 text-red-500 text-sm"></i>
          <span id="enemy-name-mobile" class="text-sm truncate max-w-[120px]">初级魔物</span>
        </div>
        <div class="text-xs">
          <span id="enemy-hp-mobile">50</span>/<span id="enemy-max-hp-mobile">50</span>
        </div>
      </div>
      <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
        <div id="enemy-hp-bar-mobile" class="h-full bg-red-500 rounded-full transition-all duration-500" style="width: 100%"></div>
      </div>
    </div>
  </div>
  
  <!-- 游戏容器 - 移动端添加顶部 padding 避免被固定面板遮挡 -->
  <div id="game-container" class="container mx-auto px-4 pt-24 pb-6 md:pt-6 flex-grow flex flex-col">
    
    <!-- 游戏标题 - 移动端缩小 -->
    <header class="text-center mb-4 md:mb-6">
      <div class="flex justify-center gap-2 mb-4">
        <button onclick="saveGame()" class="bg-primary/30 hover:bg-primary/50 px-3 py-1 rounded text-sm">
          <i class="fa fa-save mr-1"></i>保存
        </button>
        <button onclick="loadGame()" class="bg-secondary/30 hover:bg-secondary/50 px-3 py-1 rounded text-sm">
          <i class="fa fa-load mr-1"></i>加载
        </button>
      </div>
      <!-- <h1 class="text-[clamp(1.5rem,5vw,3rem)] font-bold text-accent text-shadow mb-1">深渊卡牌</h1>
      <p class="text-light/70 text-sm md:text-base">无限挑战 · 每一次都是新的冒险</p> -->
    </header>
    
    <!-- 状态面板 - 仅在桌面显示 -->
    <div class="hidden md:grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <!-- 玩家状态 -->
      <div class="bg-dark/50 rounded-xl p-4 border border-primary/30 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold flex items-center">
            <i class="fa fa-user-circle mr-2 text-secondary"></i>玩家
          </h2>
          <span class="bg-primary/20 px-2 py-1 rounded-full text-sm">等级 <span id="player-level">1</span></span>
        </div>
        
        <div class="flex gap-4">
          <div class="flex-1">
            <div class="text-sm text-light/70 mb-1">生命值</div>
            <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
              <div id="player-hp-bar" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 100%"></div>
            </div>
            <div class="text-right mt-1 text-sm">
              <span id="player-hp">100</span> / <span id="player-max-hp">100</span>
            </div>
          </div>
          
          <div class="flex-1">
            <div class="text-sm text-light/70 mb-1">经验值</div>
            <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
              <div id="player-exp-bar" class="h-full bg-accent rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="text-right mt-1 text-sm">
              <span id="player-exp">0</span> / <span id="player-next-level">100</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 敌人状态 -->
      <div class="bg-dark/50 rounded-xl p-4 border border-primary/30 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold flex items-center">
            <i class="fa fa-skull mr-2 text-red-500"></i><span id="enemy-name">初级魔物</span>
          </h2>
          <span class="bg-red-500/20 px-2 py-1 rounded-full text-sm">威胁度 <span id="enemy-threat">低</span></span>
        </div>
        
        <div>
          <div class="text-sm text-light/70 mb-1">生命值</div>
          <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
            <div id="enemy-hp-bar" class="h-full bg-red-500 rounded-full transition-all duration-500" style="width: 100%"></div>
          </div>
          <div class="text-right mt-1 text-sm">
            <span id="enemy-hp">50</span> / <span id="enemy-max-hp">50</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 装备面板 - 移动端缩小 -->
    <div class="mb-4 md:mb-6">
      <h2 class="text-lg md:text-xl font-bold mb-2 md:mb-3 flex items-center">
        <i class="fa fa-shield mr-2 text-accent"></i>装备
      </h2>
      <div id="equipment-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
        <!-- 武器 -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1">武器</div>
          <div id="weapon-slot" class="text-xs md:text-sm">无</div>
        </div>
        <!--  armor -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1"> armor</div>
          <div id="armor-slot" class="text-xs md:text-sm">无</div>
        </div>
        <!-- 饰品 -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1">饰品</div>
          <div id="trinket-slot" class="text-xs md:text-sm">无</div>
        </div>
        <!-- 戒指 -->
        <div class="bg-dark/40 rounded-lg p-2 md:p-3 border border-primary/20">
          <div class="text-xs md:text-sm text-light/70 mb-1">戒指</div>
          <div id="ring-slot" class="text-xs md:text-sm">无</div>
        </div>
      </div>
    </div>
    
    <!-- 战斗区域 - 压缩高度适应移动设备 -->
    <div class="flex-grow mb-4 md:mb-6 relative">
      <div id="battle-area" class="bg-dark/30 rounded-xl p-3 md:p-4 h-full min-h-[140px] md:min-h-[200px] flex flex-col items-center justify-center border border-primary/20">
        <div id="battle-message" class="text-center mb-3 md:mb-6 text-sm md:text-lg text-light/90"></div>
        
        <!-- 角色形象 - 缩小移动版尺寸 -->
        <div class="flex justify-around items-center w-full max-w-md mb-3 md:mb-6">
          <div class="text-center animate-float">
            <div class="w-16 h-16 md:w-20 md:h-20 bg-secondary/20 rounded-full flex items-center justify-center mb-1 md:mb-2 border-2 border-secondary">
              <i class="fa fa-user text-3xl md:text-4xl text-secondary"></i>
            </div>
            <div class="text-xs md:text-sm font-medium">玩家</div>
          </div>
          
          <div class="text-xl md:text-2xl">
            <i class="fa fa-exchange text-accent/70"></i>
          </div>
          
          <div class="text-center animate-float" style="animation-delay: 0.5s">
            <div id="enemy-sprite" class="w-16 h-16 md:w-20 md:h-20 bg-red-500/20 rounded-full flex items-center justify-center mb-1 md:mb-2 border-2 border-red-500">
              <i class="fa fa-asterisk text-3xl md:text-4xl text-red-500"></i>
            </div>
            <div class="text-xs md:text-sm font-medium" id="enemy-display-name">初级魔物</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 卡牌区域 - 改为水平滚动，方便手机操作 -->
    <div class="mb-4 md:mb-6">
      <h2 class="text-lg md:text-xl font-bold mb-2 md:mb-3 flex items-center">
        <i class="fa fa-th-large mr-2 text-accent"></i>你的卡牌
      </h2>
      <div class="relative">
        <div id="card-container" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide md:grid md:grid-cols-2 md:md:grid-cols-3 md:gap-4">
          <!-- 卡牌将通过JS动态生成 -->
        </div>
        <!-- 滚动指示器 -->
        <div class="hidden md:flex absolute -bottom-1 left-0 right-0 justify-center gap-1">
          <span class="w-2 h-2 rounded-full bg-primary/30"></span>
          <span class="w-2 h-2 rounded-full bg-primary/30"></span>
          <span class="w-2 h-2 rounded-full bg-primary/30"></span>
        </div>
      </div>
    </div>
    
    <!-- 卡牌合成提示 - 新增功能 -->
    <div id="card-fusion-hint" class="mb-4 bg-primary/20 border border-primary/40 rounded-lg p-3 hidden">
      <div class="flex items-start">
        <i class="fa fa-lightbulb-o text-accent mt-0.5 mr-2"></i>
        <div>
          <h3 class="font-bold text-sm">卡牌合成</h3>
          <p class="text-xs text-light/80">集齐3张相同卡牌可自动合成更高级的卡牌</p>
        </div>
      </div>
    </div>
    
    <!-- 技能列表 - 移动端改为可滚动 -->
    <div class="mb-4 md:mb-6">
      <h2 class="text-lg md:text-xl font-bold mb-2 md:mb-3 flex items-center">
        <i class="fa fa-star mr-2 text-secondary"></i>已学技能
      </h2>
      <div id="skills-container" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto scrollbar-hide pb-2">
        <div class="bg-gray-700/30 px-3 py-1 rounded-full text-sm">
          初始技能: 基础攻击
        </div>
      </div>
    </div>
  </div>
  
  <!-- 升级选择模态框 - 优化移动端尺寸 -->
  <div id="level-up-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-5 max-w-md w-full mx-4">
      <h2 class="text-xl md:text-2xl font-bold text-accent text-center mb-3 md:mb-4">升级了！</h2>
      <p class="text-center mb-4 md:mb-6 text-sm md:text-base">选择一项技能提升：</p>
      
      <div class="grid grid-cols-1 gap-3 md:gap-4">
        <div id="skill-option-1" class="skill-option bg-primary/20 hover:bg-primary/40 p-3 md:p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-1 md:mb-2">技能名称</h3>
          <p class="text-xs md:text-sm text-light/80">技能描述</p>
        </div>
        
        <div id="skill-option-2" class="skill-option bg-primary/20 hover:bg-primary/40 p-3 md:p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-1 md:mb-2">技能名称</h3>
          <p class="text-xs md:text-sm text-light/80">技能描述</p>
        </div>
        
        <div id="skill-option-3" class="skill-option bg-primary/20 hover:bg-primary/40 p-3 md:p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-1 md:mb-2">技能名称</h3>
          <p class="text-xs md:text-sm text-light/80">技能描述</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 卡牌升级提示 - 三合一功能 -->
  <div id="card-upgrade-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-5 max-w-md w-full mx-4 text-center">
      <div class="w-12 h-12 bg-accent/20 rounded-full flex items-center justify-center mx-auto mb-3">
        <i class="fa fa-arrow-circle-up text-2xl text-accent"></i>
      </div>
      <h2 class="text-xl md:text-2xl font-bold text-accent mb-3">卡牌升级！</h2>
      <div class="mb-5">
        <p class="text-sm">3张<span id="upgrade-from" class="text-blue-400 font-bold"></span>已合成为</p>
        <p class="mt-2 text-base md:text-xl"><span id="upgrade-to" class="text-yellow-400 font-bold card-upgraded px-2 py-1 rounded"></span></p>
      </div>
      <button id="upgrade-confirm" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover w-full">
        确认
      </button>
    </div>
  </div>
  
  <!-- 装备掉落模态框 -->
  <div id="loot-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-5 max-w-md w-full mx-4">
      <h2 class="text-xl md:text-2xl font-bold text-accent text-center mb-3 md:mb-4">获得战利品！</h2>
      <div id="loot-content" class="mb-4 md:mb-6">
        <!-- 战利品内容将动态生成 -->
      </div>
      <div class="flex gap-2">
        <button id="equip-button" class="flex-1 bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover">
          装备物品
        </button>
        <button id="discard-button" class="flex-1 bg-gray-600 hover:bg-gray-500 text-light font-bold py-2 px-6 rounded-full transition-all card-hover">
          丢弃
        </button>
      </div>
    </div>
  </div>
  
  <!-- 游戏结束模态框 -->
  <div id="game-over-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-red-500 rounded-xl p-5 max-w-md w-full mx-4 text-center">
      <h2 class="text-xl md:text-2xl font-bold text-red-500 mb-3 md:mb-4">游戏结束</h2>
      <p class="mb-2 text-sm md:text-base">你的冒险结束了</p>
      <p class="text-lg md:text-xl font-bold mb-5 md:mb-6">最终等级: <span id="final-level">1</span></p>
      <button id="restart-button" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover w-full">
        重新开始
      </button>
    </div>
  </div>
  
  <script>
    // 游戏状态
    const gameState = {
      player: {
        level: 1,
        hp: 100,
        maxHp: 100,
        exp: 0,
        nextLevelExp: 100,
        attack: 10,
        defense: 0,
        critChance: 5, // 百分比
        cards: [],
        cardCounts: {}, // 用于跟踪各类卡牌数量，实现升级
        skills: [
          { id: 'basic_attack', name: '基础攻击', description: '造成10点伤害' }
        ],
        equipment: {
          weapon: null,
          armor: null,
          trinket: null,
          ring: null
        }
      },
      enemy: {
        name: '初级魔物',
        displayName: '初级魔物',
        hp: 50,
        maxHp: 50,
        attack: 8,
        threat: '低',
        expReward: 50,
        sprite: 'fa-asterisk',
        lootChance: 30 // 掉落概率百分比
      },
      isPlayerTurn: true,
      isBattleActive: true,
      difficulty: 1,
      currentLoot: null,
      // 卡牌三合一相关配置
      cardFusion: {
        required: 3, // 需要3张相同卡牌才能合成
        shownHint: false // 是否已显示合成提示
      }
    };
    // 存档功能
    function saveGame() {
      try {
        localStorage.setItem('abyssCardsSave', JSON.stringify(gameState));
        showToast('游戏已保存');
      } catch (e) {
        showToast('保存失败');
      }
    }

    function loadGame() {
      const saved = localStorage.getItem('abyssCardsSave');
      if (saved) {
        const parsed = JSON.parse(saved);
        Object.assign(gameState, parsed);
        renderGame();
        showToast('已加载存档');
        return true;
      }
      showToast('无存档数据');
      return false;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-dark/80 text-light px-4 py-2 rounded-full backdrop-blur-sm z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    // 扩展卡牌数据库 - 新增多种类型卡牌
    const cardDatabase = [
      // 基础攻击类
      {
        id: 'basic_attack',
        name: '基础攻击',
        description: '对敌人造成基础伤害',
        color: 'bg-secondary/20',
        borderColor: 'border-secondary',
        icon: 'fa-hand-paper-o',
        damageMultiplier: 1,
        type: 'attack',
        upgradeTo: 'power_attack' // 基础攻击可升级为强力攻击
      },
      {
        id: 'power_attack',
        name: '强力攻击',
        description: '对敌人造成1.5倍基础伤害',
        color: 'bg-accent/20',
        borderColor: 'border-accent',
        icon: 'fa-hand-rock-o',
        damageMultiplier: 1.5,
        type: 'attack',
        upgradeTo: 'devastating_attack'
      },
      {
        id: 'piercing_attack',
        name: '穿刺攻击',
        description: '无视敌人2点防御，造成基础伤害',
        color: 'bg-indigo-500/20',
        borderColor: 'border-indigo-500',
        icon: 'fa-arrow-right',
        damageMultiplier: 1,
        ignoreDefense: 2,
        type: 'attack',
        upgradeTo: 'armor_break_attack'
      },
      {
        id: 'combo_attack',
        name: '连击',
        description: '连续攻击两次，每次造成60%伤害',
        color: 'bg-rose-500/20',
        borderColor: 'border-rose-500',
        icon: 'fa-repeat',
        damageMultiplier: 0.6,
        hitCount: 2,
        type: 'attack',
        upgradeTo: 'triple_attack'
      },
      {
        id: 'backstab',
        name: '背刺',
        description: '若敌人生命值高于70%，造成2倍伤害',
        color: 'bg-emerald-500/20',
        borderColor: 'border-emerald-500',
        icon: 'fa-street-view',
        damageMultiplier: 2,
        condition: 'high_hp',
        type: 'attack',
        upgradeTo: 'assassinate'
      },
      
      // // 防御类
      // {
      //   id: 'defend',
      //   name: '防御',
      //   description: '本回合减少50%受到的伤害',
      //   color: 'bg-blue-500/20',
      //   borderColor: 'border-blue-500',
      //   icon: 'fa-shield',
      //   defend: 0.5,
      //   type: 'defense',
      //   upgradeTo: 'fortify'
      // },
      {
        id: 'parry',
        name: '格挡',
        description: '有30%几率完全格挡一次攻击',
        color: 'bg-cyan-500/20',
        borderColor: 'border-cyan-500',
        icon: 'fa-ban',
        parryChance: 30,
        type: 'defense',
        upgradeTo: 'perfect_parry'
      },
      {
        id: 'dodge',
        name: '闪避',
        description: '本回合有40%几率闪避攻击',
        color: 'bg-teal-500/20',
        borderColor: 'border-teal-500',
        icon: 'fa-bolt',
        dodgeChance: 40,
        type: 'defense',
        upgradeTo: 'blink'
      },
      
      // 特殊效果类
      {
        id: 'sacrifice_attack',
        name: '献祭攻击',
        description: '消耗10点生命，造成2倍伤害',
        color: 'bg-red-600/20',
        borderColor: 'border-red-600',
        icon: 'fa-balance-scale',
        damageMultiplier: 2,
        healthCost: 10,
        type: 'special',
        upgradeTo: 'life_steal_attack'
      },
      {
        id: 'fireball',
        name: '火球术',
        description: '造成15点火焰伤害，有20%几率灼烧敌人',
        color: 'bg-orange-500/20',
        borderColor: 'border-orange-500',
        icon: 'fa-fire',
        damage: 15,
        burnChance: 20,
        type: 'magic',
        upgradeTo: 'flame_strike'
      },
      {
        id: 'frost_bolt',
        name: '寒冰箭',
        description: '造成12点伤害，有30%几率减缓敌人',
        color: 'bg-sky-500/20',
        borderColor: 'border-sky-500',
        icon: 'fa-snowflake-o',
        damage: 12,
        slowChance: 30,
        type: 'magic',
        upgradeTo: 'ice_lance'
      },
      {
        id: 'heal',
        name: '治愈',
        description: '恢复20点生命值',
        color: 'bg-green-500/20',
        borderColor: 'border-green-500',
        icon: 'fa-heart',
        heal: 20,
        type: 'support',
        upgradeTo: 'greater_heal'
      },
      {
        id: 'poison_sting',
        name: '毒刺',
        description: '使敌人中毒，每回合受到5点伤害，持续3回合',
        color: 'bg-green-600/20',
        borderColor: 'border-green-600',
        icon: 'fa-bug',
        applyPoison: 5,
        poisonDuration: 3,
        type: 'dot',
        upgradeTo: 'deadly_poison'
      },
      {
        id: 'whirlwind',
        name: '旋风斩',
        description: '对敌人造成两次50%伤害',
        color: 'bg-blue-500/20',
        borderColor: 'border-blue-500',
        icon: 'fa-sync',
        damageMultiplier: 0.5,
        hitCount: 2,
        type: 'attack',
        upgradeTo: 'tornado'
      },
      
      // 升级后的高级卡牌
      {
        id: 'fortify',
        name: '强化防御',
        description: '本回合减少70%受到的伤害，并恢复5点生命值',
        color: 'bg-blue-600/30',
        borderColor: 'border-blue-600',
        icon: 'fa-shield',
        defend: 0.3,
        heal: 5,
        type: 'defense',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'devastating_attack',
        name: '毁灭性攻击',
        description: '对敌人造成2倍基础伤害，有10%几率击晕敌人',
        color: 'bg-accent/30',
        borderColor: 'border-accent',
        icon: 'fa-hand-rock-o',
        damageMultiplier: 2,
        stunChance: 10,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'armor_break_attack',
        name: '破甲攻击',
        description: '无视敌人5点防御，造成1.2倍伤害',
        color: 'bg-indigo-600/30',
        borderColor: 'border-indigo-600',
        icon: 'fa-arrow-right',
        damageMultiplier: 1.2,
        ignoreDefense: 5,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'triple_attack',
        name: '三重打击',
        description: '连续攻击三次，每次造成60%伤害',
        color: 'bg-rose-600/30',
        borderColor: 'border-rose-600',
        icon: 'fa-repeat',
        damageMultiplier: 0.6,
        hitCount: 3,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'assassinate',
        name: '暗杀',
        description: '若敌人生命值高于50%，造成3倍伤害',
        color: 'bg-emerald-600/30',
        borderColor: 'border-emerald-600',
        icon: 'fa-street-view',
        damageMultiplier: 3,
        condition: 'medium_hp',
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'perfect_parry',
        name: '完美格挡',
        description: '有50%几率完全格挡一次攻击，并反击造成20%伤害',
        color: 'bg-cyan-600/30',
        borderColor: 'border-cyan-600',
        icon: 'fa-ban',
        parryChance: 50,
        counterDamage: 0.2,
        type: 'defense',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'blink',
        name: '闪现',
        description: '本回合有70%几率闪避攻击，并获得一次额外抽牌',
        color: 'bg-teal-600/30',
        borderColor: 'border-teal-600',
        icon: 'fa-bolt',
        dodgeChance: 70,
        drawCard: 1,
        type: 'defense',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'life_steal_attack',
        name: '生命偷取攻击',
        description: '消耗5点生命，造成2.5倍伤害，回复10点生命',
        color: 'bg-red-700/30',
        borderColor: 'border-red-700',
        icon: 'fa-balance-scale',
        damageMultiplier: 2.5,
        healthCost: 5,
        heal: 10,
        type: 'special',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'flame_strike',
        name: '烈焰打击',
        description: '造成25点火焰伤害，有50%几率灼烧敌人',
        color: 'bg-orange-600/30',
        borderColor: 'border-orange-600',
        icon: 'fa-fire',
        damage: 25,
        burnChance: 50,
        type: 'magic',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'ice_lance',
        name: '冰枪术',
        description: '造成20点伤害，有60%几率减缓敌人并使其下一回合伤害降低',
        color: 'bg-sky-600/30',
        borderColor: 'border-sky-600',
        icon: 'fa-snowflake-o',
        damage: 20,
        slowChance: 60,
        reduceDamage: 0.3,
        type: 'magic',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'greater_heal',
        name: '强效治愈',
        description: '恢复40点生命值，并获得2点临时防御',
        color: 'bg-green-600/30',
        borderColor: 'border-green-600',
        icon: 'fa-heart',
        heal: 40,
        tempDefense: 2,
        type: 'support',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'deadly_poison',
        name: '致命毒药',
        description: '使敌人中剧毒，每回合受到10点伤害，持续4回合',
        color: 'bg-green-700/30',
        borderColor: 'border-green-700',
        icon: 'fa-bug',
        applyPoison: 10,
        poisonDuration: 4,
        type: 'dot',
        isUpgraded: true,
        upgradeTo: null
      },
      {
        id: 'tornado',
        name: '龙卷风',
        description: '对敌人造成三次70%伤害',
        color: 'bg-blue-600/30',
        borderColor: 'border-blue-600',
        icon: 'fa-sync',
        damageMultiplier: 0.7,
        hitCount: 3,
        type: 'attack',
        isUpgraded: true,
        upgradeTo: null
      }
    ];
    
    // 技能数据库
    const skillDatabase = [
      { 
        id: 'strong_attack', 
        name: '强化攻击', 
        description: '攻击力提升5点',
        effect: (player) => { player.attack += 5; }
      },
      { 
        id: 'toughness', 
        name: '坚韧', 
        description: '最大生命值提升20点',
        effect: (player) => { 
          player.maxHp += 20;
        }
      },
      { 
        id: 'critical_strike', 
        name: '暴击精通', 
        description: '暴击几率提升5%，暴击伤害为1.5倍',
        effect: (player) => { player.critChance += 5; }
      },
      { 
        id: 'shield', 
        name: '防御姿态', 
        description: '获得5点防御力，减少受到的伤害',
        effect: (player) => { player.defense += 5; }
      },
      { 
        id: 'vampirism', 
        name: '吸血', 
        description: '攻击时恢复5点生命值',
        effect: (player) => { 
          if (!player.skills.some(s => s.id === 'vampirism_active')) {
            player.skills.push({ 
              id: 'vampirism_active', 
              name: '吸血', 
              description: '攻击时恢复5点生命值' 
            });
          }
        }
      },
      { 
        id: 'second_wind', 
        name: '二次攻击', 
        description: '获得一张"二次打击"卡牌',
        effect: (player) => { 
          addCardToPlayer({
            id: 'second_strike',
            name: '二次打击',
            description: '对敌人造成1.2倍普通攻击伤害',
            damageMultiplier: 1.2,
            color: 'bg-accent/20',
            borderColor: 'border-accent',
            icon: 'fa-repeat',
            type: 'attack',
            upgradeTo: null
          });
        }
      },
      { 
        id: 'card_mastery', 
        name: '卡牌精通', 
        description: '增加一张手牌上限',
        effect: (player) => { 
          player.maxCards = (player.maxCards || 5) + 1;
        }
      },
      { 
        id: 'upgrade_mastery', 
        name: '卡牌合成', 
        description: '两张相同卡牌即可合成升级',
        effect: (player) => { 
          gameState.cardFusion.required = 2;
          addSkillToPlayer({
            id: 'upgrade_mastery_active',
            name: '卡牌合成',
            description: '两张相同卡牌即可合成升级'
          });
        }
      },
      { 
        id: 'magic_affinity', 
        name: '魔法亲和', 
        description: '魔法卡牌效果提升20%',
        effect: (player) => { 
          addSkillToPlayer({
            id: 'magic_affinity_active',
            name: '魔法亲和',
            description: '魔法卡牌效果提升20%'
          });
        }
      },
      { 
        id: 'battle_trance', 
        name: '战斗专注', 
        description: '每使用3张攻击卡牌，获得一张随机攻击卡牌',
        effect: (player) => { 
          addSkillToPlayer({
            id: 'battle_trance_active',
            name: '战斗专注',
            description: '每使用3张攻击卡牌，获得一张随机攻击卡牌'
          });
          player.attackCardCounter = 0;
        }
      }
    ];
    
    // 随机技能生成函数
    function generateRandomSkill() {
      const baseEffects = [
        { type: 'attack', min: 3, max: 7, namePart: ['精准', '强力', '致命'] },
        { type: 'defense', min: 2, max: 5, namePart: ['坚固', '钢铁', '守护'] },
        { type: 'hp', min: 10, max: 30, namePart: ['活力', '生命', '体质'] },
        { type: 'crit', min: 3, max: 8, namePart: ['暴击', '致命', '精准'] }
      ];
      
      const modifiers = [
        { name: '初级', multiplier: 1 },
        { name: '中级', multiplier: 1.5 },
        { name: '高级', multiplier: 2 }
      ];
      
      const effectTypes = [
        { name: '提升', func: (stat, value) => stat + value },
        { name: '强化', func: (stat, value) => stat + Math.round(value * 1.2) },
        { name: '精通', func: (stat, value) => stat + Math.round(value * 1.5) }
      ];
      
      // 随机选择基础效果
      const base = baseEffects[Math.floor(Math.random() * baseEffects.length)];
      const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
      const effectType = effectTypes[Math.floor(Math.random() * effectTypes.length)];
      
      // 计算数值
      const value = Math.floor((Math.random() * (base.max - base.min + 1) + base.min) * modifier.multiplier);
      
      // 生成名称和描述
      const namePart = base.namePart[Math.floor(Math.random() * base.namePart.length)];
      const skillName = `${modifier.name}${namePart}${effectType.name}`;
      
      let description, effect;
      
      switch (base.type) {
        case 'attack':
          description = `攻击力提升${value}点`;
          effect = (player) => { player.attack = effectType.func(player.attack, value); };
          break;
        case 'defense':
          description = `防御力提升${value}点`;
          effect = (player) => { player.defense = effectType.func(player.defense, value); };
          break;
        case 'hp':
          description = `最大生命值提升${value}点`;
          effect = (player) => { player.maxHp = effectType.func(player.maxHp, value); };
          break;
        case 'crit':
          description = `暴击几率提升${value}%`;
          effect = (player) => { player.critChance = effectType.func(player.critChance, value); };
          break;
      }
      
      return {
        id: `random_${Date.now()}`,
        name: skillName,
        description: description,
        effect: effect,
        isRandom: true
      };
    }
    
    // 装备数据库
    const equipmentDatabase = [
      // 武器 - 增加攻击力
      {
        id: 'sword_1',
        name: '铁剑',
        type: 'weapon',
        bonus: { attack: 5 },
        rarity: 'common',
        description: '一把普通的铁剑，增加5点攻击力'
      },
      {
        id: 'axe_1',
        name: '战斧',
        type: 'weapon',
        bonus: { attack: 7, critChance: 2 },
        rarity: 'common',
        description: '沉重的战斧，增加7点攻击力和2%暴击率'
      },
      {
        id: 'dagger_1',
        name: '匕首',
        type: 'weapon',
        bonus: { attack: 3, critChance: 5 },
        rarity: 'common',
        description: '锋利的匕首，增加3点攻击力和5%暴击率'
      },
      {
        id: 'sword_2',
        name: '钢剑',
        type: 'weapon',
        bonus: { attack: 10 },
        rarity: 'rare',
        description: '精良的钢剑，增加10点攻击力'
      },
      {
        id: 'sword_3',
        name: '圣剑',
        type: 'weapon',
        bonus: { attack: 15, critChance: 5 },
        rarity: 'epic',
        description: '神圣的剑，增加15点攻击力和5%暴击率'
      },
      
      //  armor - 增加防御力和生命值
      {
        id: 'cloth_1',
        name: '布衣',
        type: 'armor',
        bonus: { defense: 2, maxHp: 10 },
        rarity: 'common',
        description: '简单的布衣，增加2点防御力和10点生命值'
      },
      {
        id: 'leather_1',
        name: '皮甲',
        type: 'armor',
        bonus: { defense: 4, maxHp: 20 },
        rarity: 'common',
        description: '坚韧的皮甲，增加4点防御力和20点生命值'
      },
      {
        id: 'iron_1',
        name: '铁甲',
        type: 'armor',
        bonus: { defense: 7, maxHp: 30 },
        rarity: 'rare',
        description: '坚固的铁甲，增加7点防御力和30点生命值'
      },
      {
        id: 'steel_1',
        name: '钢甲',
        type: 'armor',
        bonus: { defense: 10, maxHp: 50 },
        rarity: 'epic',
        description: '精良的钢甲，增加10点防御力和50点生命值'
      },
      
      // 饰品 - 增加各种属性
      {
        id: 'amulet_1',
        name: '铜项链',
        type: 'trinket',
        bonus: { maxHp: 15, critChance: 2 },
        rarity: 'common',
        description: '普通的铜项链，增加15点生命值和2%暴击率'
      },
      {
        id: 'amulet_2',
        name: '银项链',
        type: 'trinket',
        bonus: { maxHp: 30, critChance: 4 },
        rarity: 'rare',
        description: '精致的银项链，增加30点生命值和4%暴击率'
      },
      {
        id: 'ring_1',
        name: '铁戒指',
        type: 'ring',
        bonus: { attack: 2, defense: 2 },
        rarity: 'common',
        description: '普通的铁戒指，增加2点攻击力和2点防御力'
      },
      {
        id: 'ring_2',
        name: '银戒指',
        type: 'ring',
        bonus: { attack: 4, defense: 4, critChance: 2 },
        rarity: 'rare',
        description: '精致的银戒指，增加4点攻击力、4点防御力和2%暴击率'
      },
      {
        id: 'ring_3',
        name: '钻石戒指',
        type: 'ring',
        bonus: { attack: 7, defense: 7, critChance: 5 },
        rarity: 'epic',
        description: '华丽的钻石戒指，增加7点攻击力、7点防御力和5%暴击率'
      }
    ];
    
    // 敌人名称和类型数据库
    const enemyNameDatabase = {
      low: [
        '疯狂的老鼠', '堕落的学徒', '变异的甲虫', '愤怒的地精', '小型史莱姆',
        '哭泣的幽灵', '暴躁的野兔', '腐烂的骷髅', '醉酒的海盗', '迷路的恶魔'
      ],
      medium: [
        '暗影猎手', '深渊祭司', '钢铁守卫', '火焰法师', '冰霜巨人',
        '毒液蜘蛛', '亡灵战士', '风暴元素', '血月狼人', '诅咒骑士'
      ],
      high: [
        '毁灭使者', '末日守卫', '虚空行者', '死亡骑士', '地狱火魔',
        '暗影领主', '冰霜女王', '瘟疫使者', '混沌巫师', '灵魂收割者'
      ],
      extreme: [
        '深渊之主', '宇宙吞噬者', '末日审判者', '万魂之王', '炼狱焚魔',
        '暗影本源', '混沌之神', '永恒巫妖', '毁灭巨龙', '虚空造物'
      ]
    };
    
    // 敌人类型数据库 - 增加独特特性
    const enemyTypes = [
      // 低威胁敌人
      { 
        baseHp: 50, 
        baseAttack: 8, 
        exp: 50, 
        threat: '低', 
        sprite: 'fa-asterisk', 
        names: enemyNameDatabase.low,
        type: 'basic',
        ability: null
      },
      { 
        baseHp: 60, 
        baseAttack: 6, 
        exp: 55, 
        threat: '低', 
        sprite: 'fa-shield', 
        names: ['小石魔', '岩石守卫', '石肤怪', '地元素'],
        type: 'stone',
        ability: 'highDefense', // 高防御
        defense: 4 // 额外防御
      },
      { 
        baseHp: 40, 
        baseAttack: 10, 
        exp: 55, 
        threat: '低', 
        sprite: 'fa-heartbeat', 
        names: ['小吸血鬼', '吸血蝙蝠', '血虫'],
        type: 'vampire',
        ability: 'vampirism', // 吸血
        vampirismRate: 0.3 // 吸血比例
      },
      
      // 中威胁敌人
      { 
        baseHp: 80, 
        baseAttack: 12, 
        exp: 80, 
        threat: '中', 
        sprite: 'fa-moon-o', 
        names: enemyNameDatabase.medium,
        type: 'medium',
        ability: null
      },
      { 
        baseHp: 100, 
        baseAttack: 10, 
        exp: 85, 
        threat: '中', 
        sprite: 'fa-paw', 
        names: ['森林狼人', '血月狼人', '狼人战士'],
        type: 'werewolf',
        ability: 'vampirism', // 吸血
        vampirismRate: 0.4 // 吸血比例
      },
      { 
        baseHp: 70, 
        baseAttack: 15, 
        exp: 85, 
        threat: '中', 
        sprite: 'fa-bolt', 
        names: ['闪电法师', '风暴巫师', '雷霆术士'],
        type: 'mage',
        ability: 'spellDamage', // 魔法伤害，无视防御
        isMagicDamage: true
      },
      
      // 高威胁敌人
      { 
        baseHp: 120, 
        baseAttack: 16, 
        exp: 120, 
        threat: '高', 
        sprite: 'fa-shield', 
        names: enemyNameDatabase.high,
        type: 'high',
        ability: null
      },
      { 
        baseHp: 150, 
        baseAttack: 12, 
        exp: 130, 
        threat: '高', 
        sprite: 'fa-shield', 
        names: ['石巨人', '熔岩守卫', '泰坦石像'],
        type: 'stoneGiant',
        ability: 'highDefense', // 高防御
        defense: 8 // 额外防御
      },
      { 
        baseHp: 100, 
        baseAttack: 20, 
        exp: 130, 
        threat: '高', 
        sprite: 'fa-dagger', 
        names: ['影刺客', '暗夜杀手', '致命盗贼'],
        type: 'assassin',
        ability: 'highCrit', // 高暴击
        critChance: 30 // 暴击率
      },
      { 
        baseHp: 120, 
        baseAttack: 15, 
        exp: 130, 
        threat: '高', 
        sprite: 'fa-plus-circle', 
        names: ['生命祭司', '神圣医师', '治疗恶魔'],
        type: 'healer',
        ability: 'selfHeal', // 自我治疗
        healAmount: 15, // 每次治疗量
        healFrequency: 3 // 每3回合治疗一次
      },
      
      // 极高威胁敌人（BOSS）
      { 
        baseHp: 200, 
        baseAttack: 25, 
        exp: 200, 
        threat: '极高', 
        sprite: 'fa-fire', 
        names: enemyNameDatabase.extreme,
        type: 'extreme',
        ability: null
      },
      { 
        baseHp: 250, 
        baseAttack: 20, 
        exp: 220, 
        threat: '极高', 
        sprite: 'fa-shield', 
        names: ['远古石魔', '大地守护者', '岩石泰坦'],
        type: 'ancientStone',
        ability: 'highDefense', // 高防御
        defense: 12, // 额外防御
        passive: 'damageReturn', // 反弹伤害
        damageReturnRate: 0.2 // 反弹20%伤害
      },
      { 
        baseHp: 180, 
        baseAttack: 30, 
        exp: 220, 
        threat: '极高', 
        sprite: 'fa-heartbeat', 
        names: ['吸血鬼伯爵', '血之领主', '不朽吸血鬼'],
        type: 'vampireLord',
        ability: 'vampirism', // 吸血
        vampirismRate: 0.5, // 吸血比例
        passive: 'lifeStealAura', // 生命偷取光环
        auraDamage: 5 // 每回合对玩家造成固定伤害并吸血
      },
      { 
        baseHp: 220, 
        baseAttack: 25, 
        exp: 220, 
        threat: '极高', 
        sprite: 'fa-star', 
        names: ['元素掌控者', '魔法之王', '奥术主宰'],
        type: 'archMage',
        ability: 'spellDamage', // 魔法伤害
        isMagicDamage: true,
        passive: 'manaShield', // 魔法护盾
        shieldStrength: 20 // 护盾值
      }
    ];
    
    // DOM元素 - 新增移动端血条元素
    const elements = {
      // 移动端元素
      playerLevelMobile: document.getElementById('player-level-mobile'),
      playerHpMobile: document.getElementById('player-hp-mobile'),
      playerMaxHpMobile: document.getElementById('player-max-hp-mobile'),
      playerHpBarMobile: document.getElementById('player-hp-bar-mobile'),
      enemyNameMobile: document.getElementById('enemy-name-mobile'),
      enemyHpMobile: document.getElementById('enemy-hp-mobile'),
      enemyMaxHpMobile: document.getElementById('enemy-max-hp-mobile'),
      enemyHpBarMobile: document.getElementById('enemy-hp-bar-mobile'),
      
      // 桌面端元素
      playerLevel: document.getElementById('player-level'),
      playerHp: document.getElementById('player-hp'),
      playerMaxHp: document.getElementById('player-max-hp'),
      playerHpBar: document.getElementById('player-hp-bar'),
      playerExp: document.getElementById('player-exp'),
      playerNextLevel: document.getElementById('player-next-level'),
      playerExpBar: document.getElementById('player-exp-bar'),
      
      enemyName: document.getElementById('enemy-name'),
      enemyDisplayName: document.getElementById('enemy-display-name'),
      enemyHp: document.getElementById('enemy-hp'),
      enemyMaxHp: document.getElementById('enemy-max-hp'),
      enemyHpBar: document.getElementById('enemy-hp-bar'),
      enemyThreat: document.getElementById('enemy-threat'),
      enemySprite: document.getElementById('enemy-sprite'),
      
      battleMessage: document.getElementById('battle-message'),
      cardContainer: document.getElementById('card-container'),
      skillsContainer: document.getElementById('skills-container'),
      cardFusionHint: document.getElementById('card-fusion-hint'),
      
      // 装备槽
      weaponSlot: document.getElementById('weapon-slot'),
      armorSlot: document.getElementById('armor-slot'),
      trinketSlot: document.getElementById('trinket-slot'),
      ringSlot: document.getElementById('ring-slot'),
      
      levelUpModal: document.getElementById('level-up-modal'),
      skillOptions: [
        document.getElementById('skill-option-1'),
        document.getElementById('skill-option-2'),
        document.getElementById('skill-option-3')
      ],
      
      // 卡牌升级模态框
      cardUpgradeModal: document.getElementById('card-upgrade-modal'),
      upgradeFrom: document.getElementById('upgrade-from'),
      upgradeTo: document.getElementById('upgrade-to'),
      upgradeConfirm: document.getElementById('upgrade-confirm'),
      
      lootModal: document.getElementById('loot-modal'),
      lootContent: document.getElementById('loot-content'),
      equipButton: document.getElementById('equip-button'),
      
      gameOverModal: document.getElementById('game-over-modal'),
      finalLevel: document.getElementById('final-level'),
      restartButton: document.getElementById('restart-button')
    };
    
    // 初始化游戏
    function initGame() {
      // 添加到initGame()函数中
      document.getElementById('discard-button').addEventListener('click', () => {
        elements.lootModal.classList.add('hidden');
        gameState.currentLoot = null;
        
        if (gameState.player.exp >= gameState.player.nextLevelExp) {
          checkLevelUp();
        } else {
          setTimeout(spawnNewEnemy, 1000);
        }
      });
      // 初始化玩家卡牌
      gameState.player.cards = [
        cardDatabase.find(card => card.id === 'basic_attack'),
        cardDatabase.find(card => card.id === 'basic_attack'),
        cardDatabase.find(card => card.id === 'defend')
      ].filter(Boolean); // 过滤掉undefined的卡牌
      
      // 初始化卡牌计数
      gameState.player.cardCounts = {};
      gameState.player.cards.forEach(card => {
        if (card && card.id) { // 安全检查
          incrementCardCount(card.id);
        }
      });
      
      // 初始化装备为空
      gameState.player.equipment = {
        weapon: null,
        armor: null,
        trinket: null,
        ring: null
      };
      
      // 显示卡牌合成提示
      setTimeout(() => {
        if (!gameState.cardFusion.shownHint) {
          elements.cardFusionHint.classList.remove('hidden');
          gameState.cardFusion.shownHint = true;
          
          // 3秒后自动隐藏提示
          setTimeout(() => {
            elements.cardFusionHint.classList.add('hidden');
          }, 5000);
        }
      }, 3000);
      
      // 渲染游戏状态
      renderGame();
      
      // 添加事件监听
      elements.restartButton.addEventListener('click', restartGame);
      elements.equipButton.addEventListener('click', equipLoot);
      elements.upgradeConfirm.addEventListener('click', () => {
        elements.cardUpgradeModal.classList.add('hidden');
        checkForCardUpgrades(); // 检查是否还有可升级的卡牌
      });
    }
    
    // 渲染游戏
    function renderGame() {
      renderPlayerStats();
      renderEnemyStats();
      renderCards();
      renderSkills();
      renderEquipment();
    }
    
    // 渲染玩家状态 - 同时更新移动端和桌面端
    function renderPlayerStats() {
      // 更新桌面端
      elements.playerLevel.textContent = gameState.player.level;
      elements.playerHp.textContent = gameState.player.hp;
      elements.playerMaxHp.textContent = gameState.player.maxHp;
      elements.playerHpBar.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
      
      elements.playerExp.textContent = gameState.player.exp;
      elements.playerNextLevel.textContent = gameState.player.nextLevelExp;
      elements.playerExpBar.style.width = `${(gameState.player.exp / gameState.player.nextLevelExp) * 100}%`;
      
      // 更新移动端
      elements.playerLevelMobile.textContent = gameState.player.level;
      elements.playerHpMobile.textContent = gameState.player.hp;
      elements.playerMaxHpMobile.textContent = gameState.player.maxHp;
      elements.playerHpBarMobile.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
      
      // 移动端血条颜色变化
      if (gameState.player.hp / gameState.player.maxHp < 0.3) {
        elements.playerHpBarMobile.classList.remove('bg-green-500');
        elements.playerHpBarMobile.classList.add('bg-red-500');
      } else {
        elements.playerHpBarMobile.classList.remove('bg-red-500');
        elements.playerHpBarMobile.classList.add('bg-green-500');
      }
    }
    
    // 渲染敌人状态 - 同时更新移动端和桌面端
    function renderEnemyStats() {
      // 更新桌面端
      elements.enemyName.textContent = gameState.enemy.name;
      elements.enemyDisplayName.textContent = gameState.enemy.displayName;
      elements.enemyHp.textContent = gameState.enemy.hp;
      elements.enemyMaxHp.textContent = gameState.enemy.maxHp;
      elements.enemyHpBar.style.width = `${(gameState.enemy.hp / gameState.enemy.maxHp) * 100}%`;
      elements.enemyThreat.textContent = gameState.enemy.threat;
      
      // 更新敌人图标
      elements.enemySprite.innerHTML = `<i class="fa ${gameState.enemy.sprite} text-3xl md:text-4xl text-red-500"></i>`;
      
      // 更新移动端
      elements.enemyNameMobile.textContent = gameState.enemy.name;
      elements.enemyHpMobile.textContent = gameState.enemy.hp;
      elements.enemyMaxHpMobile.textContent = gameState.enemy.maxHp;
      elements.enemyHpBarMobile.style.width = `${(gameState.enemy.hp / gameState.enemy.maxHp) * 100}%`;
    }
    
    // 渲染卡牌 - 优化移动端显示
    function renderCards() {
      elements.cardContainer.innerHTML = '';
      
      gameState.player.cards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        // 移动端卡牌固定宽度，桌面端自适应
        const cardClass = `min-w-[140px] ${card.color} ${card.borderColor} border rounded-xl p-3 md:p-4 card-hover cursor-pointer ${card.isUpgraded ? 'card-upgraded' : ''}`;
        cardElement.className = cardClass;
        cardElement.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-base">${card.name}${card.isUpgraded ? '+' : ''}</h3>
            <i class="fa ${card.icon} text-lg"></i>
          </div>
          <p class="text-xs md:text-sm text-light/80">${card.description}</p>
        `;
        
        // 增加触摸区域大小
        cardElement.style.touchAction = 'manipulation';
        cardElement.addEventListener('click', () => useCard(index));
        elements.cardContainer.appendChild(cardElement);
      });
      
      // 移动端自动滚动到第一张卡牌
      if (window.innerWidth < 768) {
        elements.cardContainer.scrollLeft = 0;
      }
    }
    
    // 渲染技能
    function renderSkills() {
      elements.skillsContainer.innerHTML = '';
      
      gameState.player.skills.forEach(skill => {
        const skillElement = document.createElement('div');
        skillElement.className = 'bg-primary/20 px-3 py-1 rounded-full text-xs md:text-sm whitespace-nowrap';
        skillElement.textContent = `${skill.name}: ${skill.description}`;
        elements.skillsContainer.appendChild(skillElement);
      });
    }
    
    // 渲染装备
    function renderEquipment() {
      const equipment = gameState.player.equipment;
      
      elements.weaponSlot.textContent = equipment.weapon ? 
        `${equipment.weapon.name} (攻击+${equipment.weapon.bonus.attack || 0})` : '无';
        
      elements.armorSlot.textContent = equipment.armor ? 
        `${equipment.armor.name} (防御+${equipment.armor.bonus.defense || 0})` : '无';
        
      elements.trinketSlot.textContent = equipment.trinket ? 
        `${equipment.trinket.name} (生命+${equipment.trinket.bonus.maxHp || 0})` : '无';
        
      elements.ringSlot.textContent = equipment.ring ? 
        `${equipment.ring.name} (攻击+${equipment.ring.bonus.attack || 0}, 防御+${equipment.ring.bonus.defense || 0})` : '无';
    }
    
    // 使用卡牌
    function useCard(index) {
      if (!gameState.isPlayerTurn || !gameState.isBattleActive) return;
      
      const card = gameState.player.cards[index];
      let message = '';
      let hasUsedCard = false;
      
      // 处理卡牌效果
      if (card.damage || card.damageMultiplier) {
        hasUsedCard = true;
        // 计算基础攻击力（包括装备加成）
        let baseAttack = gameState.player.attack;
        if (gameState.player.equipment.weapon && gameState.player.equipment.weapon.bonus.attack) {
          baseAttack += gameState.player.equipment.weapon.bonus.attack;
        }
        if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.attack) {
          baseAttack += gameState.player.equipment.ring.bonus.attack;
        }
        
        // 狂怒效果
        const hasFrenzy = gameState.player.skills.some(skill => skill.id === 'frenzy_active');
        if (hasFrenzy && gameState.player.hp / gameState.player.maxHp < 0.3) {
          baseAttack = Math.round(baseAttack * 1.2);
          message += '狂怒激活！攻击力提升！';
        }
        
        // 魔法亲和效果
        const hasMagicAffinity = gameState.player.skills.some(skill => skill.id === 'magic_affinity_active');
        if (hasMagicAffinity && card.type === 'magic') {
          baseAttack = Math.round(baseAttack * 1.2);
          message += '魔法亲和增强了效果！';
        }
        
        // 计算伤害
        let damage = card.damage || Math.round(baseAttack * (card.damageMultiplier || 1));
        
        // 处理破甲效果和敌人防御特性
        let effectiveDefense = gameState.enemy.defense || 0;
        
        // 检查敌人是否有特殊防御能力
        if (gameState.enemy.ability === 'highDefense' && gameState.enemy.defenseMultiplier) {
          effectiveDefense = Math.round(effectiveDefense * gameState.enemy.defenseMultiplier);
        }
        
        // 处理破甲效果
        if (card.ignoreDefense) {
          effectiveDefense = Math.max(0, effectiveDefense - card.ignoreDefense);
        }
        
        // 计算伤害（考虑防御）
        damage = Math.max(1, damage - effectiveDefense);
        
        // 检查条件伤害（如背刺）
        if (card.condition === 'high_hp' && gameState.enemy.hp / gameState.enemy.maxHp < 0.7) {
          damage = Math.round(damage / card.damageMultiplier); // 移除倍率
          message += '敌人生命值不足，无法发挥全部威力！';
        }
        if (card.condition === 'medium_hp' && gameState.enemy.hp / gameState.enemy.maxHp < 0.5) {
          damage = Math.round(damage / 3); // 移除暗杀的3倍倍率
          message += '敌人生命值过低，暗杀效果减弱！';
        }
        
        // 检查暴击（包括装备加成）
        let critChance = gameState.player.critChance;
        if (gameState.player.equipment.weapon && gameState.player.equipment.weapon.bonus.critChance) {
          critChance += gameState.player.equipment.weapon.bonus.critChance;
        }
        if (gameState.player.equipment.trinket && gameState.player.equipment.trinket.bonus.critChance) {
          critChance += gameState.player.equipment.trinket.bonus.critChance;
        }
        if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.critChance) {
          critChance += gameState.player.equipment.ring.bonus.critChance;
        }
        
        const isCrit = Math.random() * 100 < critChance;
        if (isCrit) {
          damage = Math.round(damage * 1.5);
          message += `你使用了${card.name}，造成了${damage}点暴击伤害！`;
        } else {
          message += `你使用了${card.name}，造成了${damage}点伤害！`;
        }
        
        // 处理多段攻击
        const hitCount = card.hitCount || 1;
        if (hitCount > 1) {
          damage *= hitCount;
          message = message.replace(`造成了${damage/hitCount}`, `造成了${hitCount}次${damage/hitCount}，总计${damage}`);
        }
        
        // 处理魔法护盾
        let damageToEnemy = damage;
        let damageToShield = 0;
        
        if (gameState.enemy.passive === 'manaShield' && gameState.enemy.shieldStrength > 0) {
          damageToShield = Math.min(damage, gameState.enemy.shieldStrength);
          gameState.enemy.shieldStrength -= damageToShield;
          damageToEnemy -= damageToShield;
          message += ` 魔法护盾吸收了${damageToShield}点伤害！`;
        }
        
        // 应用剩余伤害到敌人
        if (damageToEnemy > 0) {
          gameState.enemy.hp -= damageToEnemy;
          if (gameState.enemy.hp < 0) gameState.enemy.hp = 0;
        }
        
        // 处理反弹伤害（荆棘光环）
        if (gameState.enemy.passive === 'thorns' && damageToEnemy > 0 && gameState.enemy.thornsDamage > 0) {
          const thornsDamage = Math.round(damageToEnemy * gameState.enemy.thornsDamage);
          gameState.player.hp = Math.max(0, gameState.player.hp - thornsDamage);
          message += ` ${gameState.enemy.displayName}的荆棘光环对你造成了${thornsDamage}点伤害！`;
          
          // 检查玩家是否死亡
          if (gameState.player.hp <= 0) {
            gameState.player.hp = 0;
            renderPlayerStats();
            handleGameOver();
            return;
          }
        }
        
        // 处理击晕效果
        if (card.stunChance && Math.random() * 100 < card.stunChance) {
          gameState.enemy.stunned = true;
          message += ` 敌人被击晕了，下一回合无法行动！`;
        }
        
        // 处理灼烧效果
        if (card.burnChance && Math.random() * 100 < card.burnChance) {
          gameState.enemy.burn = {
            damage: 5,
            duration: 2
          };
          message += ` 敌人被灼烧，每回合受到5点伤害！`;
        }
        
        // 检查吸血效果
        const hasVampirism = gameState.player.skills.some(skill => skill.id === 'vampirism_active');
        if (hasVampirism) {
          const healAmount = Math.min(5 * hitCount, gameState.player.maxHp - gameState.player.hp);
          gameState.player.hp += healAmount;
          message += ` 你吸取了${healAmount}点生命值！`;
        }
        
        // 处理献祭攻击的生命消耗
        if (card.healthCost) {
          gameState.player.hp = Math.max(1, gameState.player.hp - card.healthCost);
          message += ` 你消耗了${card.healthCost}点生命值！`;
        }
        
        // 处理生命偷取
        if (card.heal) {
          const actualHeal = Math.min(card.heal, gameState.player.maxHp - gameState.player.hp);
          gameState.player.hp += actualHeal;
          message += ` 你恢复了${actualHeal}点生命值！`;
        }
        
        // 战斗专注计数
        if (gameState.player.skills.some(skill => skill.id === 'battle_trance_active')) {
          gameState.player.attackCardCounter = (gameState.player.attackCardCounter || 0) + 1;
          if (gameState.player.attackCardCounter >= 3) {
            // 获得随机攻击卡牌
            const attackCards = cardDatabase.filter(c => c.type === 'attack' && !c.isUpgraded);
            const randomCard = attackCards[Math.floor(Math.random() * attackCards.length)];
            addCardToPlayer({...randomCard});
            message += ` 战斗专注激活，获得了${randomCard.name}！`;
            gameState.player.attackCardCounter = 0;
          }
        }
      } else if (card.heal) {
        hasUsedCard = true;
        // 治疗效果
        const actualHeal = Math.min(card.heal, gameState.player.maxHp - gameState.player.hp);
        gameState.player.hp += actualHeal;
        message = `你使用了${card.name}，恢复了${actualHeal}点生命值！`;
        
        // 临时防御
        if (card.tempDefense) {
          gameState.player.tempDefense += card.tempDefense;
          message += ` 获得了${card.tempDefense}点临时防御！`;
        }
      } else if (card.defend || card.parryChance || card.dodgeChance) {
        hasUsedCard = true;
        if (card.defend) {
          // 防御效果
          gameState.player.tempDefense = (gameState.player.defense * card.defend) || card.defend;
          message = `你使用了${card.name}，本回合减少${Math.round((1 - card.defend) * 100)}%受到的伤害！`;
        } else if (card.parryChance) {
          // 格挡效果
          gameState.player.parryChance = card.parryChance;
          gameState.player.counterDamage = card.counterDamage || 0;
          message = `你使用了${card.name}，有${card.parryChance}%几率完全格挡攻击！`;
        } else if (card.dodgeChance) {
          // 闪避效果
          gameState.player.dodgeChance = card.dodgeChance;
          message = `你使用了${card.name}，有${card.dodgeChance}%几率闪避攻击！`;
        }
        
        // 治疗效果（如强化防御）
        if (card.heal) {
          const actualHeal = Math.min(card.heal, gameState.player.maxHp - gameState.player.hp);
          gameState.player.hp += actualHeal;
          message += ` 同时恢复了${actualHeal}点生命值！`;
        }
      } else if (card.applyPoison) {
        hasUsedCard = true;
        // 毒效果
        gameState.enemy.poison = {
          damage: card.applyPoison,
          duration: card.poisonDuration
        };
        message = `你使用了${card.name}，使敌人中毒，每回合受到${card.applyPoison}点伤害，持续${card.poisonDuration}回合！`;
      }
      
      if (hasUsedCard) {
        // 记录卡牌ID用于计数更新
        const cardId = card.id;
        
        // 移除已使用的卡牌
        gameState.player.cards.splice(index, 1);
        
        // 更新卡牌计数
        decrementCardCount(cardId);
        
        // 更新战斗信息
        elements.battleMessage.textContent = message;
        
        // 重新渲染
        renderPlayerStats();
        renderEnemyStats();
        renderCards();
        
        // 检查敌人是否死亡
        if (gameState.enemy.hp <= 0) {
          handleEnemyDeath();
          return;
        }
        
        // 切换到敌人回合
        gameState.isPlayerTurn = false;
        setTimeout(enemyTurn, 1500);
      }
    }
    
    // 敌人回合
    function enemyTurn() {
      if (gameState.isPlayerTurn || !gameState.isBattleActive) return;
      
      // 增加敌人回合计数
      gameState.enemy.turnCount = (gameState.enemy.turnCount || 0) + 1;
      
      // 检查是否被击晕
      if (gameState.enemy.stunned) {
        elements.battleMessage.textContent = `${gameState.enemy.displayName}被击晕了，无法行动！`;
        gameState.enemy.stunned = false;
        
        // 抽牌补充手牌
        drawNewCards();
        
        // 切换回玩家回合
        gameState.isPlayerTurn = true;
        return;
      }
      
      // 处理生命偷取光环（被动）
      if (gameState.enemy.passive === 'lifeStealAura' && gameState.enemy.auraDamage > 0) {
        const auraDamage = gameState.enemy.auraDamage;
        gameState.player.hp = Math.max(0, gameState.player.hp - auraDamage);
        gameState.enemy.hp = Math.min(gameState.enemy.hp + auraDamage, gameState.enemy.maxHp);
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}的生命吸取光环对你造成了${auraDamage}点伤害，并恢复了${auraDamage}点生命值！`;
        
        renderPlayerStats();
        renderEnemyStats();
        
        // 检查玩家是否死亡
        if (gameState.player.hp <= 0) {
          gameState.player.hp = 0;
          renderPlayerStats();
          handleGameOver();
          return;
        }
        
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      // 处理自我治疗能力
      if (gameState.enemy.ability === 'selfHeal' && 
          gameState.enemy.healAmount > 0 && 
          gameState.enemy.healFrequency && 
          gameState.enemy.turnCount % gameState.enemy.healFrequency === 0) {
        const healAmount = gameState.enemy.healAmount;
        gameState.enemy.hp = Math.min(gameState.enemy.hp + healAmount, gameState.enemy.maxHp);
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}使用了自我治疗，恢复了${healAmount}点生命值！`;
        
        renderEnemyStats();
        
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      // 处理中毒效果
      if (gameState.enemy.poison && gameState.enemy.poison.duration > 0) {
        gameState.enemy.hp -= gameState.enemy.poison.damage;
        gameState.enemy.poison.duration -= 1;
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}受到${gameState.enemy.poison.damage}点毒素伤害！`;
        
        if (gameState.enemy.hp <= 0) {
          gameState.enemy.hp = 0;
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
        
        renderEnemyStats();
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      // 处理灼烧效果
      if (gameState.enemy.burn && gameState.enemy.burn.duration > 0) {
        gameState.enemy.hp -= gameState.enemy.burn.damage;
        gameState.enemy.burn.duration -= 1;
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}受到${gameState.enemy.burn.damage}点灼烧伤害！`;
        
        if (gameState.enemy.hp <= 0) {
          gameState.enemy.hp = 0;
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
        
        renderEnemyStats();
        setTimeout(() => {
          processNextEnemyAction();
        }, 1000);
        return;
      }
      
      processNextEnemyAction();
    }
    
    // 处理敌人下一个动作（攻击前的逻辑）
    function processNextEnemyAction() {
      // 继续处理敌人的主要攻击
      continueEnemyTurn();
    }
    
    // 继续敌人回合（处理攻击）
    function continueEnemyTurn() {
      // 检查闪避
      if (gameState.player.dodgeChance && Math.random() * 100 < gameState.player.dodgeChance) {
        elements.battleMessage.textContent = `你成功闪避了${gameState.enemy.displayName}的攻击！`;
        
        // 闪现的额外抽牌
        const hasBlink = gameState.player.cards.some(c => c.id === 'blink' && c.drawCard);
        if (hasBlink) {
          drawNewCards(1); // 额外抽1张牌
          elements.battleMessage.textContent += ` 闪现使你获得了一张额外卡牌！`;
        }
        
        // 重置闪避几率
        gameState.player.dodgeChance = 0;
        
        // 抽牌补充手牌
        drawNewCards();
        
        // 切换回玩家回合
        gameState.isPlayerTurn = true;
        return;
      }
      
      // 检查格挡
      if (gameState.player.parryChance && Math.random() * 100 < gameState.player.parryChance) {
        let message = `你成功格挡了${gameState.enemy.displayName}的攻击！`;
        
        // 处理反击伤害（考虑魔法护盾）
        if (gameState.player.counterDamage > 0) {
          let counterDamage = Math.round(gameState.player.attack * gameState.player.counterDamage);
          
          // 检查魔法护盾
          if (gameState.enemy.passive === 'manaShield' && gameState.enemy.shieldStrength > 0) {
            const damageToShield = Math.min(counterDamage, gameState.enemy.shieldStrength);
            gameState.enemy.shieldStrength -= damageToShield;
            counterDamage -= damageToShield;
            message += ` 魔法护盾吸收了${damageToShield}点伤害！`;
          }
          
          // 对敌人造成剩余伤害
          if (counterDamage > 0) {
            gameState.enemy.hp = Math.max(0, gameState.enemy.hp - counterDamage);
            message += ` 反击造成了${counterDamage}点伤害！`;
          }
          
          // 检查敌人是否因反击死亡
          if (gameState.enemy.hp <= 0) {
            renderEnemyStats();
            elements.battleMessage.textContent = message;
            handleEnemyDeath();
            return;
          }
        }
        
        // 重置格挡几率和反击伤害
        gameState.player.parryChance = 0;
        gameState.player.counterDamage = 0;
        
        elements.battleMessage.textContent = message;
        renderEnemyStats();
        
        // 抽牌补充手牌
        drawNewCards();
        
        // 切换回玩家回合
        gameState.isPlayerTurn = true;
        return;
      }
      
      // 计算玩家总防御（包括装备）
      let totalDefense = gameState.player.defense;
      if (gameState.player.equipment.armor && gameState.player.equipment.armor.bonus.defense) {
        totalDefense += gameState.player.equipment.armor.bonus.defense;
      }
      if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.defense) {
        totalDefense += gameState.player.equipment.ring.bonus.defense;
      }
      
      // 计算基础伤害
      let damage = gameState.enemy.attack;
      
      // 处理暴击（刺客特性）
      if (gameState.enemy.ability === 'highCrit' && gameState.enemy.critChance && Math.random() * 100 < gameState.enemy.critChance) {
        damage = Math.round(damage * 1.5); // 50%暴击伤害加成
        elements.battleMessage.textContent = `${gameState.enemy.displayName}对你发动了暴击！`;
      }
      
      // 处理魔法伤害（法师特性）
      if (gameState.enemy.ability === 'spellDamage' && gameState.enemy.isMagicDamage) {
        // 魔法伤害无视防御，但仍然可以被临时防御减免
        elements.battleMessage.textContent = `${gameState.enemy.displayName}对你造成了${damage}点魔法伤害！`;
      } else {
        // 物理伤害考虑防御
        damage = damage - totalDefense;
        elements.battleMessage.textContent = `${gameState.enemy.displayName}对你造成了${damage}点伤害！`;
      }
      
      // 应用临时防御
      if (gameState.player.tempDefense) {
        damage = Math.round(damage * gameState.player.tempDefense);
        gameState.player.tempDefense = 0; // 重置临时防御
      }
      
      // 确保伤害不为负
      damage = Math.max(1, damage);
      
      // 应用伤害
      gameState.player.hp -= damage;
      
      // 处理吸血特性
      if (gameState.enemy.ability === 'vampirism' && gameState.enemy.vampirismRate) {
        const healAmount = Math.round(damage * gameState.enemy.vampirismRate);
        gameState.enemy.hp = Math.min(gameState.enemy.hp + healAmount, gameState.enemy.maxHp);
        elements.battleMessage.textContent += ` ${gameState.enemy.displayName}吸取了${healAmount}点生命值！`;
        renderEnemyStats();
      }
      
      // 检查反击效果
      const hasCounterAttack = gameState.player.skills.some(skill => skill.id === 'counter_attack_active');
      if (hasCounterAttack && Math.random() * 100 < 30) {
        let counterDamage = Math.round(gameState.player.attack * 0.5);
        
        // 检查魔法护盾
        if (gameState.enemy.passive === 'manaShield' && gameState.enemy.shieldStrength > 0) {
          const damageToShield = Math.min(counterDamage, gameState.enemy.shieldStrength);
          gameState.enemy.shieldStrength -= damageToShield;
          counterDamage -= damageToShield;
          elements.battleMessage.textContent += ` 魔法护盾吸收了${damageToShield}点伤害！`;
        }
        
        // 对敌人造成剩余伤害
        if (counterDamage > 0) {
          gameState.enemy.hp = Math.max(0, gameState.enemy.hp - counterDamage);
          elements.battleMessage.textContent += ` 你反击造成了${counterDamage}点伤害！`;
        }
        
        // 检查敌人是否因反击死亡
        if (gameState.enemy.hp <= 0) {
          renderPlayerStats();
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
      }
      
      // 重新渲染
      renderPlayerStats();
      renderEnemyStats();
      
      // 检查玩家是否死亡
      if (gameState.player.hp <= 0) {
        gameState.player.hp = 0;
        renderPlayerStats();
        handleGameOver();
        return;
      }
      
      // 回合结束，检查神圣祝福
      const hasBlessing = gameState.player.skills.some(skill => skill.id === 'blessing_active');
      if (hasBlessing) {
        gameState.player.hp = Math.min(gameState.player.hp + 3, gameState.player.maxHp);
        elements.battleMessage.textContent += ` 神圣祝福恢复了3点生命值！`;
        renderPlayerStats();
      }
      
      // 抽牌补充手牌
      drawNewCards();
      
      // 切换回玩家回合
      gameState.isPlayerTurn = true;
    }
    
    // 抽新卡牌
    function drawNewCards(additional = 0) {
      const maxCards = (gameState.player.maxCards || 5) + additional;
      while (gameState.player.cards.length < maxCards) {
        // 随着难度提升，获得高级卡牌的概率增加，同时减少防御卡牌的概率
        const random = Math.random();
        let newCard;
        
        // 根据卡牌类型设置不同的抽取概率，减少防御卡牌的出现频率
        if (random < 0.05 * gameState.difficulty) {
          // 强力攻击卡牌
          newCard = getRandomCardByType(['attack'], true);
        } else if (random < 0.2 * gameState.difficulty) {
          // 特殊攻击卡牌
          newCard = getRandomCardByType(['attack', 'magic', 'special'], false);
        } else if (random < 0.25 * gameState.difficulty) {
          // 持续伤害卡牌
          newCard = getRandomCardByType(['dot'], false);
        } else if (random < 0.3 + 0.05 * gameState.difficulty) {
          // 治疗卡牌
          newCard = getRandomCardByType(['support'], false);
        } else if (random < 0.35 + 0.05 * gameState.difficulty) {
          // 防御卡牌 - 概率最低
          newCard = getRandomCardByType(['defense'], false);
        } else {
          // 基础攻击
          newCard = cardDatabase.find(card => card.id === 'basic_attack');
        }
        
        addCardToPlayer({...newCard});
      }
      
      // 检查是否有可升级的卡牌
      checkForCardUpgrades();
      
      renderCards();
    }
    
    // 根据类型获取随机卡牌
    function getRandomCardByType(types, preferUpgradable) {
      let candidates = cardDatabase.filter(card => 
        types.includes(card.type) && (!preferUpgradable || card.upgradeTo)
      );
      
      // 如果没有符合条件的，放宽条件
      if (candidates.length === 0) {
        candidates = cardDatabase.filter(card => types.includes(card.type));
      }
      
      return candidates[Math.floor(Math.random() * candidates.length)];
    }
    
    // 添加卡牌给玩家
    function addCardToPlayer(card) {
      gameState.player.cards.push(card);
      
      // 更新卡牌计数
      incrementCardCount(card.id);
      
      // 确保卡牌数量不超过上限
      const maxCards = gameState.player.maxCards || 5;
      if (gameState.player.cards.length > maxCards) {
        // 优先移除基础攻击
        const basicAttackIndex = gameState.player.cards.findIndex(c => c.id === 'basic_attack');
        if (basicAttackIndex !== -1) {
          const removedCardId = gameState.player.cards[basicAttackIndex].id;
          gameState.player.cards.splice(basicAttackIndex, 1);
          decrementCardCount(removedCardId);
        } else {
          // 否则移除最早的卡牌
          const removedCardId = gameState.player.cards[0].id;
          gameState.player.cards.shift();
          decrementCardCount(removedCardId);
        }
      }
    }
    
    // 增加卡牌计数
    function incrementCardCount(cardId) {
      gameState.player.cardCounts[cardId] = (gameState.player.cardCounts[cardId] || 0) + 1;
      
      // 每增加一张卡就检查是否可以升级
      checkForCardUpgrades();
    }
    
    // 减少卡牌计数
    function decrementCardCount(cardId) {
      if (gameState.player.cardCounts[cardId]) {
        gameState.player.cardCounts[cardId]--;
        if (gameState.player.cardCounts[cardId] === 0) {
          delete gameState.player.cardCounts[cardId];
        }
      }
    }
    
    // 检查卡牌升级 - 完善三合一功能
    function checkForCardUpgrades() {
      // 如果有模态框正在显示，则不检查
      if (!elements.cardUpgradeModal.classList.contains('hidden')) {
        return;
      }
      
      // 检查每种可升级的卡牌
      for (const [cardId, count] of Object.entries(gameState.player.cardCounts)) {
        // 使用配置的数量要求（默认3张，可通过技能改为2张）
        if (count >= gameState.cardFusion.required) {
          const card = cardDatabase.find(c => c.id === cardId);
          if (card && card.upgradeTo) {
            const upgradedCard = cardDatabase.find(c => c.id === card.upgradeTo);
            if (upgradedCard) {
              // 显示升级提示
              elements.upgradeFrom.textContent = card.name;
              elements.upgradeTo.textContent = upgradedCard.name;
              elements.cardUpgradeModal.classList.remove('hidden');
              
              // 移除相应数量的旧卡牌
              for (let i = 0; i < gameState.cardFusion.required; i++) {
                const index = gameState.player.cards.findIndex(c => c.id === cardId);
                if (index !== -1) {
                  gameState.player.cards.splice(index, 1);
                }
              }
              
              // 更新计数
              gameState.player.cardCounts[cardId] -= gameState.cardFusion.required;
              if (gameState.player.cardCounts[cardId] <= 0) {
                delete gameState.player.cardCounts[cardId];
              }
              
              // 添加升级后的卡牌
              addCardToPlayer({...upgradedCard});
              
              return; // 一次只处理一个升级
            }
          }
        }
      }
    }
    
    // 处理敌人死亡
    function handleEnemyDeath() {
      gameState.isBattleActive = false;
      elements.battleMessage.textContent = `你击败了${gameState.enemy.displayName}！获得了${gameState.enemy.expReward}点经验值！`;
      
      // 奖励经验
      gameState.player.exp += gameState.enemy.expReward;
      
      // 检查是否掉落装备
      if (Math.random() * 100 < gameState.enemy.lootChance) {
        generateLoot();
      }
      
      // 重新渲染
      renderPlayerStats();
      
      // 检查是否升级
      checkLevelUp();
      
      // 如果没有升级也没有掉落，直接生成新敌人
      if (gameState.player.exp < gameState.player.nextLevelExp && !gameState.currentLoot) {
        setTimeout(spawnNewEnemy, 2000);
      }
    }
    
    // 生成战利品
    function generateLoot() {
      // 根据难度调整装备稀有度概率
      const random = Math.random() * 100;
      let rarityThreshold;
      
      if (gameState.difficulty < 3) {
        rarityThreshold = { epic: 5, rare: 20, common: 100 };
      } else if (gameState.difficulty < 7) {
        rarityThreshold = { epic: 10, rare: 30, common: 100 };
      } else {
        rarityThreshold = { epic: 15, rare: 40, common: 100 };
      }
      
      let selectedEquipment;
      
      if (random < rarityThreshold.epic) {
        // 史诗装备
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'epic')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'epic').length)];
      } else if (random < rarityThreshold.rare) {
        // 稀有装备
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'rare')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'rare').length)];
      } else {
        // 普通装备
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'common')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'common').length)];
      }
      
      // 保存当前战利品
      gameState.currentLoot = selectedEquipment;
      
      // 显示战利品模态框
      let rarityColor = 'text-light';
      if (selectedEquipment.rarity === 'rare') rarityColor = 'text-blue-400';
      if (selectedEquipment.rarity === 'epic') rarityColor = 'text-purple-400';
      
      elements.lootContent.innerHTML = `
        <div class="bg-dark/60 rounded-lg p-3 border ${selectedEquipment.rarity === 'epic' ? 'border-purple-500 glow' : 
          selectedEquipment.rarity === 'rare' ? 'border-blue-500' : 'border-gray-500'}">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-base ${rarityColor}">${selectedEquipment.name}</h3>
            <span class="text-xs px-2 py-1 rounded-full ${selectedEquipment.rarity === 'epic' ? 'bg-purple-500/20 text-purple-400' : 
              selectedEquipment.rarity === 'rare' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-500/20 text-gray-400'}">
              ${selectedEquipment.rarity === 'epic' ? '史诗' : selectedEquipment.rarity === 'rare' ? '稀有' : '普通'}
            </span>
          </div>
          <p class="text-xs text-light/80 mb-2">${selectedEquipment.description}</p>
          <div class="text-xs">
            ${Object.entries(selectedEquipment.bonus).map(([key, value]) => {
              const keyText = key === 'attack' ? '攻击力' : 
                             key === 'defense' ? '防御力' : 
                             key === 'maxHp' ? '最大生命值' : 
                             key === 'critChance' ? '暴击率' : '';
              return `<span class="mr-3">+${value} ${keyText}</span>`;
            }).join('')}
          </div>
        </div>
      `;
      
      elements.lootModal.classList.remove('hidden');
    }
    
    // 装备战利品
    function equipLoot() {
      if (!gameState.currentLoot) return;
      
      const equipment = gameState.currentLoot;
      // 卸下当前装备（如果有）
      const oldEquipment = gameState.player.equipment[equipment.type];
      
      // 应用新装备属性
      applyEquipmentBonuses(equipment, true);
      
      // 如果有旧装备，移除其属性
      if (oldEquipment) {
        applyEquipmentBonuses(oldEquipment, false);
      }
      
      // 装备新物品
      gameState.player.equipment[equipment.type] = equipment;
      
      // 隐藏模态框
      elements.lootModal.classList.add('hidden');
      gameState.currentLoot = null;
      
      // 重新渲染
      renderEquipment();
      renderPlayerStats();
      
      // 检查是否升级，否则生成新敌人
      if (gameState.player.exp >= gameState.player.nextLevelExp) {
        checkLevelUp();
      } else {
        setTimeout(spawnNewEnemy, 1000);
      }
    }
    
    // 应用装备属性加成
    function applyEquipmentBonuses(equipment, apply) {
      const multiplier = apply ? 1 : -1;
      
      if (equipment.bonus.attack) {
        gameState.player.attack += equipment.bonus.attack * multiplier;
      }
      
      if (equipment.bonus.defense) {
        gameState.player.defense += equipment.bonus.defense * multiplier;
      }
      
      if (equipment.bonus.maxHp) {
        // 计算生命值百分比，保持比例
        const hpPercentage = gameState.player.hp / gameState.player.maxHp;
        gameState.player.maxHp += equipment.bonus.maxHp * multiplier;
        gameState.player.hp = Math.round(gameState.player.maxHp * hpPercentage);
      }
      
      if (equipment.bonus.critChance) {
        gameState.player.critChance += equipment.bonus.critChance * multiplier;
      }
    }
    
    // 添加技能给玩家
    function addSkillToPlayer(skill) {
      if (!gameState.player.skills.some(s => s.id === skill.id)) {
        gameState.player.skills.push(skill);
      }
    }
    
    // 检查升级
    function checkLevelUp() {
      while (gameState.player.exp >= gameState.player.nextLevelExp) {
        // 升级
        gameState.player.level += 1;
        gameState.player.exp -= gameState.player.nextLevelExp;
        
        // 升级后回满生命值
        gameState.player.hp = gameState.player.maxHp;
        
        // 计算下一级所需经验（递增）
        gameState.player.nextLevelExp = Math.round(gameState.player.nextLevelExp * 1.5);
        
        // 显示升级选择
        showLevelUpOptions();
        
        // 提高难度
        gameState.difficulty += 0.3;
        gameState.enemy.lootChance = Math.min(70, 30 + gameState.difficulty * 5); // 提高掉落概率
        
        // 暂停游戏直到选择技能
        gameState.isBattleActive = false;
        return; // 一次只处理一级升级，等待玩家选择技能后继续
      }
    }
    
    // 显示升级选择
    function showLevelUpOptions() {
      // 随机选择2个固定技能和1个随机生成的技能
      const shuffledSkills = [...skillDatabase].sort(() => 0.5 - Math.random());
      const fixedSkills = shuffledSkills.slice(0, 2);
      const randomSkill = generateRandomSkill();
      const selectedSkills = [...fixedSkills, randomSkill].sort(() => 0.5 - Math.random());
      
      // 更新模态框中的技能选项
      elements.skillOptions.forEach((option, index) => {
        const skill = selectedSkills[index];
        option.innerHTML = `
          <h3 class="font-bold mb-1 ${skill.isRandom ? 'text-purple-400' : ''}">${skill.name}</h3>
          <p class="text-xs text-light/80">${skill.description}</p>
        `;
        
        // 添加选择事件
        option.onclick = () => {
          // 应用技能效果
          skill.effect(gameState.player);
          
          // 添加技能到玩家技能列表（如果不是临时技能）
          if (!skill.isRandom && !gameState.player.skills.some(s => s.id === skill.id)) {
            gameState.player.skills.push({
              id: skill.id,
              name: skill.name,
              description: skill.description
            });
          } else if (skill.isRandom) {
            gameState.player.skills.push({
              id: skill.id,
              name: skill.name,
              description: skill.description
            });
          }
          
          // 隐藏模态框
          elements.levelUpModal.classList.add('hidden');
          
          // 恢复游戏
          gameState.isBattleActive = true;
          
          // 继续检查是否可以升级
          checkLevelUp();
          
          // 如果没有更多升级，生成新敌人
          if (gameState.player.exp < gameState.player.nextLevelExp) {
            setTimeout(spawnNewEnemy, 1000);
          }
          
          // 重新渲染
          renderGame();
        };
      });
      
      // 显示模态框
      elements.levelUpModal.classList.remove('hidden');
    }
    
    // 生成新敌人
    function spawnNewEnemy() {
      // 根据难度选择适合的敌人类型组
      let suitableEnemies;
      if (gameState.difficulty < 2) {
        // 难度1：只有低威胁敌人
        suitableEnemies = enemyTypes.filter(enemy => enemy.threat === '低');
      } else if (gameState.difficulty < 4) {
        // 难度2-3：低威胁和中威胁敌人
        suitableEnemies = enemyTypes.filter(enemy => enemy.threat === '低' || enemy.threat === '中');
      } else if (gameState.difficulty < 6) {
        // 难度4-5：中威胁和高威胁敌人
        suitableEnemies = enemyTypes.filter(enemy => enemy.threat === '中' || enemy.threat === '高');
      } else {
        // 难度6+：高威胁和极高威胁敌人
        suitableEnemies = enemyTypes.filter(enemy => enemy.threat === '高' || enemy.threat === '极高');
      }
      
      // 随机选择一个敌人类型
      const randomIndex = Math.floor(Math.random() * suitableEnemies.length);
      const baseEnemy = suitableEnemies[randomIndex];
      
      // 随难度增强敌人属性
      const difficultyMultiplier = 1 + (gameState.difficulty - 1) * 0.2;
      
      // 随机选择敌人名称
      const randomNameIndex = Math.floor(Math.random() * baseEnemy.names.length);
      const enemyName = baseEnemy.names[randomNameIndex];
      
      // 创建敌人对象，包含特性
      gameState.enemy = {
        name: enemyName,
        displayName: enemyName,
        hp: Math.round(baseEnemy.baseHp * difficultyMultiplier),
        maxHp: Math.round(baseEnemy.baseHp * difficultyMultiplier),
        attack: Math.round(baseEnemy.baseAttack * difficultyMultiplier),
        defense: baseEnemy.defense ? Math.round(baseEnemy.defense * difficultyMultiplier) : Math.floor(baseEnemy.baseAttack * difficultyMultiplier * 0.3),
        expReward: Math.round(baseEnemy.exp * difficultyMultiplier),
        threat: baseEnemy.threat,
        sprite: baseEnemy.sprite,
        lootChance: Math.min(70, 30 + gameState.difficulty * 5),
        poison: null,
        burn: null,
        stunned: false,
        type: baseEnemy.type,
        ability: baseEnemy.ability,
        passive: baseEnemy.passive,
        turnCount: 0, // 用于追踪敌人的回合数
        // 复制敌人特有的能力参数
        vampirismRate: baseEnemy.vampirismRate,
        isMagicDamage: baseEnemy.isMagicDamage,
        critChance: baseEnemy.critChance,
        healAmount: baseEnemy.healAmount,
        healFrequency: baseEnemy.healFrequency,
        damageReturnRate: baseEnemy.damageReturnRate,
        auraDamage: baseEnemy.auraDamage,
        shieldStrength: baseEnemy.shieldStrength ? Math.round(baseEnemy.shieldStrength * difficultyMultiplier) : null
      };
      
      // 抽新牌
      drawNewCards();
      
      // 恢复战斗状态
      gameState.isBattleActive = true;
      gameState.isPlayerTurn = true;
      
      // 添加敌人特性描述
      let enemyDescription = `新的敌人${gameState.enemy.displayName}出现了！`;
      if (gameState.enemy.ability === 'highDefense') {
        enemyDescription += ' 它拥有坚硬的护甲！';
      } else if (gameState.enemy.ability === 'vampirism') {
        enemyDescription += ' 它能从攻击中吸取生命！';
      } else if (gameState.enemy.ability === 'spellDamage') {
        enemyDescription += ' 它的攻击无视防御！';
      } else if (gameState.enemy.ability === 'highCrit') {
        enemyDescription += ' 它经常暴击！';
      } else if (gameState.enemy.ability === 'selfHeal') {
        enemyDescription += ' 它能自我治疗！';
      }
      
      if (gameState.enemy.passive) {
        if (gameState.enemy.passive === 'damageReturn') {
          enemyDescription += ' 它会反弹伤害！';
        } else if (gameState.enemy.passive === 'lifeStealAura') {
          enemyDescription += ' 它周围环绕着生命吸取光环！';
        } else if (gameState.enemy.passive === 'manaShield') {
          enemyDescription += ' 它拥有魔法护盾！';
        }
      }
      
      elements.battleMessage.textContent = enemyDescription;
      
      // 重新渲染
      renderEnemyStats();
    }
    
    // 处理游戏结束
    function handleGameOver() {
      gameState.isBattleActive = false;
      elements.finalLevel.textContent = gameState.player.level;
      elements.gameOverModal.classList.remove('hidden');
    }
    
    // 重新开始游戏
    function restartGame() {
      // 重置游戏状态
      gameState.player = {
        level: 1,
        hp: 100,
        maxHp: 100,
        exp: 0,
        nextLevelExp: 100,
        attack: 10,
        defense: 0,
        critChance: 5,
        cards: [],
        cardCounts: {},
        skills: [
          { id: 'basic_attack', name: '基础攻击', description: '造成10点伤害' }
        ],
        equipment: {
          weapon: null,
          armor: null,
          trinket: null,
          ring: null
        }
      };
      
      gameState.enemy = {
        name: '初级魔物',
        displayName: '初级魔物',
        hp: 50,
        maxHp: 50,
        attack: 8,
        defense: 2,
        threat: '低',
        expReward: 50,
        sprite: 'fa-asterisk',
        lootChance: 30,
        poison: null,
        burn: null,
        stunned: false
      };
      
      // 重置卡牌合成配置
      gameState.cardFusion = {
        required: 3,
        shownHint: false
      };
      
      gameState.isPlayerTurn = true;
      gameState.isBattleActive = true;
      gameState.difficulty = 1;
      gameState.currentLoot = null;
      
      // 隐藏模态框
      elements.gameOverModal.classList.add('hidden');
      elements.levelUpModal.classList.add('hidden');
      elements.lootModal.classList.add('hidden');
      elements.cardUpgradeModal.classList.add('hidden');
      
      // 重新初始化
      initGame();
    }
    
    // 启动游戏
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>