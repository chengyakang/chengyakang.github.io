<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>深渊卡牌 - 肉鸽卡牌游戏</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6D28D9', // 主色调：深紫色
            secondary: '#EC4899', // 辅助色：粉色
            accent: '#F59E0B', // 强调色：金色
            dark: '#1E1B4B', // 深色背景
            light: '#E0E7FF', // 浅色文本
          },
          fontFamily: {
            game: ['Segoe UI', 'Roboto', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:scale-105 hover:shadow-lg;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .bg-game {
        background-image: radial-gradient(circle at center, #2D1B69 0%, #111827 100%);
      }
      .glow {
        box-shadow: 0 0 15px rgba(110, 40, 217, 0.6);
      }
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
  </style>
</head>
<body class="bg-game font-game text-light min-h-screen flex flex-col overflow-x-hidden">
  <!-- 游戏容器 -->
  <div id="game-container" class="container mx-auto px-4 py-6 flex-grow flex flex-col">
    
    <!-- 游戏标题 -->
    <header class="text-center mb-6">
      <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-accent text-shadow mb-2">深渊卡牌</h1>
      <p class="text-light/70">无限挑战 · 每一次都是新的冒险</p>
    </header>
    
    <!-- 状态面板 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <!-- 玩家状态 -->
      <div class="bg-dark/50 rounded-xl p-4 border border-primary/30 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold flex items-center">
            <i class="fa fa-user-circle mr-2 text-secondary"></i>玩家
          </h2>
          <span class="bg-primary/20 px-2 py-1 rounded-full text-sm">等级 <span id="player-level">1</span></span>
        </div>
        
        <div class="flex gap-4">
          <div class="flex-1">
            <div class="text-sm text-light/70 mb-1">生命值</div>
            <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
              <div id="player-hp-bar" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 100%"></div>
            </div>
            <div class="text-right mt-1 text-sm">
              <span id="player-hp">100</span> / <span id="player-max-hp">100</span>
            </div>
          </div>
          
          <div class="flex-1">
            <div class="text-sm text-light/70 mb-1">经验值</div>
            <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
              <div id="player-exp-bar" class="h-full bg-accent rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="text-right mt-1 text-sm">
              <span id="player-exp">0</span> / <span id="player-next-level">100</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 敌人状态 -->
      <div class="bg-dark/50 rounded-xl p-4 border border-primary/30 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold flex items-center">
            <i class="fa fa-skull mr-2 text-red-500"></i><span id="enemy-name">初级魔物</span>
          </h2>
          <span class="bg-red-500/20 px-2 py-1 rounded-full text-sm">威胁度 <span id="enemy-threat">低</span></span>
        </div>
        
        <div>
          <div class="text-sm text-light/70 mb-1">生命值</div>
          <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
            <div id="enemy-hp-bar" class="h-full bg-red-500 rounded-full transition-all duration-500" style="width: 100%"></div>
          </div>
          <div class="text-right mt-1 text-sm">
            <span id="enemy-hp">50</span> / <span id="enemy-max-hp">50</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 装备面板 -->
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-3 flex items-center">
        <i class="fa fa-shield mr-2 text-accent"></i>装备
      </h2>
      <div id="equipment-container" class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <!-- 武器 -->
        <div class="bg-dark/40 rounded-lg p-3 border border-primary/20">
          <div class="text-sm text-light/70 mb-1">武器</div>
          <div id="weapon-slot" class="text-sm">无</div>
        </div>
        <!--  armor -->
        <div class="bg-dark/40 rounded-lg p-3 border border-primary/20">
          <div class="text-sm text-light/70 mb-1"> armor</div>
          <div id="armor-slot" class="text-sm">无</div>
        </div>
        <!-- 饰品 -->
        <div class="bg-dark/40 rounded-lg p-3 border border-primary/20">
          <div class="text-sm text-light/70 mb-1">饰品</div>
          <div id="trinket-slot" class="text-sm">无</div>
        </div>
        <!-- 戒指 -->
        <div class="bg-dark/40 rounded-lg p-3 border border-primary/20">
          <div class="text-sm text-light/70 mb-1">戒指</div>
          <div id="ring-slot" class="text-sm">无</div>
        </div>
      </div>
    </div>
    
    <!-- 战斗区域 -->
    <div class="flex-grow mb-6 relative">
      <div id="battle-area" class="bg-dark/30 rounded-xl p-4 h-full min-h-[200px] flex flex-col items-center justify-center border border-primary/20">
        <div id="battle-message" class="text-center mb-6 text-lg">准备战斗！点击下方卡牌进行攻击</div>
        
        <!-- 角色形象 -->
        <div class="flex justify-around items-center w-full max-w-md mb-6">
          <div class="text-center animate-float">
            <div class="w-20 h-20 bg-secondary/20 rounded-full flex items-center justify-center mb-2 border-2 border-secondary">
              <i class="fa fa-user text-4xl text-secondary"></i>
            </div>
            <div class="text-sm font-medium">玩家</div>
          </div>
          
          <div class="text-2xl">
            <i class="fa fa-exchange text-accent/70"></i>
          </div>
          
          <div class="text-center animate-float" style="animation-delay: 0.5s">
            <div id="enemy-sprite" class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mb-2 border-2 border-red-500">
              <i class="fa fa-asterisk text-4xl text-red-500"></i>
            </div>
            <div class="text-sm font-medium" id="enemy-display-name">初级魔物</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 卡牌区域 -->
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-3 flex items-center">
        <i class="fa fa-th-large mr-2 text-accent"></i>你的卡牌
      </h2>
      <div id="card-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        <!-- 卡牌将通过JS动态生成 -->
      </div>
    </div>
    
    <!-- 技能列表 -->
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-3 flex items-center">
        <i class="fa fa-star mr-2 text-secondary"></i>已学技能
      </h2>
      <div id="skills-container" class="flex flex-wrap gap-2">
        <div class="bg-gray-700/30 px-3 py-1 rounded-full text-sm">
          初始技能: 基础攻击
        </div>
      </div>
    </div>
  </div>
  
  <!-- 升级选择模态框 -->
  <div id="level-up-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-6 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-accent text-center mb-4">升级了！</h2>
      <p class="text-center mb-6">选择一项技能提升：</p>
      
      <div class="grid grid-cols-1 gap-4">
        <div id="skill-option-1" class="skill-option bg-primary/20 hover:bg-primary/40 p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-2">技能名称</h3>
          <p class="text-sm text-light/80">技能描述</p>
        </div>
        
        <div id="skill-option-2" class="skill-option bg-primary/20 hover:bg-primary/40 p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-2">技能名称</h3>
          <p class="text-sm text-light/80">技能描述</p>
        </div>
        
        <div id="skill-option-3" class="skill-option bg-primary/20 hover:bg-primary/40 p-4 rounded-lg cursor-pointer transition-all card-hover border border-primary/30">
          <h3 class="font-bold mb-2">技能名称</h3>
          <p class="text-sm text-light/80">技能描述</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 装备掉落模态框 -->
  <div id="loot-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-accent rounded-xl p-6 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-accent text-center mb-4">获得战利品！</h2>
      <div id="loot-content" class="mb-6">
        <!-- 战利品内容将动态生成 -->
      </div>
      <button id="equip-button" class="w-full bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover">
        装备物品
      </button>
    </div>
  </div>
  
  <!-- 游戏结束模态框 -->
  <div id="game-over-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark border-2 border-red-500 rounded-xl p-6 max-w-md w-full mx-4 text-center">
      <h2 class="text-2xl font-bold text-red-500 mb-4">游戏结束</h2>
      <p class="mb-2">你的冒险结束了</p>
      <p class="text-xl font-bold mb-6">最终等级: <span id="final-level">1</span></p>
      <button id="restart-button" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-6 rounded-full transition-all card-hover">
        重新开始
      </button>
    </div>
  </div>
  
  <script>
    // 游戏状态
    const gameState = {
      player: {
        level: 1,
        hp: 100,
        maxHp: 100,
        exp: 0,
        nextLevelExp: 100,
        attack: 10,
        defense: 0,
        critChance: 5, // 百分比
        cards: [],
        skills: [
          { id: 'basic_attack', name: '基础攻击', description: '造成10点伤害' }
        ],
        equipment: {
          weapon: null,
          armor: null,
          trinket: null,
          ring: null
        }
      },
      enemy: {
        name: '初级魔物',
        displayName: '初级魔物',
        hp: 50,
        maxHp: 50,
        attack: 8,
        threat: '低',
        expReward: 50,
        sprite: 'fa-asterisk',
        lootChance: 30 // 掉落概率百分比
      },
      isPlayerTurn: true,
      isBattleActive: true,
      difficulty: 1,
      currentLoot: null
    };
    
    // 技能数据库 - 扩展了更多技能
    const skillDatabase = [
      { 
        id: 'strong_attack', 
        name: '强化攻击', 
        description: '攻击力提升5点',
        effect: (player) => { player.attack += 5; }
      },
      { 
        id: 'toughness', 
        name: '坚韧', 
        description: '最大生命值提升20点',
        effect: (player) => { 
          player.maxHp += 20;
        }
      },
      { 
        id: 'critical_strike', 
        name: '暴击精通', 
        description: '暴击几率提升5%，暴击伤害为1.5倍',
        effect: (player) => { player.critChance += 5; }
      },
      { 
        id: 'shield', 
        name: '防御姿态', 
        description: '获得5点防御力，减少受到的伤害',
        effect: (player) => { player.defense += 5; }
      },
      { 
        id: 'vampirism', 
        name: '吸血', 
        description: '攻击时恢复5点生命值',
        effect: (player) => { 
          if (!player.skills.some(s => s.id === 'vampirism_active')) {
            player.skills.push({ 
              id: 'vampirism_active', 
              name: '吸血', 
              description: '攻击时恢复5点生命值' 
            });
          }
        }
      },
      { 
        id: 'second_wind', 
        name: '二次攻击', 
        description: '获得一张"二次打击"卡牌',
        effect: (player) => { 
          addCardToPlayer({
            id: 'second_strike',
            name: '二次打击',
            description: '对敌人造成1.2倍普通攻击伤害',
            damageMultiplier: 1.2,
            color: 'bg-accent/20',
            borderColor: 'border-accent',
            icon: 'fa-repeat'
          });
        }
      },
      { 
        id: 'fireball', 
        name: '火球术', 
        description: '获得一张"火球术"卡牌，造成15点伤害',
        effect: (player) => { 
          addCardToPlayer({
            id: 'fireball',
            name: '火球术',
            description: '造成15点伤害',
            damage: 15,
            color: 'bg-red-500/20',
            borderColor: 'border-red-500',
            icon: 'fa-fire'
          });
        }
      },
      { 
        id: 'heal', 
        name: '治愈', 
        description: '获得一张"治愈"卡牌，恢复20点生命值',
        effect: (player) => { 
          addCardToPlayer({
            id: 'heal',
            name: '治愈',
            description: '恢复20点生命值',
            heal: 20,
            color: 'bg-green-500/20',
            borderColor: 'border-green-500',
            icon: 'fa-heart'
          });
        }
      },
      { 
        id: 'whirlwind', 
        name: '旋风斩', 
        description: '获得一张"旋风斩"卡牌，对敌人造成两次50%伤害',
        effect: (player) => { 
          addCardToPlayer({
            id: 'whirlwind',
            name: '旋风斩',
            description: '对敌人造成两次50%伤害',
            damageMultiplier: 0.5,
            hitCount: 2,
            color: 'bg-blue-500/20',
            borderColor: 'border-blue-500',
            icon: 'fa-sync'
          });
        }
      },
      { 
        id: 'counter_attack', 
        name: '反击', 
        description: '受到攻击时有30%概率反击，造成50%伤害',
        effect: (player) => { 
          if (!player.skills.some(s => s.id === 'counter_attack_active')) {
            player.skills.push({ 
              id: 'counter_attack_active', 
              name: '反击', 
              description: '受到攻击时有30%概率反击' 
            });
          }
        }
      },
      { 
        id: 'blessing', 
        name: '神圣祝福', 
        description: '每回合开始时恢复3点生命值',
        effect: (player) => { 
          if (!player.skills.some(s => s.id === 'blessing_active')) {
            player.skills.push({ 
              id: 'blessing_active', 
              name: '神圣祝福', 
              description: '每回合恢复3点生命' 
            });
          }
        }
      },
      { 
        id: 'frenzy', 
        name: '狂怒', 
        description: '生命值低于30%时，攻击力提升20%',
        effect: (player) => { 
          if (!player.skills.some(s => s.id === 'frenzy_active')) {
            player.skills.push({ 
              id: 'frenzy_active', 
              name: '狂怒', 
              description: '低生命值时攻击力提升' 
            });
          }
        }
      },
      { 
        id: 'card_mastery', 
        name: '卡牌精通', 
        description: '增加一张手牌上限',
        effect: (player) => { 
          player.maxCards = (player.maxCards || 5) + 1;
        }
      },
      { 
        id: 'poison_mastery', 
        name: '毒术精通', 
        description: '获得一张"毒刺"卡牌，使敌人每回合受到持续伤害',
        effect: (player) => { 
          addCardToPlayer({
            id: 'poison_sting',
            name: '毒刺',
            description: '使敌人每回合受到5点伤害，持续3回合',
            applyPoison: 5,
            poisonDuration: 3,
            color: 'bg-green-600/20',
            borderColor: 'border-green-600',
            icon: 'fa-bug'
          });
        }
      }
    ];
    
    // 随机技能生成函数 - 可以生成全新的组合技能
    function generateRandomSkill() {
      const baseEffects = [
        { type: 'attack', min: 3, max: 7, namePart: ['精准', '强力', '致命'] },
        { type: 'defense', min: 2, max: 5, namePart: ['坚固', '钢铁', '守护'] },
        { type: 'hp', min: 10, max: 30, namePart: ['活力', '生命', '体质'] },
        { type: 'crit', min: 3, max: 8, namePart: ['暴击', '致命', '精准'] }
      ];
      
      const modifiers = [
        { name: '初级', multiplier: 1 },
        { name: '中级', multiplier: 1.5 },
        { name: '高级', multiplier: 2 }
      ];
      
      const effectTypes = [
        { name: '提升', func: (stat, value) => stat + value },
        { name: '强化', func: (stat, value) => stat + Math.round(value * 1.2) },
        { name: '精通', func: (stat, value) => stat + Math.round(value * 1.5) }
      ];
      
      // 随机选择基础效果
      const base = baseEffects[Math.floor(Math.random() * baseEffects.length)];
      const modifier = modifiers[Math.floor(Math.random() * modifiers.length)];
      const effectType = effectTypes[Math.floor(Math.random() * effectTypes.length)];
      
      // 计算数值
      const value = Math.floor((Math.random() * (base.max - base.min + 1) + base.min) * modifier.multiplier);
      
      // 生成名称和描述
      const namePart = base.namePart[Math.floor(Math.random() * base.namePart.length)];
      const skillName = `${modifier.name}${namePart}${effectType.name}`;
      
      let description, effect;
      
      switch (base.type) {
        case 'attack':
          description = `攻击力提升${value}点`;
          effect = (player) => { player.attack = effectType.func(player.attack, value); };
          break;
        case 'defense':
          description = `防御力提升${value}点`;
          effect = (player) => { player.defense = effectType.func(player.defense, value); };
          break;
        case 'hp':
          description = `最大生命值提升${value}点`;
          effect = (player) => { player.maxHp = effectType.func(player.maxHp, value); };
          break;
        case 'crit':
          description = `暴击几率提升${value}%`;
          effect = (player) => { player.critChance = effectType.func(player.critChance, value); };
          break;
      }
      
      return {
        id: `random_${Date.now()}`,
        name: skillName,
        description: description,
        effect: effect,
        isRandom: true
      };
    }
    
    // 卡牌数据库
    const cardDatabase = [
      {
        id: 'basic_attack',
        name: '基础攻击',
        description: '对敌人造成基础伤害',
        color: 'bg-secondary/20',
        borderColor: 'border-secondary',
        icon: 'fa-hand-paper-o',
        damageMultiplier: 1
      },
      {
        id: 'power_attack',
        name: '强力攻击',
        description: '对敌人造成1.5倍基础伤害',
        color: 'bg-accent/20',
        borderColor: 'border-accent',
        icon: 'fa-hand-rock-o',
        damageMultiplier: 1.5
      },
      {
        id: 'defend',
        name: '防御',
        description: '本回合减少50%受到的伤害',
        color: 'bg-blue-500/20',
        borderColor: 'border-blue-500',
        icon: 'fa-shield',
        defend: 0.5
      },
      {
        id: 'sacrifice_attack',
        name: '献祭攻击',
        description: '消耗10点生命，造成2倍伤害',
        color: 'bg-red-600/20',
        borderColor: 'border-red-600',
        icon: 'fa-balance-scale',
        damageMultiplier: 2,
        healthCost: 10
      }
    ];
    
    // 装备数据库
    const equipmentDatabase = [
      // 武器 - 增加攻击力
      {
        id: 'sword_1',
        name: '铁剑',
        type: 'weapon',
        bonus: { attack: 5 },
        rarity: 'common',
        description: '一把普通的铁剑，增加5点攻击力'
      },
      {
        id: 'axe_1',
        name: '战斧',
        type: 'weapon',
        bonus: { attack: 7, critChance: 2 },
        rarity: 'common',
        description: '沉重的战斧，增加7点攻击力和2%暴击率'
      },
      {
        id: 'dagger_1',
        name: '匕首',
        type: 'weapon',
        bonus: { attack: 3, critChance: 5 },
        rarity: 'common',
        description: '锋利的匕首，增加3点攻击力和5%暴击率'
      },
      {
        id: 'sword_2',
        name: '钢剑',
        type: 'weapon',
        bonus: { attack: 10 },
        rarity: 'rare',
        description: '精良的钢剑，增加10点攻击力'
      },
      {
        id: 'sword_3',
        name: '圣剑',
        type: 'weapon',
        bonus: { attack: 15, critChance: 5 },
        rarity: 'epic',
        description: '神圣的剑，增加15点攻击力和5%暴击率'
      },
      
      //  armor - 增加防御力和生命值
      {
        id: 'cloth_1',
        name: '布衣',
        type: 'armor',
        bonus: { defense: 2, maxHp: 10 },
        rarity: 'common',
        description: '简单的布衣，增加2点防御力和10点生命值'
      },
      {
        id: 'leather_1',
        name: '皮甲',
        type: 'armor',
        bonus: { defense: 4, maxHp: 20 },
        rarity: 'common',
        description: '坚韧的皮甲，增加4点防御力和20点生命值'
      },
      {
        id: 'iron_1',
        name: '铁甲',
        type: 'armor',
        bonus: { defense: 7, maxHp: 30 },
        rarity: 'rare',
        description: '坚固的铁甲，增加7点防御力和30点生命值'
      },
      {
        id: 'steel_1',
        name: '钢甲',
        type: 'armor',
        bonus: { defense: 10, maxHp: 50 },
        rarity: 'epic',
        description: '精良的钢甲，增加10点防御力和50点生命值'
      },
      
      // 饰品 - 增加各种属性
      {
        id: 'amulet_1',
        name: '铜项链',
        type: 'trinket',
        bonus: { maxHp: 15, critChance: 2 },
        rarity: 'common',
        description: '普通的铜项链，增加15点生命值和2%暴击率'
      },
      {
        id: 'amulet_2',
        name: '银项链',
        type: 'trinket',
        bonus: { maxHp: 30, critChance: 4 },
        rarity: 'rare',
        description: '精致的银项链，增加30点生命值和4%暴击率'
      },
      {
        id: 'ring_1',
        name: '铁戒指',
        type: 'ring',
        bonus: { attack: 2, defense: 2 },
        rarity: 'common',
        description: '普通的铁戒指，增加2点攻击力和2点防御力'
      },
      {
        id: 'ring_2',
        name: '银戒指',
        type: 'ring',
        bonus: { attack: 4, defense: 4, critChance: 2 },
        rarity: 'rare',
        description: '精致的银戒指，增加4点攻击力、4点防御力和2%暴击率'
      },
      {
        id: 'ring_3',
        name: '钻石戒指',
        type: 'ring',
        bonus: { attack: 7, defense: 7, critChance: 5 },
        rarity: 'epic',
        description: '华丽的钻石戒指，增加7点攻击力、7点防御力和5%暴击率'
      }
    ];
    
    // 敌人名称和类型数据库
    const enemyNameDatabase = {
      low: [
        '疯狂的老鼠', '堕落的学徒', '变异的甲虫', '愤怒的地精', '小型史莱姆',
        '哭泣的幽灵', '暴躁的野兔', '腐烂的骷髅', '醉酒的海盗', '迷路的恶魔'
      ],
      medium: [
        '暗影猎手', '深渊祭司', '钢铁守卫', '火焰法师', '冰霜巨人',
        '毒液蜘蛛', '亡灵战士', '风暴元素', '血月狼人', '诅咒骑士'
      ],
      high: [
        '毁灭使者', '末日守卫', '虚空行者', '死亡骑士', '地狱火魔',
        '暗影领主', '冰霜女王', '瘟疫使者', '混沌巫师', '灵魂收割者'
      ],
      extreme: [
        '深渊之主', '宇宙吞噬者', '末日审判者', '万魂之王', '炼狱焚魔',
        '暗影本源', '混沌之神', '永恒巫妖', '毁灭巨龙', '虚空造物'
      ]
    };
    
    // 敌人类型数据库
    const enemyTypes = [
      { baseHp: 50, baseAttack: 8, exp: 50, threat: '低', sprite: 'fa-asterisk', names: enemyNameDatabase.low },
      { baseHp: 80, baseAttack: 12, exp: 80, threat: '中', sprite: 'fa-moon-o', names: enemyNameDatabase.medium },
      { baseHp: 120, baseAttack: 16, exp: 120, threat: '高', sprite: 'fa-shield', names: enemyNameDatabase.high },
      { baseHp: 200, baseAttack: 25, exp: 200, threat: '极高', sprite: 'fa-fire', names: enemyNameDatabase.extreme }
    ];
    
    // DOM元素
    const elements = {
      playerLevel: document.getElementById('player-level'),
      playerHp: document.getElementById('player-hp'),
      playerMaxHp: document.getElementById('player-max-hp'),
      playerHpBar: document.getElementById('player-hp-bar'),
      playerExp: document.getElementById('player-exp'),
      playerNextLevel: document.getElementById('player-next-level'),
      playerExpBar: document.getElementById('player-exp-bar'),
      
      enemyName: document.getElementById('enemy-name'),
      enemyDisplayName: document.getElementById('enemy-display-name'),
      enemyHp: document.getElementById('enemy-hp'),
      enemyMaxHp: document.getElementById('enemy-max-hp'),
      enemyHpBar: document.getElementById('enemy-hp-bar'),
      enemyThreat: document.getElementById('enemy-threat'),
      enemySprite: document.getElementById('enemy-sprite'),
      
      battleMessage: document.getElementById('battle-message'),
      cardContainer: document.getElementById('card-container'),
      skillsContainer: document.getElementById('skills-container'),
      
      // 装备槽
      weaponSlot: document.getElementById('weapon-slot'),
      armorSlot: document.getElementById('armor-slot'),
      trinketSlot: document.getElementById('trinket-slot'),
      ringSlot: document.getElementById('ring-slot'),
      
      levelUpModal: document.getElementById('level-up-modal'),
      skillOptions: [
        document.getElementById('skill-option-1'),
        document.getElementById('skill-option-2'),
        document.getElementById('skill-option-3')
      ],
      
      lootModal: document.getElementById('loot-modal'),
      lootContent: document.getElementById('loot-content'),
      equipButton: document.getElementById('equip-button'),
      
      gameOverModal: document.getElementById('game-over-modal'),
      finalLevel: document.getElementById('final-level'),
      restartButton: document.getElementById('restart-button')
    };
    
    // 初始化游戏
    function initGame() {
      // 初始化玩家卡牌
      gameState.player.cards = [
        cardDatabase.find(card => card.id === 'basic_attack'),
        cardDatabase.find(card => card.id === 'basic_attack'),
        cardDatabase.find(card => card.id === 'defend')
      ];
      
      // 初始化装备为空
      gameState.player.equipment = {
        weapon: null,
        armor: null,
        trinket: null,
        ring: null
      };
      
      // 渲染游戏状态
      renderGame();
      
      // 添加事件监听
      elements.restartButton.addEventListener('click', restartGame);
      elements.equipButton.addEventListener('click', equipLoot);
    }
    
    // 渲染游戏
    function renderGame() {
      renderPlayerStats();
      renderEnemyStats();
      renderCards();
      renderSkills();
      renderEquipment();
    }
    
    // 渲染玩家状态
    function renderPlayerStats() {
      elements.playerLevel.textContent = gameState.player.level;
      elements.playerHp.textContent = gameState.player.hp;
      elements.playerMaxHp.textContent = gameState.player.maxHp;
      elements.playerHpBar.style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
      
      elements.playerExp.textContent = gameState.player.exp;
      elements.playerNextLevel.textContent = gameState.player.nextLevelExp;
      elements.playerExpBar.style.width = `${(gameState.player.exp / gameState.player.nextLevelExp) * 100}%`;
    }
    
    // 渲染敌人状态
    function renderEnemyStats() {
      elements.enemyName.textContent = gameState.enemy.name;
      elements.enemyDisplayName.textContent = gameState.enemy.displayName;
      elements.enemyHp.textContent = gameState.enemy.hp;
      elements.enemyMaxHp.textContent = gameState.enemy.maxHp;
      elements.enemyHpBar.style.width = `${(gameState.enemy.hp / gameState.enemy.maxHp) * 100}%`;
      elements.enemyThreat.textContent = gameState.enemy.threat;
      
      // 更新敌人图标
      elements.enemySprite.innerHTML = `<i class="fa ${gameState.enemy.sprite} text-4xl text-red-500"></i>`;
    }
    
    // 渲染卡牌
    function renderCards() {
      elements.cardContainer.innerHTML = '';
      
      gameState.player.cards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        cardElement.className = `${card.color} ${card.borderColor} border rounded-xl p-4 card-hover cursor-pointer`;
        cardElement.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h3 class="font-bold text-lg">${card.name}</h3>
            <i class="fa ${card.icon} text-xl"></i>
          </div>
          <p class="text-sm text-light/80">${card.description}</p>
        `;
        
        cardElement.addEventListener('click', () => useCard(index));
        elements.cardContainer.appendChild(cardElement);
      });
    }
    
    // 渲染技能
    function renderSkills() {
      elements.skillsContainer.innerHTML = '';
      
      gameState.player.skills.forEach(skill => {
        const skillElement = document.createElement('div');
        skillElement.className = 'bg-primary/20 px-3 py-1 rounded-full text-sm';
        skillElement.textContent = `${skill.name}: ${skill.description}`;
        elements.skillsContainer.appendChild(skillElement);
      });
    }
    
    // 渲染装备
    function renderEquipment() {
      const equipment = gameState.player.equipment;
      
      elements.weaponSlot.textContent = equipment.weapon ? 
        `${equipment.weapon.name} (攻击+${equipment.weapon.bonus.attack || 0})` : '无';
        
      elements.armorSlot.textContent = equipment.armor ? 
        `${equipment.armor.name} (防御+${equipment.armor.bonus.defense || 0})` : '无';
        
      elements.trinketSlot.textContent = equipment.trinket ? 
        `${equipment.trinket.name} (生命+${equipment.trinket.bonus.maxHp || 0})` : '无';
        
      elements.ringSlot.textContent = equipment.ring ? 
        `${equipment.ring.name} (攻击+${equipment.ring.bonus.attack || 0}, 防御+${equipment.ring.bonus.defense || 0})` : '无';
    }
    
    // 使用卡牌
    function useCard(index) {
      if (!gameState.isPlayerTurn || !gameState.isBattleActive) return;
      
      const card = gameState.player.cards[index];
      let message = '';
      let hasUsedCard = false;
      
      // 处理卡牌效果
      if (card.damage || card.damageMultiplier) {
        hasUsedCard = true;
        // 计算基础攻击力（包括装备加成）
        let baseAttack = gameState.player.attack;
        if (gameState.player.equipment.weapon && gameState.player.equipment.weapon.bonus.attack) {
          baseAttack += gameState.player.equipment.weapon.bonus.attack;
        }
        if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.attack) {
          baseAttack += gameState.player.equipment.ring.bonus.attack;
        }
        
        // 狂怒效果
        const hasFrenzy = gameState.player.skills.some(skill => skill.id === 'frenzy_active');
        if (hasFrenzy && gameState.player.hp / gameState.player.maxHp < 0.3) {
          baseAttack = Math.round(baseAttack * 1.2);
          message += '狂怒激活！攻击力提升！';
        }
        
        // 计算伤害
        let damage = card.damage || Math.round(baseAttack * (card.damageMultiplier || 1));
        
        // 检查暴击（包括装备加成）
        let critChance = gameState.player.critChance;
        if (gameState.player.equipment.weapon && gameState.player.equipment.weapon.bonus.critChance) {
          critChance += gameState.player.equipment.weapon.bonus.critChance;
        }
        if (gameState.player.equipment.trinket && gameState.player.equipment.trinket.bonus.critChance) {
          critChance += gameState.player.equipment.trinket.bonus.critChance;
        }
        if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.critChance) {
          critChance += gameState.player.equipment.ring.bonus.critChance;
        }
        
        const isCrit = Math.random() * 100 < critChance;
        if (isCrit) {
          damage = Math.round(damage * 1.5);
          message += `你使用了${card.name}，造成了${damage}点暴击伤害！`;
        } else {
          message += `你使用了${card.name}，造成了${damage}点伤害！`;
        }
        
        // 处理多段攻击
        const hitCount = card.hitCount || 1;
        if (hitCount > 1) {
          damage *= hitCount;
          message = message.replace(`造成了${damage/hitCount}`, `造成了${hitCount}次${damage/hitCount}，总计${damage}`);
        }
        
        // 应用伤害
        gameState.enemy.hp -= damage;
        if (gameState.enemy.hp < 0) gameState.enemy.hp = 0;
        
        // 检查吸血效果
        const hasVampirism = gameState.player.skills.some(skill => skill.id === 'vampirism_active');
        if (hasVampirism) {
          const healAmount = Math.min(5 * hitCount, gameState.player.maxHp - gameState.player.hp);
          gameState.player.hp += healAmount;
          message += ` 你吸取了${healAmount}点生命值！`;
        }
        
        // 处理献祭攻击的生命消耗
        if (card.healthCost) {
          gameState.player.hp = Math.max(1, gameState.player.hp - card.healthCost);
          message += ` 你消耗了${card.healthCost}点生命值！`;
        }
      } else if (card.heal) {
        hasUsedCard = true;
        // 治疗效果
        const actualHeal = Math.min(card.heal, gameState.player.maxHp - gameState.player.hp);
        gameState.player.hp += actualHeal;
        message = `你使用了${card.name}，恢复了${actualHeal}点生命值！`;
      } else if (card.defend) {
        hasUsedCard = true;
        // 防御效果
        gameState.player.tempDefense = (gameState.player.defense * card.defend) || card.defend;
        message = `你使用了${card.name}，本回合减少受到的伤害！`;
      } else if (card.applyPoison) {
        hasUsedCard = true;
        // 毒效果
        gameState.enemy.poison = {
          damage: card.applyPoison,
          duration: card.poisonDuration
        };
        message = `你使用了${card.name}，使敌人中毒，每回合受到${card.applyPoison}点伤害，持续${card.poisonDuration}回合！`;
      }
      
      if (hasUsedCard) {
        // 移除已使用的卡牌
        gameState.player.cards.splice(index, 1);
        
        // 更新战斗信息
        elements.battleMessage.textContent = message;
        
        // 重新渲染
        renderPlayerStats();
        renderEnemyStats();
        renderCards();
        
        // 检查敌人是否死亡
        if (gameState.enemy.hp <= 0) {
          handleEnemyDeath();
          return;
        }
        
        // 切换到敌人回合
        gameState.isPlayerTurn = false;
        setTimeout(enemyTurn, 1500);
      }
    }
    
    // 敌人回合
    function enemyTurn() {
      if (gameState.isPlayerTurn || !gameState.isBattleActive) return;
      
      // 处理中毒效果
      if (gameState.enemy.poison && gameState.enemy.poison.duration > 0) {
        gameState.enemy.hp -= gameState.enemy.poison.damage;
        gameState.enemy.poison.duration -= 1;
        elements.battleMessage.textContent = 
          `${gameState.enemy.displayName}受到${gameState.enemy.poison.damage}点毒素伤害！`;
        
        if (gameState.enemy.hp <= 0) {
          gameState.enemy.hp = 0;
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
        
        renderEnemyStats();
        setTimeout(() => {
          continueEnemyTurn();
        }, 1000);
      } else {
        continueEnemyTurn();
      }
    }
    
    // 继续敌人回合（处理攻击）
    function continueEnemyTurn() {
      // 计算玩家总防御（包括装备）
      let totalDefense = gameState.player.defense;
      if (gameState.player.equipment.armor && gameState.player.equipment.armor.bonus.defense) {
        totalDefense += gameState.player.equipment.armor.bonus.defense;
      }
      if (gameState.player.equipment.ring && gameState.player.equipment.ring.bonus.defense) {
        totalDefense += gameState.player.equipment.ring.bonus.defense;
      }
      
      // 计算伤害（考虑玩家防御）
      let damage = gameState.enemy.attack - totalDefense;
      
      // 应用临时防御
      if (gameState.player.tempDefense) {
        damage = Math.round(damage * gameState.player.tempDefense);
        gameState.player.tempDefense = 0; // 重置临时防御
      }
      
      // 确保伤害不为负
      damage = Math.max(1, damage);
      
      // 应用伤害
      gameState.player.hp -= damage;
      
      // 更新战斗信息
      elements.battleMessage.textContent = `${gameState.enemy.displayName}对你造成了${damage}点伤害！`;
      
      // 检查反击效果
      const hasCounterAttack = gameState.player.skills.some(skill => skill.id === 'counter_attack_active');
      if (hasCounterAttack && Math.random() * 100 < 30) {
        const counterDamage = Math.round(gameState.player.attack * 0.5);
        gameState.enemy.hp = Math.max(0, gameState.enemy.hp - counterDamage);
        elements.battleMessage.textContent += ` 你反击造成了${counterDamage}点伤害！`;
        
        // 检查敌人是否因反击死亡
        if (gameState.enemy.hp <= 0) {
          renderPlayerStats();
          renderEnemyStats();
          handleEnemyDeath();
          return;
        }
      }
      
      // 重新渲染
      renderPlayerStats();
      renderEnemyStats();
      
      // 检查玩家是否死亡
      if (gameState.player.hp <= 0) {
        gameState.player.hp = 0;
        renderPlayerStats();
        handleGameOver();
        return;
      }
      
      // 回合结束，检查神圣祝福
      const hasBlessing = gameState.player.skills.some(skill => skill.id === 'blessing_active');
      if (hasBlessing) {
        gameState.player.hp = Math.min(gameState.player.hp + 3, gameState.player.maxHp);
        elements.battleMessage.textContent += ` 神圣祝福恢复了3点生命值！`;
        renderPlayerStats();
      }
      
      // 抽牌补充手牌
      drawNewCards();
      
      // 切换回玩家回合
      gameState.isPlayerTurn = true;
    }
    
    // 抽新卡牌
    function drawNewCards() {
      const maxCards = gameState.player.maxCards || 5;
      while (gameState.player.cards.length < maxCards) {
        // 随着难度提升，获得高级卡牌的概率增加
        const random = Math.random();
        let newCard;
        
        if (random < 0.05 * gameState.difficulty) {
          // 强力卡牌
          newCard = cardDatabase.find(card => card.id === 'power_attack');
        } else if (random < 0.1 * gameState.difficulty) {
          // 献祭攻击
          newCard = cardDatabase.find(card => card.id === 'sacrifice_attack');
        } else if (random < 0.2 + 0.1 * gameState.difficulty) {
          // 防御卡牌
          newCard = cardDatabase.find(card => card.id === 'defend');
        } else {
          // 基础攻击
          newCard = cardDatabase.find(card => card.id === 'basic_attack');
        }
        
        gameState.player.cards.push(newCard);
      }
      renderCards();
    }
    
    // 处理敌人死亡
    function handleEnemyDeath() {
      gameState.isBattleActive = false;
      elements.battleMessage.textContent = `你击败了${gameState.enemy.displayName}！获得了${gameState.enemy.expReward}点经验值！`;
      
      // 奖励经验
      gameState.player.exp += gameState.enemy.expReward;
      
      // 检查是否掉落装备
      if (Math.random() * 100 < gameState.enemy.lootChance) {
        generateLoot();
      }
      
      // 重新渲染
      renderPlayerStats();
      
      // 检查是否升级
      checkLevelUp();
      
      // 如果没有升级也没有掉落，直接生成新敌人
      if (gameState.player.exp < gameState.player.nextLevelExp && !gameState.currentLoot) {
        setTimeout(spawnNewEnemy, 2000);
      }
    }
    
    // 生成战利品
    function generateLoot() {
      // 根据难度调整装备稀有度概率
      const random = Math.random() * 100;
      let rarityThreshold;
      
      if (gameState.difficulty < 3) {
        rarityThreshold = { epic: 5, rare: 20, common: 100 };
      } else if (gameState.difficulty < 7) {
        rarityThreshold = { epic: 10, rare: 30, common: 100 };
      } else {
        rarityThreshold = { epic: 15, rare: 40, common: 100 };
      }
      
      let selectedEquipment;
      
      if (random < rarityThreshold.epic) {
        // 史诗装备
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'epic')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'epic').length)];
      } else if (random < rarityThreshold.rare) {
        // 稀有装备
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'rare')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'rare').length)];
      } else {
        // 普通装备
        selectedEquipment = equipmentDatabase.filter(e => e.rarity === 'common')
          [Math.floor(Math.random() * equipmentDatabase.filter(e => e.rarity === 'common').length)];
      }
      
      // 保存当前战利品
      gameState.currentLoot = selectedEquipment;
      
      // 显示战利品模态框
      let rarityColor = 'text-light';
      if (selectedEquipment.rarity === 'rare') rarityColor = 'text-blue-400';
      if (selectedEquipment.rarity === 'epic') rarityColor = 'text-purple-400';
      
      elements.lootContent.innerHTML = `
        <div class="bg-dark/60 rounded-lg p-4 border ${selectedEquipment.rarity === 'epic' ? 'border-purple-500 glow' : 
          selectedEquipment.rarity === 'rare' ? 'border-blue-500' : 'border-gray-500'}">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-lg ${rarityColor}">${selectedEquipment.name}</h3>
            <span class="text-xs px-2 py-1 rounded-full ${selectedEquipment.rarity === 'epic' ? 'bg-purple-500/20 text-purple-400' : 
              selectedEquipment.rarity === 'rare' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-500/20 text-gray-400'}">
              ${selectedEquipment.rarity === 'epic' ? '史诗' : selectedEquipment.rarity === 'rare' ? '稀有' : '普通'}
            </span>
          </div>
          <p class="text-sm text-light/80 mb-2">${selectedEquipment.description}</p>
          <div class="text-sm">
            ${Object.entries(selectedEquipment.bonus).map(([key, value]) => {
              const keyText = key === 'attack' ? '攻击力' : 
                             key === 'defense' ? '防御力' : 
                             key === 'maxHp' ? '最大生命值' : 
                             key === 'critChance' ? '暴击率' : '';
              return `<span class="mr-3">+${value} ${keyText}</span>`;
            }).join('')}
          </div>
        </div>
      `;
      
      elements.lootModal.classList.remove('hidden');
    }
    
    // 装备战利品
    function equipLoot() {
      if (!gameState.currentLoot) return;
      
      const equipment = gameState.currentLoot;
      // 卸下当前装备（如果有）
      const oldEquipment = gameState.player.equipment[equipment.type];
      
      // 应用新装备属性
      applyEquipmentBonuses(equipment, true);
      
      // 如果有旧装备，移除其属性
      if (oldEquipment) {
        applyEquipmentBonuses(oldEquipment, false);
      }
      
      // 装备新物品
      gameState.player.equipment[equipment.type] = equipment;
      
      // 隐藏模态框
      elements.lootModal.classList.add('hidden');
      gameState.currentLoot = null;
      
      // 重新渲染
      renderEquipment();
      renderPlayerStats();
      
      // 检查是否升级，否则生成新敌人
      if (gameState.player.exp >= gameState.player.nextLevelExp) {
        checkLevelUp();
      } else {
        setTimeout(spawnNewEnemy, 1000);
      }
    }
    
    // 应用装备属性加成
    function applyEquipmentBonuses(equipment, apply) {
      const multiplier = apply ? 1 : -1;
      
      if (equipment.bonus.attack) {
        gameState.player.attack += equipment.bonus.attack * multiplier;
      }
      
      if (equipment.bonus.defense) {
        gameState.player.defense += equipment.bonus.defense * multiplier;
      }
      
      if (equipment.bonus.maxHp) {
        // 计算生命值百分比，保持比例
        const hpPercentage = gameState.player.hp / gameState.player.maxHp;
        gameState.player.maxHp += equipment.bonus.maxHp * multiplier;
        gameState.player.hp = Math.round(gameState.player.maxHp * hpPercentage);
      }
      
      if (equipment.bonus.critChance) {
        gameState.player.critChance += equipment.bonus.critChance * multiplier;
      }
    }
    
    // 检查升级
    function checkLevelUp() {
      while (gameState.player.exp >= gameState.player.nextLevelExp) {
        // 升级
        gameState.player.level += 1;
        gameState.player.exp -= gameState.player.nextLevelExp;
        
        // 升级后回满生命值
        gameState.player.hp = gameState.player.maxHp;
        
        // 计算下一级所需经验（递增）
        gameState.player.nextLevelExp = Math.round(gameState.player.nextLevelExp * 1.5);
        
        // 显示升级选择
        showLevelUpOptions();
        
        // 提高难度
        gameState.difficulty += 0.3;
        gameState.enemy.lootChance = Math.min(70, 30 + gameState.difficulty * 5); // 提高掉落概率
        
        // 暂停游戏直到选择技能
        gameState.isBattleActive = false;
        return; // 一次只处理一级升级，等待玩家选择技能后继续
      }
    }
    
    // 显示升级选择
    function showLevelUpOptions() {
      // 随机选择2个固定技能和1个随机生成的技能
      const shuffledSkills = [...skillDatabase].sort(() => 0.5 - Math.random());
      const fixedSkills = shuffledSkills.slice(0, 2);
      const randomSkill = generateRandomSkill();
      const selectedSkills = [...fixedSkills, randomSkill].sort(() => 0.5 - Math.random());
      
      // 更新模态框中的技能选项
      elements.skillOptions.forEach((option, index) => {
        const skill = selectedSkills[index];
        option.innerHTML = `
          <h3 class="font-bold mb-2 ${skill.isRandom ? 'text-purple-400' : ''}">${skill.name}</h3>
          <p class="text-sm text-light/80">${skill.description}</p>
        `;
        
        // 添加选择事件
        option.onclick = () => {
          // 应用技能效果
          skill.effect(gameState.player);
          
          // 添加技能到玩家技能列表（如果不是临时技能）
          if (!skill.isRandom && !gameState.player.skills.some(s => s.id === skill.id)) {
            gameState.player.skills.push({
              id: skill.id,
              name: skill.name,
              description: skill.description
            });
          } else if (skill.isRandom) {
            gameState.player.skills.push({
              id: skill.id,
              name: skill.name,
              description: skill.description
            });
          }
          
          // 隐藏模态框
          elements.levelUpModal.classList.add('hidden');
          
          // 恢复游戏
          gameState.isBattleActive = true;
          
          // 继续检查是否可以升级
          checkLevelUp();
          
          // 如果没有更多升级，生成新敌人
          if (gameState.player.exp < gameState.player.nextLevelExp) {
            setTimeout(spawnNewEnemy, 1000);
          }
          
          // 重新渲染
          renderGame();
        };
      });
      
      // 显示模态框
      elements.levelUpModal.classList.remove('hidden');
    }
    
    // 生成新敌人
    function spawnNewEnemy() {
      // 根据难度生成敌人
      const enemyIndex = Math.min(Math.floor(gameState.difficulty / 2), enemyTypes.length - 1);
      const baseEnemy = enemyTypes[enemyIndex];
      
      // 随难度增强敌人属性
      const difficultyMultiplier = 1 + (gameState.difficulty - 1) * 0.2;
      
      // 随机选择敌人名称
      const randomNameIndex = Math.floor(Math.random() * baseEnemy.names.length);
      const enemyName = baseEnemy.names[randomNameIndex];
      
      gameState.enemy = {
        name: enemyName,
        displayName: enemyName,
        hp: Math.round(baseEnemy.baseHp * difficultyMultiplier),
        maxHp: Math.round(baseEnemy.baseHp * difficultyMultiplier),
        attack: Math.round(baseEnemy.baseAttack * difficultyMultiplier),
        expReward: Math.round(baseEnemy.exp * difficultyMultiplier),
        threat: baseEnemy.threat,
        sprite: baseEnemy.sprite,
        lootChance: Math.min(70, 30 + gameState.difficulty * 5),
        poison: null
      };
      
      // 抽新牌
      drawNewCards();
      
      // 恢复战斗状态
      gameState.isBattleActive = true;
      gameState.isPlayerTurn = true;
      elements.battleMessage.textContent = `新的敌人${gameState.enemy.displayName}出现了！`;
      
      // 重新渲染
      renderEnemyStats();
    }
    
    // 添加卡牌给玩家
    function addCardToPlayer(card) {
      gameState.player.cards.push(card);
      
      // 确保卡牌数量不超过上限
      const maxCards = gameState.player.maxCards || 5;
      if (gameState.player.cards.length > maxCards) {
        // 优先移除基础攻击
        const basicAttackIndex = gameState.player.cards.findIndex(c => c.id === 'basic_attack');
        if (basicAttackIndex !== -1) {
          gameState.player.cards.splice(basicAttackIndex, 1);
        } else {
          gameState.player.cards.shift();
        }
      }
    }
    
    // 处理游戏结束
    function handleGameOver() {
      gameState.isBattleActive = false;
      elements.finalLevel.textContent = gameState.player.level;
      elements.gameOverModal.classList.remove('hidden');
    }
    
    // 重新开始游戏
    function restartGame() {
      // 重置游戏状态
      gameState.player = {
        level: 1,
        hp: 100,
        maxHp: 100,
        exp: 0,
        nextLevelExp: 100,
        attack: 10,
        defense: 0,
        critChance: 5,
        cards: [],
        skills: [
          { id: 'basic_attack', name: '基础攻击', description: '造成10点伤害' }
        ],
        equipment: {
          weapon: null,
          armor: null,
          trinket: null,
          ring: null
        }
      };
      
      gameState.enemy = {
        name: '初级魔物',
        displayName: '初级魔物',
        hp: 50,
        maxHp: 50,
        attack: 8,
        threat: '低',
        expReward: 50,
        sprite: 'fa-asterisk',
        lootChance: 30
      };
      
      gameState.isPlayerTurn = true;
      gameState.isBattleActive = true;
      gameState.difficulty = 1;
      gameState.currentLoot = null;
      
      // 隐藏模态框
      elements.gameOverModal.classList.add('hidden');
      elements.levelUpModal.classList.add('hidden');
      elements.lootModal.classList.add('hidden');
      
      // 重新初始化
      initGame();
    }
    
    // 启动游戏
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>